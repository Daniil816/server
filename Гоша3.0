import os
import pickle
import vk_api
import time
import gspread
import json
from vk_api.longpoll import VkLongPoll, VkEventType
from google.auth.transport.requests import Request
from google_auth_oauthlib.flow import InstalledAppFlow

# --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---
VK_TOKEN = 'vk1.a.hnuRWe9zj3RAiXc-2Jhi3ix1wDAYPeA3vv5EuURXKIptRpDR8G948Q891ndVNMuOnz69LxbvAbXQVACkIlLuhQidngypMtSGg4Sv6keay8XH-0WZOs9_L9m4LmXcV3F8pg3dyOTiujoSmzTqi9j2g5j_txPUcKILy_kbavL40GLZ_qLhzbuQjBI_PokDT1cExggdvo2CSgUOsdZBkFayLQ'
SPREADSHEET_NAME = '29 | –†–∞–±–æ—Ç–∞'
RIGHTS_FILE = 'user_rights.json'
SUPER_ADMINS = [807253464, 679050151]
SCOPES = ['https://www.googleapis.com/auth/spreadsheets']
user_rights = {}

def load_user_rights():
    global user_rights
    if os.path.exists(RIGHTS_FILE):
        try:
            with open(RIGHTS_FILE, 'r', encoding='utf-8') as f:
                user_rights = json.load(f)
            user_rights = {int(k): v for k, v in user_rights.items()}
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∞–≤: {e}")
            user_rights = {}
    
    for super_admin_id in SUPER_ADMINS:
        if super_admin_id not in user_rights:
            user_rights[super_admin_id] = {
                'role': 'super_admin',
                'permissions': ['add_admin', 'add_editor', 'edit_table', 'grant_access', 'revoke_super'],
                'is_super': True,
                'added_by': 'system',
                'added_date': time.strftime("%d.%m.%Y %H:%M:%S")
            }
    save_user_rights()

def save_user_rights():
    try:
        with open(RIGHTS_FILE, 'w', encoding='utf-8') as f:
            json.dump(user_rights, f, ensure_ascii=False, indent=2)
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–∞–≤: {e}")

def has_permission(user_id, permission):
    if user_id in user_rights:
        permissions = user_rights[user_id].get('permissions', [])
        return permission in permissions
    return False

def get_google_client():
    creds = None
    if os.path.exists('token.pickle'):
        with open('token.pickle', 'rb') as token:
            creds = pickle.load(token)
    if not creds or not creds.valid:
        if creds and creds.expired and creds.refresh_token:
            creds.refresh(Request())
        else:
            flow = InstalledAppFlow.from_client_secrets_file('client_secret.json', SCOPES)
            creds = flow.run_local_server(port=8080)
        with open('token.pickle', 'wb') as token:
            pickle.dump(creds, token)
    return gspread.authorize(creds)

def set_cell_value(row_data, header_map, header_name, value):
    """–ë–µ–∑–æ–ø–∞—Å–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ, –Ω–µ –≤—ã—Ö–æ–¥—è –∑–∞ –ø—Ä–µ–¥–µ–ª—ã —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å—Ç–æ–ª–±—Ü–æ–≤"""
    if header_name in header_map:
        col_index = header_map[header_name]
        # –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ–±—ã –∏–Ω–¥–µ–∫—Å –Ω–µ –ø—Ä–µ–≤—ã—à–∞–ª —Ä–∞–∑–º–µ—Ä row_data (–∫–æ–ª-–≤–æ —Å—Ç–æ–ª–±—Ü–æ–≤ –≤ —Ç–∞–±–ª–∏—Ü–µ)
        if col_index < len(row_data):
            row_data[col_index] = value
            return True
    return False

def add_admin_to_sheet(sheet, headers, header_map, nickname, date_val, vk_link, forum_link):
    try:
        # –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä–æ–∫—É, –¥–ª–∏–Ω–∞ –∫–æ—Ç–æ—Ä–æ–π —Å—Ç—Ä–æ–≥–æ —Ä–∞–≤–Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ (–Ω–∏–∫–∞–∫–∏—Ö –Ω–æ–≤—ã—Ö —Å—Ç–æ–ª–±—Ü–æ–≤)
        row_data = [''] * len(headers)
        
        # –§–æ—Ä–º—É–ª—ã
        formula_m = '=–ï–°–õ–ò(INDIRECT("B"&ROW())=1;"–ñ–¥—ë—Ç 2 —É—Ä–æ–≤–µ–Ω—å";–ï–°–õ–ò(INDIRECT("B"&ROW())=2;"–ñ–¥—ë—Ç 3 —É—Ä–æ–≤–µ–Ω—å";–ï–°–õ–ò(INDIRECT("B"&ROW())=3;"–ñ–¥—ë—Ç 4 —É—Ä–æ–≤–µ–Ω—å";–ï–°–õ–ò(INDIRECT("B"&ROW())=4;"–ñ–¥—ë—Ç 5 —É—Ä–æ–≤–µ–Ω—å";–ï–°–õ–ò(INDIRECT("B"&ROW())=5;"–°–ø–µ—Ü. –°–ª–µ–¥—è—â–∏–π";"–ù–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–ª —É—Ä–æ–≤–µ–Ω—å")))))'
        formula_n = '=–ï–°–õ–ò(INDIRECT("M"&ROW())="–ñ–¥—ë—Ç 2 —É—Ä–æ–≤–µ–Ω—å";INDIRECT("L"&ROW())+7;–ï–°–õ–ò(INDIRECT("M"&ROW())="–ñ–¥—ë—Ç 3 —É—Ä–æ–≤–µ–Ω—å";INDIRECT("L"&ROW())+31;–ï–°–õ–ò(INDIRECT("M"&ROW())="–ñ–¥—ë—Ç 4 —É—Ä–æ–≤–µ–Ω—å";INDIRECT("L"&ROW())+60;–ï–°–õ–ò(INDIRECT("M"&ROW())="–ñ–¥—ë—Ç 5 —É—Ä–æ–≤–µ–Ω—å";"–ü–æ –¥–æ–≤–µ—Ä–∏—é";–ï–°–õ–ò(INDIRECT("M"&ROW())="–°–ø–µ—Ü. –°–ª–µ–¥—è—â–∏–π";"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ";"–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Å—Ç–∞—Ç—É—Å")))))'
        
        # –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ —Å—Ç–æ–ª–±—Ü—ã, –∫–æ—Ç–æ—Ä—ã–µ –£–ñ–ï –µ—Å—Ç—å –≤ —Ç–∞–±–ª–∏—Ü–µ
        set_cell_value(row_data, header_map, 'LVL', '1')
        set_cell_value(row_data, header_map, 'Nick_Name', nickname)
        set_cell_value(row_data, header_map, '–î–æ–ª–∂–Ω–æ—Å—Ç—å', '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä')
        set_cell_value(row_data, header_map, 'VK', vk_link)
        set_cell_value(row_data, header_map, '–°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–æ—Ä—É–º', f'=HYPERLINK("{forum_link}"; "LINK")')
        set_cell_value(row_data, header_map, '–î–∞—Ç–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞ 1', date_val)
        set_cell_value(row_data, header_map, '–î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–æ–≤—ã—à–µ–Ω–∏—è', date_val)
        set_cell_value(row_data, header_map, '–ñ–¥–µ—Ç —É—Ä–æ–≤–µ–Ω—å', formula_m)
        set_cell_value(row_data, header_map, '–î–∞—Ç–∞ –ø–æ–≤—ã—à–µ–Ω–∏—è', formula_n)
        set_cell_value(row_data, header_map, '–†–∞–∑–æ–≤—ã–µ', "–†–∞–∑–æ–≤—ã–µ [0/3]")
        set_cell_value(row_data, header_map, '–î–ª–∏—Ç–µ–ª—å–Ω—ã–µ', "–î–ª–∏—Ç–µ–ª—å–Ω—ã–µ [0/1]")
        set_cell_value(row_data, header_map, '–í—ã–≥–æ–≤–æ—Ä—ã', "–í—ã–≥–æ–≤–æ—Ä—ã [0/3]")
        
        # append_row –¥–æ–±–∞–≤–∏—Ç –¥–∞–Ω–Ω—ã–µ —Ç–æ–ª—å–∫–æ –≤ —Ä–∞–º–∫–∞—Ö —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∫–æ–ª–æ–Ω–æ–∫
        sheet.append_row(values=row_data, value_input_option='USER_ENTERED')
        return True
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞: {e}")
        return False

def main():
    load_user_rights()
    gc = get_google_client()
    sheet = gc.open(SPREADSHEET_NAME).sheet1
    
    # –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç—É –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
    headers = sheet.get_all_values()[0]
    header_map = {header: index for index, header in enumerate(headers)}
    
    vk_session = vk_api.VkApi(token=VK_TOKEN)
    vk = vk_session.get_api()
    longpoll = VkLongPoll(vk_session)
    
    print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ –≤ –±–µ—Å–µ–¥–∞—Ö.")

    for event in longpoll.listen():
        if event.type == VkEventType.MESSAGE_NEW and event.to_me:
            user_id = event.user_id
            text = event.text.strip()
            
            # --- –õ–û–ì–ò–ö–ê –û–ü–†–ï–î–ï–õ–ï–ù–ò–Ø –ú–ï–°–¢–ê –û–¢–ü–†–ê–í–ö–ò ---
            # –ï—Å–ª–∏ event.from_chat ‚Äî —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ –±–µ—Å–µ–¥—ã
            if event.from_chat:
                send_params = {'chat_id': event.chat_id}
            else:
                send_params = {'user_id': user_id}

            def send_msg(message):
                vk.messages.send(**send_params, message=message, random_id=0)

            # –ö–æ–º–∞–Ω–¥—ã
            if text.startswith('/addadmin'):
                if not has_permission(user_id, 'add_admin'):
                    send_msg("‚ùå –ù–µ—Ç –ø—Ä–∞–≤.")
                    continue
                
                parts = text.split()
                if len(parts) < 5:
                    send_msg("‚ö†Ô∏è –§–æ—Ä–º–∞—Ç: /addadmin [–ù–∏–∫] [–î–∞—Ç–∞] [–í–ö] [–§–æ—Ä—É–º]")
                    continue

                if add_admin_to_sheet(sheet, headers, header_map, parts[1], parts[2], parts[3], parts[4]):
                    send_msg(f"‚úÖ {parts[1]} –¥–æ–±–∞–≤–ª–µ–Ω.")
                else:
                    send_msg("‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞–±–ª–∏—Ü—ã).")

            elif text == '/help':
                send_msg("ü§ñ –ë–æ—Ç –∞–∫—Ç–∏–≤–µ–Ω.\n–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã: /addadmin, /myrights, /stats, /search")

            elif text == '/myrights':
                role = user_rights.get(user_id, {}).get('role', 'user')
                send_msg(f"üë§ –í–∞—à ID: {user_id}\nüîë –†–æ–ª—å: {role}")

# –î–æ–±–∞–≤—å –≤—ã–∑–æ–≤—ã –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π –ø–æ –∞–Ω–∞–ª–æ–≥–∏–∏ (edit, search –∏ —Ç.–¥.)

if __name__ == '__main__':
    main()
