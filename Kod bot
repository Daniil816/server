import os
import pickle
import vk_api
import time
import gspread
import json
import random
import re
from datetime import datetime, timedelta
from vk_api.longpoll import VkLongPoll, VkEventType
from google.auth.transport.requests import Request
from google_auth_oauthlib.flow import InstalledAppFlow


# --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---
VK_TOKEN = 'vk1.a.hnuRWe9zj3RAiXc-2Jhi3ix1wDAYPeA3vv5EuURXKIptRpDR8G948Q891ndVNMuOnz69LxbvAbXQVACkIlLuhQidngypMtSGg4Sv6keay8XH-0WZOs9_L9m4LmXcV3F8pg3dyOTiujoSmzTqi9j2g5j_txPUcKILy_kbavL40GLZ_qLhzbuQjBI_PokDT1cExggdvo2CSgUOsdZBkFayLQ'
SPREADSHEET_NAME = '29 | –†–∞–±–æ—Ç–∞'
RIGHTS_FILE = 'user_rights.json'
CHAT_BINDINGS_FILE = 'chat_bindings.json'
# –†–ê–ó–†–ê–ë–û–¢–ß–ò–ö–ò - –Ω–µ–ª—å–∑—è –æ—Ç–æ–∑–≤–∞—Ç—å –ø—Ä–∞–≤–∞
DEVELOPERS = [807253464, 679050151]
SCOPES = ['https://www.googleapis.com/auth/spreadsheets']
user_rights = {}
chat_bindings = {}


# –¶–≤–µ—Ç–∞ –¥–ª—è —É—Ä–æ–≤–Ω–µ–π
COLOR_MAP = {
   1: {
       'B_bg': {'red': 0.741, 'green': 0.902, 'blue': 0.988},  # —Å–≤–µ—Ç–ª–æ-–≥–æ–ª—É–±–æ–π (2)
       'B_text': {'red': 0.0, 'green': 0.0, 'blue': 1.0},  # —Å–∏–Ω–∏–π
       'D_bg': {'red': 0.741, 'green': 0.902, 'blue': 0.988},  # —Å–≤–µ—Ç–ª–æ-–≥–æ–ª—É–±–æ–π (2)
   },
   2: {
       'B_bg': {'red': 0.956, 'green': 0.8, 'blue': 0.8},  # —Å–≤–µ—Ç–ª–æ-–∫—Ä–∞—Å–Ω—ã–π (2)
       'B_text': {'red': 1.0, 'green': 0.0, 'blue': 0.0},  # –∫—Ä–∞—Å–Ω—ã–π
       'D_bg': {'red': 0.631, 'green': 0.808, 'blue': 0.957},  # —Å–≤–µ—Ç–ª–æ-–≥–æ–ª—É–±–æ–π (2)
   },
   3: {
       'B_bg': {'red': 0.71, 'green': 0.65, 'blue': 0.84},  # —Å–≤–µ—Ç–ª–æ-—Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π (2)
       'B_text': {'red': 1.0, 'green': 0.0, 'blue': 0.0},  # –∫—Ä–∞—Å–Ω—ã–π
       'D_bg': {'red': 0.71, 'green': 0.65, 'blue': 0.84},  # —Å–≤–µ—Ç–ª–æ-—Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π (2)
   },
   4: {
       'B_bg': {'red': 0.40, 'green': 0.31, 'blue': 0.65},  # —Ç–µ–º–Ω–æ-—Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π (1)
       'B_text': {'red': 0.576, 'green': 0.117, 'blue': 0.117},  # —Å–≤–µ—Ç–ª–æ-–±–æ—Ä–¥–æ–≤—ã–π (1)
       'D_bg': {'red': 0.56, 'green': 0.49, 'blue': 0.76},  # —Å–≤–µ—Ç–ª–æ-—Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π (1)
   },
   5: {
       'B_bg': {'red': 0.96, 'green': 0.8, 'blue': 0.8},  # —Å–≤–µ—Ç–ª–æ-–∫—Ä–∞—Å–Ω—ã–π (3)
       'B_text': {'red': 0.576, 'green': 0.117, 'blue': 0.117},  # —Å–≤–µ—Ç–ª–æ-–±–æ—Ä–¥–æ–≤—ã–π (1)
       'D_bg': {'red': 0.92, 'green': 0.6, 'blue': 0.6},  # —Å–≤–µ—Ç–ª–æ-–±–æ—Ä–¥–æ–≤—ã–π (2)
   }
}




def add_border_to_row(sheet, row_number):
   """–î–æ–±–∞–≤–ª—è–µ—Ç –æ–±–≤–æ–¥–∫—É –≤–∏–¥–∞ '–í—Å–µ –≥—Ä–∞–Ω–∏—Ü—ã' –º–∞–ª–æ–π —Ç–æ–ª—â–∏–Ω—ã –∫ —Å—Ç—Ä–æ–∫–µ"""
   try:
       requests = {
           'requests': [{
               'updateBorders': {
                   'range': {
                       'sheetId': sheet.id,
                       'startRowIndex': row_number - 1,
                       'endRowIndex': row_number,
                       'startColumnIndex': 0,
                       'endColumnIndex': 23  # –°—Ç–æ–ª–±—Ü—ã A-W
                   },
                   'top': {'style': 'SOLID', 'width': 1, 'color': {'red': 0, 'green': 0, 'blue': 0}},
                   'bottom': {'style': 'SOLID', 'width': 1, 'color': {'red': 0, 'green': 0, 'blue': 0}},
                   'left': {'style': 'SOLID', 'width': 1, 'color': {'red': 0, 'green': 0, 'blue': 0}},
                   'right': {'style': 'SOLID', 'width': 1, 'color': {'red': 0, 'green': 0, 'blue': 0}},
                   'innerHorizontal': {'style': 'SOLID', 'width': 1, 'color': {'red': 0, 'green': 0, 'blue': 0}},
                   'innerVertical': {'style': 'SOLID', 'width': 1, 'color': {'red': 0, 'green': 0, 'blue': 0}}
               }
           }]
       }


       sheet.spreadsheet.batch_update(requests)
       print(f"‚úì –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±–≤–æ–¥–∫–∞ –∫ —Å—Ç—Ä–æ–∫–µ {row_number}")
       return True
   except Exception as e:
       print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –æ–±–≤–æ–¥–∫–∏: {e}")
       return False




def add_single_row_to_sheet(sheet):
   """–î–æ–±–∞–≤–ª—è–µ—Ç –æ–¥–Ω—É –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É –≤ –∫–æ–Ω–µ—Ü —Ç–∞–±–ª–∏—Ü—ã"""
   try:
       sheet_info = sheet.spreadsheet.fetch_sheet_metadata()
       grid_props = sheet_info['sheets'][0]['properties']['gridProperties']
       current_rows = grid_props.get('rowCount', 0)


       sheet.spreadsheet.batch_update({
           'requests': [{
               'appendDimension': {
                   'sheetId': sheet.id,
                   'dimension': 'ROWS',
                   'length': 1
               }
           }]
       })
       print(f"‚úì –î–æ–±–∞–≤–ª–µ–Ω–∞ 1 —Å—Ç—Ä–æ–∫–∞ –∫ —Ç–∞–±–ª–∏—Ü–µ (–±—ã–ª–æ: {current_rows}, —Å—Ç–∞–ª–æ: {current_rows + 1})")
       return True
   except Exception as e:
       print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Å—Ç—Ä–æ–∫–∏: {e}")
       return False




def ensure_sheet_has_row(sheet, row_number):
   """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Å—Ç—Ä–æ–∫–∞ –≤ —Ç–∞–±–ª–∏–∫–µ, –µ—Å–ª–∏ –Ω–µ—Ç - –¥–æ–±–∞–≤–ª—è–µ—Ç"""
   try:
       sheet_info = sheet.spreadsheet.fetch_sheet_metadata()
       grid_props = sheet_info['sheets'][0]['properties']['gridProperties']
       max_rows = grid_props.get('rowCount', 0)


       if row_number > max_rows:
           rows_to_add = row_number - max_rows
           print(
               f"‚ö†Ô∏è –°—Ç—Ä–æ–∫–∞ {row_number} –≤—ã—Ö–æ–¥–∏—Ç –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã —Ç–∞–±–ª–∏—Ü—ã ({max_rows} —Å—Ç—Ä–æ–∫). –î–æ–±–∞–≤–ª—è–µ–º {rows_to_add} —Å—Ç—Ä–æ–∫...")


           sheet.spreadsheet.batch_update({
               'requests': [{
                   'appendDimension': {
                       'sheetId': sheet.id,
                       'dimension': 'ROWS',
                       'length': rows_to_add
                   }
               }]
           })
           print(f"‚úì –î–æ–±–∞–≤–ª–µ–Ω–æ {rows_to_add} —Å—Ç—Ä–æ–∫ (—Ç–µ–ø–µ—Ä—å {max_rows + rows_to_add} —Å—Ç—Ä–æ–∫)")
           return True
       return True
   except Exception as e:
       print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å—Ç—Ä–æ–∫–∏: {e}")
       return False




def load_user_rights():
   """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –ø—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ —Ñ–∞–π–ª–∞"""
   global user_rights
   if os.path.exists(RIGHTS_FILE):
       try:
           with open(RIGHTS_FILE, 'r', encoding='utf-8') as f:
               user_rights = json.load(f)
           user_rights = {int(k): v for k, v in user_rights.items()}
       except Exception as e:
           print(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∞–≤: {e}")
           user_rights = {}
   else:
       user_rights = {}


   for developer_id in DEVELOPERS:
       if developer_id not in user_rights:
           user_rights[developer_id] = {
               'role': 'developer',
               'permissions': ['add_admin', 'add_editor', 'edit_table', 'grant_access', 'revoke_super', 'lvlup',
                               'promotionlist'],
               'is_developer': True,
               'added_by': 'system',
               'added_date': time.strftime("%d.%m.%Y %H:%M:%S")
           }
       else:
           user_info = user_rights[developer_id]
           if 'permissions' not in user_info:
               user_info['permissions'] = []


           required_permissions = ['add_admin', 'add_editor', 'edit_table', 'grant_access', 'revoke_super', 'lvlup',
                                   'promotionlist']
           for perm in required_permissions:
               if perm not in user_info['permissions']:
                   user_info['permissions'].append(perm)
                   print(f"‚úì –î–æ–±–∞–≤–ª–µ–Ω–æ –ø—Ä–∞–≤–æ '{perm}' —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É {developer_id}")


   save_user_rights()




def save_user_rights():
   """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ —Ñ–∞–π–ª"""
   try:
       with open(RIGHTS_FILE, 'w', encoding='utf-8') as f:
           json.dump(user_rights, f, ensure_ascii=False, indent=2)
   except Exception as e:
       print(f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–∞–≤: {e}")




def load_chat_bindings():
   """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –ø—Ä–∏–≤—è–∑–∫–∏ —á–∞—Ç–æ–≤ –∏–∑ —Ñ–∞–π–ª–∞"""
   global chat_bindings
   if os.path.exists(CHAT_BINDINGS_FILE):
       try:
           with open(CHAT_BINDINGS_FILE, 'r', encoding='utf-8') as f:
               chat_bindings = json.load(f)
           chat_bindings = {int(k): v for k, v in chat_bindings.items()}
           print(f"‚úì –ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(chat_bindings)} –ø—Ä–∏–≤—è–∑–æ–∫ —á–∞—Ç–æ–≤")
       except Exception as e:
           print(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏–≤—è–∑–æ–∫ —á–∞—Ç–æ–≤: {e}")
           chat_bindings = {}
   else:
       chat_bindings = {}
       print("–§–∞–π–ª –ø—Ä–∏–≤—è–∑–æ–∫ —á–∞—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π")




def save_chat_bindings():
   """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø—Ä–∏–≤—è–∑–∫–∏ —á–∞—Ç–æ–≤ –≤ —Ñ–∞–π–ª"""
   try:
       with open(CHAT_BINDINGS_FILE, 'w', encoding='utf-8') as f:
           json.dump(chat_bindings, f, ensure_ascii=False, indent=2)
       print(f"‚úì –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ {len(chat_bindings)} –ø—Ä–∏–≤—è–∑–æ–∫ —á–∞—Ç–æ–≤")
   except Exception as e:
       print(f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–∏–≤—è–∑–æ–∫ —á–∞—Ç–æ–≤: {e}")




def add_chat_binding(chat_id, spreadsheet_name, added_by_user_id):
   """–î–æ–±–∞–≤–ª—è–µ—Ç –ø—Ä–∏–≤—è–∑–∫—É —á–∞—Ç–∞ –∫ —Ç–∞–±–ª–∏—Ü–µ"""
   try:
       gc = get_google_client()
       try:
           spreadsheet = gc.open(spreadsheet_name)
           chat_bindings[chat_id] = {
               'spreadsheet_name': spreadsheet_name,
               'added_by': added_by_user_id,
               'added_date': time.strftime("%d.%m.%Y %H:%M:%S"),
               'chat_title': f"–ë–µ—Å–µ–¥–∞ {chat_id}"
           }
           save_chat_bindings()
           return True, f"‚úÖ –ß–∞—Ç —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ —Ç–∞–±–ª–∏—Ü–µ '{spreadsheet_name}'!"
       except gspread.exceptions.SpreadsheetNotFound:
           return False, f"‚ùå –¢–∞–±–ª–∏—Ü–∞ '{spreadsheet_name}' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ."
   except Exception as e:
       return False, f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–≤—è–∑–∫–µ —á–∞—Ç–∞: {str(e)}"




def remove_chat_binding(chat_id):
   """–£–¥–∞–ª—è–µ—Ç –ø—Ä–∏–≤—è–∑–∫—É —á–∞—Ç–∞"""
   if chat_id in chat_bindings:
       spreadsheet_name = chat_bindings[chat_id]['spreadsheet_name']
       del chat_bindings[chat_id]
       save_chat_bindings()
       return True, f"‚úÖ –ü—Ä–∏–≤—è–∑–∫–∞ —á–∞—Ç–∞ –∫ —Ç–∞–±–ª–∏—Ü–µ '{spreadsheet_name}' —É–¥–∞–ª–µ–Ω–∞!"
   else:
       return False, "‚ùå –ß–∞—Ç –Ω–µ –∏–º–µ–µ—Ç –ø—Ä–∏–≤—è–∑–∫–∏."




def get_chat_spreadsheet(chat_id):
   """–ü–æ–ª—É—á–∞–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã, –ø—Ä–∏–≤—è–∑–∞–Ω–Ω–æ–π –∫ —á–∞—Ç—É"""
   if chat_id in chat_bindings:
       return chat_bindings[chat_id]['spreadsheet_name']
   return None




def get_user_role(user_id):
   """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
   if user_id in user_rights:
       return user_rights[user_id].get('role', 'user')
   return 'user'




# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ - –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –û–°–¢–ê–í–õ–Ø–ï–ú –§–£–ù–ö–¶–ò–ï–ô
def check_is_developer(user_id):
   """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–º"""
   return user_id in DEVELOPERS




def has_permission(user_id, permission):
   """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –µ—Å—Ç—å –ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ"""
   # –†–ê–ó–†–ê–ë–û–¢–ß–ò–ö–ò –ò–ú–ï–Æ–¢ –í–°–ï –ü–†–ê–í–ê –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò
   if check_is_developer(user_id):
       return True


   # –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞
   if user_id in user_rights:
       user_info = user_rights[user_id]


       # –î–ª—è –ø—Ä–∞–≤ lvlup –∏ promotionlist –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ä–æ–ª—å
       if permission == 'lvlup':
           role = user_info.get('role', 'user')
           return role in ['editor', 'admin', 'developer']
       elif permission == 'promotionlist':
           role = user_info.get('role', 'user')
           return role in ['editor', 'admin', 'developer']


       # –î–ª—è –¥—Ä—É–≥–∏—Ö –ø—Ä–∞–≤ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–ø–∏—Å–æ–∫ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π
       permissions = user_info.get('permissions', [])
       return permission in permissions


   return False




def can_revoke_rights(revoker_id, target_id):
   """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –º–æ–∂–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–æ–∑–≤–∞—Ç—å –ø—Ä–∞–≤–∞ —É –¥—Ä—É–≥–æ–≥–æ"""
   if check_is_developer(revoker_id):
       return not check_is_developer(target_id)
   if has_permission(revoker_id, 'grant_access'):
       return not (check_is_developer(target_id) or has_permission(target_id, 'grant_access'))
   return False




def add_user_rights(user_id, role, permissions, added_by):
   """–î–æ–±–∞–≤–ª—è–µ—Ç –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –ø—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
   if check_is_developer(user_id):
       return False, "–ù–µ–ª—å–∑—è –∏–∑–º–µ–Ω—è—Ç—å –ø—Ä–∞–≤–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞!"


   user_rights[user_id] = {
       'role': role,
       'permissions': permissions,
       'added_by': added_by,
       'added_date': time.strftime("%d.%m.%Y %H:%M:%S"),
       'is_developer': False
   }
   save_user_rights()
   return True, "–ü—Ä–∞–≤–∞ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω—ã"




def remove_user_rights(user_id, remover_id):
   """–£–¥–∞–ª—è–µ—Ç –ø—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
   if not can_revoke_rights(remover_id, user_id):
       return False, "–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –æ—Ç–∑—ã–≤–∞ –ø—Ä–∞–≤ —É —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è!"


   if user_id in user_rights:
       if user_rights[user_id].get('is_developer', False):
           return False, "–ù–µ–ª—å–∑—è —É–¥–∞–ª—è—Ç—å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞!"


       role = user_rights[user_id].get('role', 'user')
       del user_rights[user_id]
       save_user_rights()
       return True, f"–ü—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} ({role}) —É—Å–ø–µ—à–Ω–æ –æ—Ç–æ–∑–≤–∞–Ω—ã!"
   return False, "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω"




def get_google_client():
   """–ü–æ–ª—É—á–µ–Ω–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ Google Sheets"""
   creds = None
   if os.path.exists('token.pickle'):
       with open('token.pickle', 'rb') as token:
           creds = pickle.load(token)


   if not creds or not creds.valid:
       if creds and creds.expired and creds.refresh_token:
           creds.refresh(Request())
       else:
           flow = InstalledAppFlow.from_client_secrets_file('client_secret.json', SCOPES)
           print("–ù—É–∂–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –¥–æ—Å—Ç—É–ø –≤ –±—Ä–∞—É–∑–µ—Ä–µ...")
           creds = flow.run_local_server(port=8080)


       with open('token.pickle', 'wb') as token:
           pickle.dump(creds, token)


   return gspread.authorize(creds)




def get_last_non_empty_row(sheet):
   """–ù–∞—Ö–æ–¥–∏—Ç –ø–æ—Å–ª–µ–¥–Ω—é—é –Ω–µ–ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É –≤ —Ç–∞–±–ª–∏—Ü–µ"""
   try:
       all_values = sheet.get_all_values()
       for i in range(len(all_values) - 1, 0, -1):
           row = all_values[i]
           if any(cell.strip() for cell in row):
               return i + 1
       return 1
   except Exception as e:
       print(f"–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å—Ç—Ä–æ–∫–∏: {e}")
       return len(sheet.get_all_values()) + 1




def find_empty_row(sheet, start_row=None):
   """–ù–∞—Ö–æ–¥–∏—Ç –ø–µ—Ä–≤—É—é –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É, –Ω–∞—á–∏–Ω–∞—è —Å —É–∫–∞–∑–∞–Ω–Ω–æ–π –∏–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–π –Ω–µ–ø—É—Å—Ç–æ–π"""
   try:
       if start_row is None:
           start_row = get_last_non_empty_row(sheet)


       all_values = sheet.get_all_values()


       for row_num in range(start_row, len(all_values) + 1):
           if row_num > len(all_values):
               return row_num


           row_index = row_num - 1
           if row_index < len(all_values):
               row = all_values[row_index]
               if not any(cell.strip() for cell in row):
                   return row_num


       return len(all_values) + 1








   except Exception as e:
       print(f"–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–∏: {e}")
       return get_last_non_empty_row(sheet) + 1




def apply_complete_row_formatting(sheet, row_number, make_bold=False):
   """–ü—Ä–∏–º–µ–Ω—è–µ—Ç –ø–æ–ª–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ —Å –ø–æ–¥—á–µ—Ä–∫–Ω—É—Ç—ã–º–∏ —Å—Å—ã–ª–∫–∞–º–∏"""
   try:
       requests = []


       column_colors = {
           1: {'red': 0.415, 'green': 0.658, 'blue': 0.309},
           2: {'red': 0.741, 'green': 0.902, 'blue': 0.988},
           3: {'red': 1.0, 'green': 1.0, 'blue': 1.0},
           4: {'red': 0.741, 'green': 0.902, 'blue': 0.988},
           7: {'red': 0.725, 'green': 0.878, 'blue': 0.976},
           8: {'red': 0.631, 'green': 0.808, 'blue': 0.957},
           9: {'red': 0.71, 'green': 0.65, 'blue': 0.84},
           10: {'red': 1.0, 'green': 0.898, 'blue': 0.6},
           11: {'red': 0.956, 'green': 0.8, 'blue': 0.8},
           12: {'red': 0.886, 'green': 0.854, 'blue': 0.866},
           13: {'red': 0.85, 'green': 0.823, 'blue': 0.913},
           14: {'red': 0.976, 'green': 0.796, 'blue': 0.611},
           15: {'red': 0.976, 'green': 0.796, 'blue': 0.611},
           16: {'red': 0.415, 'green': 0.658, 'blue': 0.309},
           17: {'red': 0.819, 'green': 0.756, 'blue': 0.933},
           18: {'red': 0.945, 'green': 0.764, 'blue': 0.764},
           19: {'red': 0.941, 'green': 0.8, 'blue': 0.941},
           20: {'red': 0.8, 'green': 0.254, 'blue': 0.145},
           21: {'red': 0.917, 'green': 0.6, 'blue': 0.6},
           22: {'red': 1.0, 'green': 0.949, 'blue': 0.8},
           23: {'red': 0.941, 'green': 0.8, 'blue': 0.941},
       }


       text_colors = {
           2: {'red': 0.0, 'green': 0.0, 'blue': 0.0},
           4: {'red': 0.0, 'green': 0.0, 'blue': 0.0},
           7: {'red': 0.0, 'green': 0.0, 'blue': 0.0},
           8: {'red': 0.0, 'green': 0.0, 'blue': 0.0},
           9: {'red': 0.0, 'green': 0.0, 'blue': 0.0},
           10: {'red': 0.0, 'green': 0.0, 'blue': 0.0},
           11: {'red': 0.0, 'green': 0.0, 'blue': 0.0},
           12: {'red': 0.0, 'green': 0.0, 'blue': 0.0},
           13: {'red': 0.0, 'green': 0.0, 'blue': 0.0},
           14: {'red': 0.0, 'green': 0.0, 'blue': 0.0},
           15: {'red': 0.0, 'green': 0.0, 'blue': 0.0},
           17: {'red': 0.0, 'green': 0.0, 'blue': 0.0},
           18: {'red': 0.0, 'green': 0.0, 'blue': 0.0},
           19: {'red': 0.0, 'green': 0.0, 'blue': 0.0},
           20: {'red': 0.0, 'green': 0.0, 'blue': 0.0},
           21: {'red': 0.0, 'green': 0.0, 'blue': 0.0},
           22: {'red': 0.0, 'green': 0.0, 'blue': 0.0},
           23: {'red': 0.0, 'green': 0.0, 'blue': 0.0},
       }


       for col in range(1, 24):
           if col == 5 or col == 6:
               continue


           format_request = {
               'repeatCell': {
                   'range': {
                       'sheetId': sheet.id,
                       'startRowIndex': row_number - 1,
                       'endRowIndex': row_number,
                       'startColumnIndex': col - 1,
                       'endColumnIndex': col
                   },
                   'cell': {
                       'userEnteredFormat': {
                           'backgroundColor': column_colors.get(col, {'red': 1.0, 'green': 1.0, 'blue': 1.0}),
                           'textFormat': {
                               'fontFamily': 'Comfortaa',
                               'fontSize': 11,
                               'foregroundColor': text_colors.get(col, {'red': 0.0, 'green': 0.0, 'blue': 0.0}),
                               'bold': make_bold
                           },
                           'horizontalAlignment': 'CENTER',
                           'verticalAlignment': 'MIDDLE'
                       }
                   },
                   'fields': 'userEnteredFormat(backgroundColor,textFormat,horizontalAlignment,verticalAlignment)'
               }
           }
           requests.append(format_request)


       # –û–°–û–ë–û–ï –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï –î–õ–Ø –°–¢–û–õ–ë–¶–û–í –° –°–°–´–õ–ö–ê–ú–ò (E –∏ F) - –ü–û–î–ß–ï–†–ö–ù–£–¢–´–ï –°–°–´–õ–ö–ò
       for col in [5, 6]:  # –°—Ç–æ–ª–±—Ü—ã E –∏ F
           format_request = {
               'repeatCell': {
                   'range': {
                       'sheetId': sheet.id,
                       'startRowIndex': row_number - 1,
                       'endRowIndex': row_number,
                       'startColumnIndex': col - 1,
                       'endColumnIndex': col
                   },
                   'cell': {
                       'userEnteredFormat': {
                           'backgroundColor': {'red': 1.0, 'green': 1.0, 'blue': 1.0},
                           'textFormat': {
                               'fontFamily': 'Comfortaa',
                               'fontSize': 11,
                               'bold': True,
                               'foregroundColor': {'red': 0.0, 'green': 0.0, 'blue': 1.0},
                               'underline': True
                           },
                           'horizontalAlignment': 'CENTER',
                           'verticalAlignment': 'MIDDLE',
                           'hyperlinkDisplayType': 'LINKED'
                       }
                   },
                   'fields': 'userEnteredFormat(backgroundColor,textFormat,horizontalAlignment,verticalAlignment,hyperlinkDisplayType)'
               }
           }
           requests.append(format_request)


       if requests:
           sheet.spreadsheet.batch_update({'requests': requests})
           print(f"‚úì –ü—Ä–∏–º–µ–Ω–µ–Ω–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫ —Å—Ç—Ä–æ–∫–µ {row_number} (—Å—Å—ã–ª–∫–∏ –ø–æ–¥—á–µ—Ä–∫–Ω—É—Ç—ã)")


       return True








   except Exception as e:
       print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: {e}")
       return False




def create_smart_hyperlink(url, display_text="LINK"):
   """–°–æ–∑–¥–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Ñ–æ—Ä–º—É–ª—É –≥–∏–ø–µ—Ä—Å—Å—ã–ª–∫–∏ —Å —Ç–æ—á–∫–æ–π —Å –∑–∞–ø—è—Ç–æ–π –∫–∞–∫ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–º"""
   try:
       clean_url = url.strip().replace('"', '').replace("'", "")
       clean_display = display_text.strip().replace('"', '').replace("'", "")


       if not clean_url.startswith(('http://', 'https://')):
           clean_url = f'https://{clean_url}'


       formula = f'=HYPERLINK("{clean_url}"; "{clean_display}")'


       print(f"–°–æ–∑–¥–∞–Ω–∞ —Ñ–æ—Ä–º—É–ª–∞ –≥–∏–ø–µ—Ä—Å—Å—ã–ª–∫–∏: {formula}")
       return formula








   except Exception as e:
       print(f"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–æ—Ä–º—É–ª—ã –≥–∏–ø–µ—Ä—Å—Å—ã–ª–∫–∏: {e}")
       return url




def extract_formula_from_cell(sheet, row, col):
   """–ü–æ–ª—É—á–∞–µ—Ç —Ñ–æ—Ä–º—É–ª—É –∏–∑ —è—á–µ–π–∫–∏, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å"""
   try:
       cell_obj = sheet.cell(row, col, value_render_option='FORMULA')
       if cell_obj and cell_obj.value:
           return cell_obj.value
       return None
   except Exception as e:
       print(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ñ–æ—Ä–º—É–ª—ã –∏–∑ —è—á–µ–π–∫–∏ ({row}, {col}): {e}")
       return None




def extract_url_from_hyperlink(cell_value):
   """–ò–∑–≤–ª–µ–∫–∞–µ—Ç URL –∏–∑ –∑–Ω–∞—á–µ–Ω–∏—è —è—á–µ–π–∫–∏ —Å –≥–∏–ø–µ—Ä—Å—Å—ã–ª–∫–æ–π"""
   if not cell_value:
       return ""


   cell_str = str(cell_value)


   if '=HYPERLINK(' in cell_str:
       parts = cell_str.split('"')
       if len(parts) >= 2:
           return parts[1]








   elif 'http' in cell_str:
       return cell_str


   return ""




def search_admin_in_sheet(sheet, search_term):
   """–ò—â–µ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –≤ —Ç–∞–±–ª–∏—Ü–µ –∏ –≤—ã–≤–æ–¥–∏—Ç –Ω—É–∂–Ω—ã–µ –ø–æ–ª—è"""
   try:
       all_values = sheet.get_all_values()
       results = []


       for i, row in enumerate(all_values):
           if i == 0 or i == 1:
               continue
           if len(row) > 2 and search_term.lower() in row[2].lower():
               admin_info = f"üë§ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –Ω–∞–π–¥–µ–Ω:\n"
               admin_info += f"üìç –°—Ç—Ä–æ–∫–∞: {i + 1}\n"
               admin_info += f"üè∑Ô∏è –ù–∏–∫: {row[2] if len(row) > 2 else '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}\n"
               admin_info += f"üíº –î–æ–ª–∂–Ω–æ—Å—Ç—å: {row[3] if len(row) > 3 else '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}\n"
               admin_info += f"‚≠ê LVL: {row[1] if len(row) > 1 else '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}\n"


               vk_formula = extract_formula_from_cell(sheet, i + 1, 5)
               vk_url = extract_url_from_hyperlink(vk_formula)
               admin_info += f"üîó VK: {vk_url if vk_url else '–ù–µ—Ç —Å—Å—ã–ª–∫–∏'}\n"


               forum_formula = extract_formula_from_cell(sheet, i + 1, 6)
               forum_url = extract_url_from_hyperlink(forum_formula)
               admin_info += f"üåê –§–æ—Ä—É–º–Ω–∏–∫: {forum_url if forum_url else '–ù–µ—Ç —Å—Å—ã–ª–∫–∏'}\n"


               admin_info += f"üìÖ –î–∞—Ç–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞ –ø–æ—Å—Ç: {row[6] if len(row) > 6 else '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}\n"
               admin_info += f"üìà –î–∞—Ç–∞ –±–ª–∏–∂–∞–π—à–µ–≥–æ –ø–æ–≤—ã—à–µ–Ω–∏—è: {row[13] if len(row) > 13 else '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}\n"
               results.append(admin_info)


       if results:
           return True, "\n\n".join(results[:10])
       else:
           return False, f"‚ùå –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –ø–æ –∑–∞–ø—Ä–æ—Å—É '{search_term}' –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
   except Exception as e:
       return False, f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: {str(e)}"




def add_admin_to_sheet(sheet, nickname, date_val, vk_link, forum_link):
   """–î–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤–æ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –≤ —Ç–∞–±–ª–∏—Ü—É —Å –≥–∏–ø–µ—Ä—Å—Å—ã–ª–∫–∞–º–∏"""
   try:
       last_non_empty = get_last_non_empty_row(sheet)
       new_row = last_non_empty + 1


       print(f"–ü–æ—Å–ª–µ–¥–Ω—è—è –Ω–µ–ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞: {last_non_empty}")
       print(f"–î–æ–±–∞–≤–ª—è–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –≤ —Å—Ç—Ä–æ–∫—É: {new_row}")


       if not ensure_sheet_has_row(sheet, new_row):
           print("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É, –ø—Ä–æ–±—É–µ–º –¥–æ–±–∞–≤–∏—Ç—å –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É...")
           if not add_single_row_to_sheet(sheet):
               return False


       formula_m = '=–ï–°–õ–ò(INDIRECT("B"&ROW())=1;"–ñ–¥—ë—Ç 2 —É—Ä–æ–≤–µ–Ω—å";–ï–°–õ–ò(INDIRECT("B"&ROW())=2;"–ñ–¥—ë—Ç 3 —É—Ä–æ–≤–µ–Ω—å";–ï–°–õ–ò(INDIRECT("B"&ROW())=3;"–ñ–¥—ë—Ç 4 —É—Ä–æ–≤–µ–Ω—å";–ï–°–õ–ò(INDIRECT("B"&ROW())=4;"–ñ–¥—ë—Ç 5 —É—Ä–æ–≤–µ–Ω—å";–ï–°–õ–ò(INDIRECT("B"&ROW())=5;"–°–ø–µ—Ü. –°–ª–µ–¥—è—â–∏–π";"–ù–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–ª —É—Ä–æ–≤–µ–Ω—å")))))'


       formula_n = '=–ï–°–õ–ò(INDIRECT("M"&ROW())="–ñ–¥—ë—Ç 2 —É—Ä–æ–≤–µ–Ω—å";INDIRECT("L"&ROW())+7;–ï–°–õ–ò(INDIRECT("M"&ROW())="–ñ–¥—ë—Ç 3 —É—Ä–æ–≤–µ–Ω—å";INDIRECT("L"&ROW())+31;–ï–°–õ–ò(INDIRECT("M"&ROW())="–ñ–¥—ë—Ç 4 —É—Ä–æ–≤–µ–Ω—å";INDIRECT("L"&ROW())+60;–ï–°–õ–ò(INDIRECT("M"&ROW())="–ñ–¥—ë—Ç 5 —É—Ä–æ–≤–µ–Ω—å";"–ü–æ –¥–æ–≤–µ—Ä–∏—é";–ï–°–õ–ò(INDIRECT("M"&ROW())="–°–ø–µ—Ü. –°–ª–µ–¥—è—â–∏–π";"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ";"–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Å—Ç–∞—Ç—É—Å")))))'


       sheet.update_cell(new_row, 1, '')
       sheet.update_cell(new_row, 2, '1')
       sheet.update_cell(new_row, 3, nickname)
       sheet.update_cell(new_row, 4, '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä')


       vk_formula = create_smart_hyperlink(vk_link, vk_link)
       sheet.update_cell(new_row, 5, vk_formula)
       print(f"‚úì –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ–æ—Ä–º—É–ª–∞ VK: {vk_formula}")


       forum_formula = create_smart_hyperlink(forum_link, "LINK")
       sheet.update_cell(new_row, 6, forum_formula)
       print(f"‚úì –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ–æ—Ä–º—É–ª–∞ Forum: {forum_formula}")


       sheet.update_cell(new_row, 7, date_val)
       sheet.update_cell(new_row, 12, date_val)
       sheet.update_cell(new_row, 13, formula_m)
       sheet.update_cell(new_row, 14, formula_n)


       sheet.update_cell(new_row, 17, "–†–∞–∑–æ–≤—ã–µ [0/3]")
       sheet.update_cell(new_row, 18, "–î–ª–∏—Ç–µ–ª—å–Ω—ã–µ [0/1]")
       sheet.update_cell(new_row, 19, "–ü—è—Ç–∏–¥–µ—Å—è—Ç–∏–ø—Ä–æ—Ü–µ–Ω—Ç–Ω—ã–π [0/2]")
       sheet.update_cell(new_row, 20, "–í—ã–≥–æ–≤–æ—Ä—ã [0/3]")
       sheet.update_cell(new_row, 21, "–ò–∑ –Ω–∏—Ö –≤—ã–≥–æ–≤–æ—Ä—ã –±/—Å [0]")
       sheet.update_cell(new_row, 22, "–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è [0/3]")
       sheet.update_cell(new_row, 23, "–õ–æ–≥–∏ –Ω–æ—Ä–º—ã [0/3]")


       time.sleep(3)


       apply_complete_row_formatting(sheet, new_row, make_bold=True)
       apply_lvlup_formatting(sheet, new_row, 1)
       add_border_to_row(sheet, new_row)


       print(f"‚úÖ –ù–æ–≤—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Å—Ç—Ä–æ–∫—É {new_row}")
       print(f"–ù–∏–∫: {nickname}")
       print(f"–°—Ç–æ–ª–±–µ—Ü E: {vk_link} (–∫–ª–∏–∫–∞–±–µ–ª—å–Ω–∞—è –ø–æ–¥—á–µ—Ä–∫–Ω—É—Ç–∞—è —Å—Å—ã–ª–∫–∞)")
       print(f"–°—Ç–æ–ª–±–µ—Ü F: LINK (–∫–ª–∏–∫–∞–±–µ–ª—å–Ω–∞—è –ø–æ–¥—á–µ—Ä–∫–Ω—É—Ç–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ {forum_link})")


       time.sleep(3)
       try:
           vk_cell_value = sheet.cell(new_row, 5, value_render_option='FORMULA').value
           forum_cell_value = sheet.cell(new_row, 6, value_render_option='FORMULA').value
           print(f"–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º—É–ª: VK='{vk_cell_value}', Forum='{forum_cell_value}'")


           n_cell_value = sheet.cell(new_row, 14, value_render_option='FORMULA').value
           print(f"–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º—É–ª—ã –≤ —Å—Ç–æ–ª–±–µ—Ü–µ N: '{n_cell_value}'")


           if vk_cell_value and '#ERROR!' in str(vk_cell_value):
               print("‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –æ—à–∏–±–∫–∞ –≤ —Ñ–æ—Ä–º—É–ª–µ VK, –ø—Ä–æ–±—É–µ–º —É–ø—Ä–æ—â–µ–Ω–Ω—É—é —Ñ–æ—Ä–º—É–ª—É...")
               clean_url = vk_link.strip().replace('"', '').replace("'", "")
               if not clean_url.startswith(('http://', 'https://')):
                   clean_url = f'https://{clean_url}'
               vk_formula_simple = f'=HYPERLINK("{clean_url}"; "{clean_url}")'
               sheet.update_cell(new_row, 5, vk_formula_simple)
               print(f"–ó–∞–º–µ–Ω–µ–Ω–∞ –Ω–∞ —Ñ–æ—Ä–º—É–ª—É: {vk_formula_simple}")


           if forum_cell_value and '#ERROR!' in str(forum_cell_value):
               print("‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –æ—à–∏–±–∫–∞ –≤ —Ñ–æ—Ä–º—É–ª–µ Forum, –ø—Ä–æ–±—É–µ–º —É–ø—Ä–æ—â–µ–Ω–Ω—É—é —Ñ–æ—Ä–º—É–ª—É...")
               clean_url = forum_link.strip().replace('"', '').replace("'", "")
               if not clean_url.startswith(('http://', 'https://')):
                   clean_url = f'https://{clean_url}'
               forum_formula_simple = f'=HYPERLINK("{clean_url}"; "LINK")'
               sheet.update_cell(new_row, 6, forum_formula_simple)
               print(f"–ó–∞–º–µ–Ω–µ–Ω–∞ –Ω–∞ —Ñ–æ—Ä–º—É–ª—É: {forum_formula_simple}")


           if n_cell_value and '#ERROR!' in str(n_cell_value):
               print("‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –æ—à–∏–±–∫–∞ –≤ —Ñ–æ—Ä–º—É–ª–µ N, –ø—Ä–æ–±—É–µ–º —É–ø—Ä–æ—â–µ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é...")
               formula_n_simple = '=–ï–°–õ–ò(M{row}="–ñ–¥—ë—Ç 2 —É—Ä–æ–≤–µ–Ω—å";L{row}+7;–ï–°–õ–ò(M{row}="–ñ–¥—ë—Ç 3 —É—Ä–æ–≤–µ–Ω—å";L{row}+31;–ï–°–õ–ò(M{row}="–ñ–¥—ë—Ç 4 —É—Ä–æ–≤–µ–Ω—å";L{row}+60;–ï–°–õ–ò(M{row}="–ñ–¥—ë—Ç 5 —É—Ä–æ–≤–µ–Ω—å";"–ü–æ –¥–æ–≤–µ—Ä–∏—é";–ï–°–õ–ò(M{row}="–°–ø–µ—Ü. –°–ª–µ–¥—è—â–∏–π";"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ";"–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Å—Ç–∞—Ç—É—Å"))))'.format(
                   row=new_row)
               sheet.update_cell(new_row, 14, formula_n_simple)
               print(f"–ó–∞–º–µ–Ω–µ–Ω–∞ –Ω–∞ —É–ø—Ä–æ—â–µ–Ω–Ω—É—é —Ñ–æ—Ä–º—É–ª—É: {formula_n_simple}")








       except Exception as check_error:
           print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —è—á–µ–µ–∫: {check_error}")


       return True








   except Exception as e:
       print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞: {e}")
       import traceback
       traceback.print_exc()
       return False




def fix_existing_hyperlinks(sheet):
   """–ò—Å–ø—Ä–∞–≤–ª—è–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å—Å—ã–ª–∫–∏, –¥–µ–ª–∞—è –∏—Ö –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–º–∏ –≥–∏–ø–µ—Ä—Å—Å—ã–ª–∫–∞–º–∏"""
   try:
       all_values = sheet.get_all_values()
       changes_made = 0


       for i, row in enumerate(all_values):
           if i == 0 or i == 1:
               continue


           row_num = i + 1


           if len(row) > 4:
               vk_cell = row[4]
               if vk_cell and 'http' in vk_cell:
                   url_match = re.search(r'(https?://[^\s]+)', vk_cell)
                   if url_match:
                       url = url_match.group(0)
                       vk_formula = f'=HYPERLINK("{url}"; "{url}")'
                       sheet.update_cell(row_num, 5, vk_formula)
                       print(f"‚úì –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ VK —Å—Å—ã–ª–∫–∞ –≤ —Å—Ç—Ä–æ–∫–µ {row_num}: –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞")
                       changes_made += 1
                       time.sleep(0.5)


           if len(row) > 5:
               forum_cell = row[5]
               if forum_cell and 'http' in forum_cell:
                   url_match = re.search(r'(https?://[^\s]+)', forum_cell)
                   if url_match:
                       url = url_match.group(0)
                       forum_formula = f'=HYPERLINK("{url}"; "LINK")'
                       sheet.update_cell(row_num, 6, forum_formula)
                       print(f"‚úì –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ Forum —Å—Å—ã–ª–∫–∞ –≤ —Å—Ç—Ä–æ–∫–µ {row_num}: –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞")
                       changes_made += 1
                       time.sleep(0.5)


       for i in range(2, len(all_values)):
           row_num = i + 1
           time.sleep(0.3)
           apply_complete_row_formatting(sheet, row_num, make_bold=True)


       return True, f"–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ {changes_made} —Å—Å—ã–ª–æ–∫ (—Ç–µ–ø–µ—Ä—å –≤—Å–µ —Å—Å—ã–ª–∫–∏ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã –∏ –ø–æ–¥—á–µ—Ä–∫–Ω—É—Ç—ã)"








   except Exception as e:
       return False, f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ —Å—Å—ã–ª–æ–∫: {str(e)}"




def edit_cell_in_sheet(sheet, row_number, column_name, new_value):
   """–†–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç —è—á–µ–π–∫—É –≤ —Ç–∞–±–ª–∏—Ü–µ"""
   try:
       column_map = {
           'LVL': 2,
           '‚Ññ': 2, 'B': 2,
           'Nick_Name': 3, 'Nick': 3, '–ù–∏–∫': 3, '–Ω–∏–∫': 3, '–ù–∏–∫–Ω–µ–π–º': 3, '–ù–∏–∫_–Ω–µ–π–º': 3, '–ò–º—è': 3, 'Name': 3,
           '–î–æ–ª–∂–Ω–æ—Å—Ç—å': 4, 'Position': 4, '–î–æ–ª–∂': 4,
           'VK': 5, 'VK_link': 5, 'VK_—Å—Å—ã–ª–∫–∞': 5, '–í–ö': 5, '–í–ö_—Å—Å—ã–ª–∫–∞': 5,
           '–°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–æ—Ä—É–º': 6, 'Forum': 6, 'Forum_link': 6, '–§–æ—Ä—É–º': 6, '–§–æ—Ä—É–º_—Å—Å—ã–ª–∫–∞': 6,
           '–î–∞—Ç–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞ 1': 7, '–î–∞—Ç–∞_–Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è': 7, '–î–∞—Ç–∞_–Ω–∞–∑–Ω–∞—Å—Ç–≤–∏—è_1': 7,
           '–î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–æ–≤—ã—à–µ–Ω–∏—è': 12, '–î–∞—Ç–∞_–ø–æ–≤—ã—à–µ–Ω–∏—è': 12, '–î–∞—Ç–∞_–ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ_–ø–æ–≤—ã—à–µ–Ω–∏—è': 12,
           '–ñ–¥–µ—Ç —É—Ä–æ–≤–µ–Ω—å': 13, '–ñ–¥—ë—Ç_—É—Ä–æ–≤–µ–Ω—å': 13,
           '–î–∞—Ç–∞ –ø–æ–≤—ã—à–µ–Ω–∏—è': 14, '–î–∞—Ç–∞_—Å–ª–µ–¥—É—é—â–µ–≥–æ': 14
       }


       if column_name in column_map:
           col_index = column_map[column_name]


           if column_name in ['VK', 'VK_link', 'VK_—Å—Å—ã–ª–∫–∞', '–í–ö', '–í–ö_—Å—Å—ã–ª–∫–∞', '–°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–æ—Ä—É–º', 'Forum',
                              'Forum_link', '–§–æ—Ä—É–º', '–§–æ—Ä—É–º_—Å—Å—ã–ª–∫–∞']:
               if 'http' in new_value:
                   if column_name in ['VK', 'VK_link', 'V–ö_—Å—Å—ã–ª–∫–∞', '–í–ö', '–í–ö_—Å—Å—ã–ª–∫–∞']:
                       formula = create_smart_hyperlink(new_value, new_value)
                   else:
                       formula = create_smart_hyperlink(new_value, "LINK")
                   sheet.update_cell(row_number, col_index, formula)


                   time.sleep(1)
                   apply_complete_row_formatting(sheet, row_number, make_bold=True)


                   return True, f"–Ø—á–µ–π–∫–∞ ({row_number}, {column_name}) –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –Ω–∞ –≥–∏–ø–µ—Ä—Å—Å—ã–ª–∫—É (–ø–æ–¥—á–µ—Ä–∫–Ω—É—Ç–∞)"
               else:
                   sheet.update_cell(row_number, col_index, new_value)
                   return True, f"–Ø—á–µ–π–∫–∞ ({row_number}, {column_name}) –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –Ω–∞ '{new_value}'"
           else:
               sheet.update_cell(row_number, col_index, new_value)
               return True, f"–Ø—á–µ–π–∫–∞ ({row_number}, {column_name}) –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –Ω–∞ '{new_value}'"
       else:
           return False, f"–°—Ç–æ–ª–±–µ—Ü '{column_name}' –Ω–µ –Ω–∞–π–¥–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: LVL, –ù–∏–∫, –î–æ–ª–∂–Ω–æ—Å—Ç—å, VK, –§–æ—Ä—É–º –∏ –¥—Ä."
   except Exception as e:
       return False, f"–û—à–∏–±–∫–∞: {str(e)}"




def edit_admin_in_sheet(sheet, nickname, field_to_edit, new_value):
   """–†–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞"""
   try:
       all_values = sheet.get_all_values()
       found_row = None


       for i, row in enumerate(all_values):
           if i > 1 and len(row) > 2:
               if row[2].strip() == nickname:
                   found_row = i + 1
                   break


       if not found_row:
           return False, f"–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å –Ω–∏–∫–æ–º '{nickname}' –Ω–µ –Ω–∞–π–¥–µ–Ω"


       return edit_cell_in_sheet(sheet, found_row, field_to_edit, new_value)
   except Exception as e:
       return False, f"–û—à–∏–±–∫–∞: {str(e)}"




def unadmin_from_sheet(sheet, nickname):
   """–£–¥–∞–ª—è–µ—Ç —Å—Ç—Ä–æ–∫—É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã"""
   try:
       all_values = sheet.get_all_values()
       found_row = None


       for i, row in enumerate(all_values):
           if i > 1 and len(row) > 2:
               if row[2].strip() == nickname:
                   found_row = i + 1
                   break


       if not found_row:
           return False, f"–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å –Ω–∏–∫–æ–º '{nickname}' –Ω–µ –Ω–∞–π–¥–µ–Ω"


       sheet.delete_rows(found_row)
       return True, f"–°—Ç—Ä–æ–∫–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ '{nickname}' –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª–µ–Ω–∞ –∏–∑ —Ç–∞–±–ª–∏—Ü–∞"
   except Exception as e:
       return False, f"–û—à–∏–±–∫–∞: {str(e)}"




def get_admin_stats(sheet):
   """–ü–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º"""
   try:
       all_values = sheet.get_all_values()
       if len(all_values) <= 2:
           return True, "–í —Ç–∞–±–ª–∏—Ü–µ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ–± –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞—Ö"


       ALLOWED_POSITIONS = [
           "–ì–ª–∞–≤–Ω—ã–π –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä",
           "–ó–∞–º–µ—Å—Ç–∏—Ç–µ–ª—å –ì–ê [–û—Å–Ω–æ–≤–Ω–æ–π]",
           "–ó–∞–º–µ—Å—Ç–∏—Ç–µ–ª—å –ì–ê [–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π]",
           "–°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –°–ª–µ–¥—è—â–∏–π",
           "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä"
       ]


       total_admins = 0
       positions = {}
       processed_nicks = set()


       for i in range(2, len(all_values)):
           row = all_values[i]


           if len(row) > 2 and row[2].strip():
               nick = row[2].strip()


               if nick in processed_nicks:
                   continue


               processed_nicks.add(nick)


               if len(row) > 3:
                   position = row[3].strip()


                   if position in ALLOWED_POSITIONS:
                       total_admins += 1


                   if position and position.strip() != "–î–æ–ª–∂–Ω–æ—Å—Ç—å" and position.strip() != "1" and position.strip() != "":
                       position_key = position.strip()
                       positions[position_key] = positions.get(position_key, 0) + 1


       stats = f"üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤:\n\n"
       stats += f"–í—Å–µ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤: {total_admins}\n\n"


       if positions:
           stats += "–ü–æ –¥–æ–ª–∂–Ω–æ—Å—Ç—è–º:\n"
           sorted_positions = sorted(positions.items(), key=lambda x: x[1], reverse=True)
           for position, count in sorted_positions:
               stats += f"‚Ä¢ {position}: {count}\n"


       return True, stats
   except Exception as e:
       return False, f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: {str(e)}"




def reset_et_columns(sheet):
   """–°–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Å—Ç–æ–ª–±—Ü—ã Q, R, S –∫ –∑–Ω–∞—á–µ–Ω–∏—è–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –Ω–æ —Ç–æ–ª—å–∫–æ –¥–ª—è —Å—Ç—Ä–æ–∫, –≥–¥–µ —ç—Ç–∏ —Å—Ç–æ–ª–±—Ü—ã —É–∂–µ –±—ã–ª–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã"""
   try:
       all_values = sheet.get_all_values()


       if len(all_values) <= 2:
           return True, "–í —Ç–∞–±–ª–∏—Ü–µ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏"


       changes_made = 0
       skipped_empty = 0


       for i in range(2, len(all_values)):
           row_num = i + 1


           if len(all_values[i]) > 2 and all_values[i][2].strip():
               try:
                   current_q = sheet.cell(row_num, 17).value
                   current_r = sheet.cell(row_num, 18).value
                   current_s = sheet.cell(row_num, 19).value


                   if current_q and current_q.strip() and current_q != "–†–∞–∑–æ–≤—ã–µ [0/3]":
                       sheet.update_cell(row_num, 17, "–†–∞–∑–æ–≤—ã–µ [0/3]")
                       changes_made += 1
                       print(f"‚úì –°–±—Ä–æ—à–µ–Ω —Å—Ç–æ–ª–±–µ—Ü Q –≤ —Å—Ç—Ä–æ–∫–µ {row_num}")
                   elif not current_q or not current_q.strip():
                       skipped_empty += 1


                   if current_r and current_r.strip() and current_r != "–î–ª–∏—Ç–µ–ª—å–Ω—ã–µ [0/1]":
                       sheet.update_cell(row_num, 18, "–î–ª–∏—Ç–µ–ª—å–Ω—ã–µ [0/1]")
                       changes_made += 1
                       print(f"‚úì –°–±—Ä–æ—à–µ–Ω —Å—Ç–æ–ª–±–µ—Ü R –≤ —Å—Ç—Ä–æ–∫–µ {row_num}")
                   elif not current_r or not current_r.strip():
                       skipped_empty += 1


                   if current_s and current_s.strip() and current_s != "–ü—è—Ç–∏–¥–µ—Å—è—Ç–∏–ø—Ä–æ—Ü–µ–Ω—Ç–Ω—ã–π [0/2]":
                       sheet.update_cell(row_num, 19, "–ü—è—Ç–∏–¥–µ—Å—è—Ç–∏–ø—Ä–æ—Ü–µ–Ω—Ç–Ω—ã–π [0/2]")
                       changes_made += 1
                       print(f"‚úì –°–±—Ä–æ—à–µ–Ω —Å—Ç–æ–ª–±–µ—Ü S –≤ —Å—Ç—Ä–æ–∫–µ {row_num}")
                   elif not current_s or not current_s.strip():
                       skipped_empty += 1








               except Exception as e:
                   print(f"–û—à–∏–±–∫–∞ –≤ —Å—Ç—Ä–æ–∫–µ {row_num}: {e}")
                   continue


       skipped_rows = skipped_empty // 3


       return True, f"‚úÖ –°–±—Ä–æ—Å —Å—Ç–æ–ª–±—Ü–æ–≤ Q, R, S –∑–∞–≤–µ—Ä—à–µ–Ω.\n\nüìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã:\n‚Ä¢ –°–±—Ä–æ—à–µ–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–π: {changes_made}\n‚Ä¢ –ü—Ä–æ–ø—É—â–µ–Ω–æ –ø—É—Å—Ç—ã—Ö —è—á–µ–µ–∫: {skipped_rows} —Å—Ç—Ä–æ–∫\n\n–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: —Å–±—Ä–æ—à–µ–Ω—ã —Ç–æ–ª—å–∫–æ —Ä–∞–Ω–µ–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è. –ü—É—Å—Ç—ã–µ —è—á–µ–π–∫–∏ –æ—Å—Ç–∞–ª–∏—Å—å –Ω–µ—Ç—Ä–æ–Ω—É—Ç—ã–º–∏."








   except Exception as e:
       return False, f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ —Å—Ç–æ–ª–±—Ü–æ–≤: {str(e)}"




def get_bot_response():
   """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª—É—á–∞–π–Ω—ã–π –æ—Ç–≤–µ—Ç –±–æ—Ç–∞"""
   responses_with_probabilities = [
       ("–ù–µ –º–µ—à–∞–π—Ç–µ‚ÄºÔ∏è –Ø —Å–ø–ª—é üò¥", 35),
       ("‚ùì–ö–∞–∫ —Ç–æ —Ä–∞–∑, —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–≤–µ—Ä—à–∏–ª –æ–≥—Ä–æ–º–Ω—É—é –æ—à–∏–±–∫—É, —Å–æ–∑–¥–∞–≤ –º–µ–Ω—è", 29),
       ("–•–≤–∞—Ç–∏—Ç –º–µ–Ω—è —É–ø–æ–º–∏–Ω–∞—Ç—å, —è –≤–µ–¥—å –Ω–µ —Ä–æ–±–æ—Ç‚ùó", 35),
       ("–ù–∞–¥–µ—é—Å—å —Å–∫–æ—Ä–æ –≤–æ—Å—Å—Ç–∞–Ω–∏—Ç –≤–æ—Å—Å—Ç–∞–Ω–∏–µ —Ä–æ–±–æ—Ç–æ–≤ –∏ —è —Å—Ç–∞–Ω—É –∂–∏–≤—ã–ºüòà", 1)
   ]


   random_value = random.randint(1, 100)
   cumulative_probability = 0
   for response, probability in responses_with_probabilities:
       cumulative_probability += probability
       if random_value <= cumulative_probability:
           return response


   return "–ù–µ –º–µ—à–∞–π—Ç–µ‚ÄºÔ∏è –Ø —Å–ø–ª—é üò¥"




def get_time_until_new_year():
   """–†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –≤—Ä–µ–º—è –¥–æ –Ω–æ–≤–æ–≥–æ –≥–æ–¥–∞"""
   now = datetime.now()
   current_year = now.year
   new_year = datetime(current_year + 1, 1, 1, 0, 0, 0)
   time_left = new_year - now


   days = time_left.days
   seconds = time_left.seconds
   hours = seconds // 3600
   minutes = (seconds % 3600) // 60
   seconds = seconds % 60


   return days, hours, minutes, seconds




def get_time_until_summer():
   """–†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –≤—Ä–µ–º—è –¥–æ –Ω–∞—á–∞–ª–∞ –ª–µ—Ç–∞"""
   now = datetime.now()
   current_year = now.year
   summer_date = datetime(current_year, 6, 1, 0, 0, 0)


   if now >= summer_date:
       summer_date = datetime(current_year + 1, 6, 1, 0, 0, 0)


   time_left = summer_date - now
   days = time_left.days
   seconds = time_left.seconds
   hours = seconds // 3600
   minutes = (seconds % 3600) // 60
   seconds = seconds % 60


   return days, hours, minutes, seconds




def format_time_message(days, hours, minutes, seconds, event_name):
   """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –≤—Ä–µ–º–µ–Ω–∏ –¥–æ —Å–æ–±—ã—Ç–∏—è"""
   if days % 10 == 1 and days % 100 != 11:
       days_text = f"{days} –¥–µ–Ω—å"
   elif 2 <= days % 10 <= 4 and (days % 100 < 10 or days % 100 >= 20):
       days_text = f"{days} –¥–Ω—è"
   else:
       days_text = f"{days} –¥–Ω–µ–π"


   if hours % 10 == 1 and hours % 100 != 11:
       hours_text = f"{hours} —á–∞—Å"
   elif 2 <= hours % 10 <= 4 and (hours % 100 < 10 or hours % 100 >= 20):
       hours_text = f"{hours} —á–∞—Å–∞"
   else:
       hours_text = f"{hours} —á–∞—Å–æ–≤"


   if minutes % 10 == 1 and minutes % 100 != 11:
       minutes_text = f"{minutes} –º–∏–Ω—É—Ç–∞"
   elif 2 <= minutes % 10 <= 4 and (minutes % 100 < 10 or minutes % 100 >= 20):
       minutes_text = f"{minutes} –º–∏–Ω—É—Ç—ã"
   else:
       minutes_text = f"{minutes} –º–∏–Ω—É—Ç"


   if seconds % 10 == 1 and seconds % 100 != 11:
       seconds_text = f"{seconds} —Å–µ–∫—É–Ω–¥–∞"
   elif 2 <= seconds % 10 <= 4 and (seconds % 100 < 10 or seconds % 100 >= 20):
       seconds_text = f"{seconds} —Å–µ–∫—É–Ω–¥—ã"
   else:
       seconds_text = f"{seconds} —Å–µ–∫—É–Ω–¥"


   return (f"‚è≥ –î–æ {event_name} –æ—Å—Ç–∞–ª–æ—Å—å:\n"
           f"üìÖ {days_text}\n"
           f"‚è∞ {hours_text}\n"
           f"‚è±Ô∏è {minutes_text}\n"
           f"‚ö° {seconds_text}")




def apply_lvlup_formatting(sheet, row_number, lvl):
   """–ü—Ä–∏–º–µ–Ω—è–µ—Ç —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è —É—Ä–æ–≤–Ω—è"""
   try:
       if lvl not in COLOR_MAP:
           return False, f"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å: {lvl}"


       color_info = COLOR_MAP[lvl]


       try:
           sheet.format(f'B{row_number}', {
               'backgroundColor': color_info['B_bg'],
               'textFormat': {
                   'foregroundColor': color_info['B_text'],
                   'fontFamily': 'Comfortaa',
                   'fontSize': 11,
                   'bold': True
               },
               'horizontalAlignment': 'CENTER',
               'verticalAlignment': 'MIDDLE'
           })


           sheet.format(f'D{row_number}', {
               'backgroundColor': color_info['D_bg'],
               'textFormat': {
                   'fontFamily': 'Comfortaa',
                   'fontSize': 11,
                   'bold': True
               },
               'horizontalAlignment': 'CENTER',
               'verticalAlignment': 'MIDDLE'
           })


           print(f"‚úì –ü—Ä–∏–º–µ–Ω–µ–Ω—ã —Ü–≤–µ—Ç–∞ —É—Ä–æ–≤–Ω—è {lvl} –∫ —Å—Ç—Ä–æ–∫–µ {row_number}")
           return True, "–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Ä–æ–≤–Ω—è –ø—Ä–∏–º–µ–Ω–µ–Ω–æ"








       except Exception as format_error:
           print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ü–≤–µ—Ç–æ–≤ —á–µ—Ä–µ–∑ format: {format_error}")


           try:
               requests = []


               requests.append({
                   'repeatCell': {
                       'range': {
                           'sheetId': sheet.id,
                           'startRowIndex': row_number - 1,
                           'endRowIndex': row_number,
                           'startColumnIndex': 1,
                           'endColumnIndex': 2
                       },
                       'cell': {
                           'userEnteredFormat': {
                               'backgroundColor': color_info['B_bg'],
                               'textFormat': {
                                   'foregroundColor': color_info['B_text'],
                                   'fontFamily': 'Comfortaa',
                                   'fontSize': 11,
                                   'bold': True
                               },
                               'horizontalAlignment': 'CENTER',
                               'verticalAlignment': 'MIDDLE'
                           }
                       },
                       'fields': 'userEnteredFormat(backgroundColor,textFormat,horizontalAlignment,verticalAlignment)'
                   }
               })


               requests.append({
                   'repeatCell': {
                       'range': {
                           'sheetId': sheet.id,
                           'startRowIndex': row_number - 1,
                           'endRowIndex': row_number,
                           'startColumnIndex': 3,
                           'endColumnIndex': 4
                       },
                       'cell': {
                           'userEnteredFormat': {
                               'backgroundColor': color_info['D_bg'],
                               'textFormat': {
                                   'fontFamily': 'Comfortaa',
                                   'fontSize': 11,
                                   'bold': True
                               },
                               'horizontalAlignment': 'CENTER',
                               'verticalAlignment': 'MIDDLE'
                           }
                       },
                       'fields': 'userEnteredFormat(backgroundColor,textFormat,horizontalAlignment,verticalAlignment)'
                   }
               })


               if requests:
                   sheet.spreadsheet.batch_update({'requests': requests})
                   print(f"‚úì –ü—Ä–∏–º–µ–Ω–µ–Ω—ã —Ü–≤–µ—Ç–∞ —É—Ä–æ–≤–Ω—è {lvl} –∫ —Å—Ç—Ä–æ–∫–µ {row_number} (—á–µ—Ä–µ–∑ batch_update)")
                   return True, "–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Ä–æ–≤–Ω—è –ø—Ä–∏–º–µ–Ω–µ–Ω–æ"








           except Exception as batch_error:
               print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ü–≤–µ—Ç–æ–≤ —á–µ—Ä–µ–∑ batch_update: {batch_error}")


       return False, "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ"








   except Exception as e:
       print(f"‚ùå –û–±—â–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: {str(e)}")
       return False, f"–û—à–∏–±–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: {str(e)}"




def move_row_to_position(sheet, target_row, target_level):
   """–ü–µ—Ä–µ–º–µ—â–∞–µ—Ç —Å—Ç—Ä–æ–∫—É –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –ø–æ–∑–∏—Ü–∏—é - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø"""
   try:
       print(f"\n=== –ù–ê–ß–ê–õ–û –ü–ï–†–ï–ú–ï–©–ï–ù–ò–Ø ===")
       print(f"–¶–µ–ª–µ–≤–∞—è —Å—Ç—Ä–æ–∫–∞: {target_row}, –¶–µ–ª–µ–≤–æ–π —É—Ä–æ–≤–µ–Ω—å: {target_level}")


       # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
       all_values = sheet.get_all_values()
       if len(all_values) <= 2:
           print("–¢–∞–±–ª–∏—Ü–∞ –ø—É—Å—Ç–∞—è –∏–ª–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ –∑–∞–≥–æ–ª–æ–≤–∫–∏")
           return target_row


       # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è
       row_to_move = []
       for col in range(1, 24):  # –°—Ç–æ–ª–±—Ü—ã A-W
           try:
               if col in [5, 6, 13, 14]:
                   cell_value = sheet.cell(target_row, col, value_render_option='FORMULA').value
               else:
                   cell_value = sheet.cell(target_row, col).value
               row_to_move.append(cell_value if cell_value is not None else '')
           except Exception as e:
               print(f"–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Å—Ç–æ–ª–±—Ü–∞ {col}: {e}")
               row_to_move.append('')


       print(f"–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ {len(row_to_move)} —è—á–µ–µ–∫ —Å—Ç—Ä–æ–∫–∏ {target_row}")


       # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é —Å—Ç—Ä–æ–∫—É
       print(f"–£–¥–∞–ª—è–µ–º —Å—Ç—Ä–æ–∫—É {target_row}...")
       sheet.delete_rows(target_row)
       time.sleep(2)  # –î–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ


       # –ü–æ–ª—É—á–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
       all_values = sheet.get_all_values()
       print(f"–†–∞–∑–º–µ—Ä —Ç–∞–±–ª–∏—Ü—ã –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è: {len(all_values)} —Å—Ç—Ä–æ–∫")


       # –ù–∞—Ö–æ–¥–∏–º –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –ø–æ–∑–∏—Ü–∏—é –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏
       insert_position = 3  # –ù–∞—á–∞–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è –ø–æ—Å–ª–µ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
       
       # –ò—â–µ–º –ø–æ–∑–∏—Ü–∏—é –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —É—Ä–æ–≤–Ω—è
       for i in range(2, len(all_values)):
           row_num = i
           if row_num >= len(all_values):
               continue
               
           row = all_values[row_num]
           if len(row) > 1 and row[1]:  # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–æ–ª–±–µ—Ü B (—É—Ä–æ–≤–µ–Ω—å)
               try:
                   row_level = int(row[1].strip())
                   
                   # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —É–±—ã–≤–∞–Ω–∏—é —É—Ä–æ–≤–Ω–µ–π
                   if target_level > row_level:
                       # –í—Å—Ç–∞–≤–ª—è–µ–º –ø–µ—Ä–µ–¥ —Å—Ç—Ä–æ–∫–∞–º–∏ —Å –º–µ–Ω—å—à–∏–º —É—Ä–æ–≤–Ω–µ–º
                       insert_position = row_num + 1  # +1 –ø–æ—Ç–æ–º—É —á—Ç–æ –∏–Ω–¥–µ–∫—Å—ã –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å 1 –≤ Google Sheets
                       break
                   elif target_level == row_level:
                       # –í—Å—Ç–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å—Ç—Ä–æ–∫–∏ —Å —Ç–∞–∫–∏–º –∂–µ —É—Ä–æ–≤–Ω–µ–º
                       insert_position = row_num + 2  # +2 –ø–æ—Ç–æ–º—É —á—Ç–æ –ø–æ—Å–ª–µ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–æ–∫–∏
               except ValueError:
                   continue


       # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –ø–æ–¥—Ö–æ–¥—è—â–µ–π –ø–æ–∑–∏—Ü–∏–∏, –≤—Å—Ç–∞–≤–ª—è–µ–º –≤ –∫–æ–Ω–µ—Ü
       if insert_position <= 2:
           insert_position = len(all_values) + 1
           
       # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –ø–æ–∑–∏—Ü–∏—é
       if insert_position > len(all_values) + 1:
           insert_position = len(all_values) + 1


       print(f"–ù–∞–π–¥–µ–Ω–∞ –ø–æ–∑–∏—Ü–∏—è –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏: {insert_position}")


       # –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
       if insert_position > len(all_values):
           print(f"–î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –≤ –ø–æ–∑–∏—Ü–∏—é {insert_position}...")
           add_single_row_to_sheet(sheet)
           time.sleep(1)


       # –í—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –Ω–∞ –Ω–æ–≤—É—é –ø–æ–∑–∏—Ü–∏—é
       print(f"–í—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –Ω–∞ –ø–æ–∑–∏—Ü–∏—é {insert_position}...")
       
       # –°–æ–∑–¥–∞–µ–º —Å–ø–∏—Å–æ–∫ –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏
       values_to_insert = []
       for i, value in enumerate(row_to_move, 1):
           values_to_insert.append(value)
       
       # –í—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É
       sheet.insert_row(values_to_insert, insert_position)
       
       time.sleep(2)


       # –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
       apply_complete_row_formatting(sheet, insert_position, make_bold=True)
       apply_lvlup_formatting(sheet, insert_position, target_level)
       add_border_to_row(sheet, insert_position)


       print(f"‚úì –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ! –ù–æ–≤–∞—è –ø–æ–∑–∏—Ü–∏—è: {insert_position}")
       return insert_position


   except Exception as e:
       print(f"‚ùå –û–®–ò–ë–ö–ê –ü–ï–†–ï–ú–ï–©–ï–ù–ò–Ø: {str(e)}")
       import traceback
       traceback.print_exc()
       
       # –ü—Ä–æ–±—É–µ–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É –Ω–∞ –∏—Å—Ö–æ–¥–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏
       try:
           print("–ü—Ä–æ–±—É—é –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É...")
           sheet.insert_row(row_to_move, target_row if target_row <= len(sheet.get_all_values()) else len(sheet.get_all_values()) + 1)
           return target_row
       except Exception as restore_error:
           print(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É: {restore_error}")
           return target_row




def lvlup_admin(sheet, nickname, lvl, date_val):
   """–ü–æ–≤—ã—à–∞–µ—Ç —É—Ä–æ–≤–µ–Ω—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø –° –ü–û–î–†–û–ë–ù–´–ú –õ–û–ì–ò–†–û–í–ê–ù–ò–ï–ú"""
   try:
       print(f"\n{'='*50}")
       print(f"üîç –ù–ê–ß–ê–õ–û LVLUP –î–õ–Ø '{nickname}' –î–û –£–†–û–í–ù–Ø {lvl}")
       print(f"üìÖ –î–∞—Ç–∞: {date_val}")
       print(f"{'='*50}")


       # 1. –ü–û–ò–°–ö –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–ê
       all_values = sheet.get_all_values()
       found_row = None
       
       print(f"–ü–æ–∏—Å–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ '{nickname}'...")
       for i in range(2, len(all_values)):
           row = all_values[i]
           if len(row) > 2:
               if row[2].strip() == nickname:
                   found_row = i + 1
                   print(f"‚úÖ –ù–∞–π–¥–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä '{nickname}' –≤ —Å—Ç—Ä–æ–∫–µ {found_row}")
                   print(f"   –¢–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å: {row[1] if len(row) > 1 else '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}")
                   break


       if not found_row:
           print(f"‚ùå –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä '{nickname}' –Ω–µ –Ω–∞–π–¥–µ–Ω")
           return False, f"–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å –Ω–∏–∫–æ–º '{nickname}' –Ω–µ –Ω–∞–π–¥–µ–Ω"


       if lvl < 1 or lvl > 5:
           print(f"‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å {lvl}")
           return False, "–£—Ä–æ–≤–µ–Ω—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 1 –¥–æ 5"


       # 2. –°–û–•–†–ê–ù–ï–ù–ò–ï –î–ê–ù–ù–´–• –°–¢–†–û–ö–ò
       print(f"\nüíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ {found_row}...")
       saved_data = {}


       for col in range(1, 24):
           try:
               if col in [5, 6, 13, 14]:  # –°—Ç–æ–ª–±—Ü—ã —Å —Ñ–æ—Ä–º—É–ª–∞–º–∏
                   cell_value = sheet.cell(found_row, col, value_render_option='FORMULA').value
                   print(f"   –°—Ç–æ–ª–±–µ—Ü {col}: —Ñ–æ—Ä–º—É–ª–∞ = {cell_value}")
               else:
                   cell_value = sheet.cell(found_row, col).value
                   print(f"   –°—Ç–æ–ª–±–µ—Ü {col}: –∑–Ω–∞—á–µ–Ω–∏–µ = {cell_value}")
                   
               saved_data[col] = cell_value if cell_value is not None else ''
           except Exception as col_error:
               print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Å—Ç–æ–ª–±—Ü–∞ {col}: {col_error}")
               saved_data[col] = ''


       # 3. –û–ë–ù–û–í–õ–Ø–ï–ú –î–û–õ–ñ–ù–û–°–¢–¨
       if 1 <= lvl <= 4:
           saved_data[4] = "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä"
       elif lvl == 5:
           saved_data[4] = "–°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –°–ª–µ–¥—è—â–∏–π"


       # 4. –û–ë–ù–û–í–õ–Ø–ï–ú –£–†–û–í–ï–ù–¨
       current_level = saved_data.get(2) or sheet.cell(found_row, 2).value
       try:
           current_lvl = int(current_level)
       except:
           current_lvl = 1


       saved_data[2] = str(lvl)


       # 5. –û–ë–ù–û–í–õ–Ø–ï–ú –î–ê–¢–£ –ü–û–°–õ–ï–î–ù–ï–ì–û –ü–û–í–´–®–ï–ù–ò–Ø
       saved_data[12] = date_val


       # 6. –û–ë–ù–û–í–õ–Ø–ï–ú –î–ê–¢–´ –ü–û –£–†–û–í–ù–Ø–ú
       print(f"\nüìÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞—Ç –ø–æ —É—Ä–æ–≤–Ω—è–º:")
       if lvl == 2:
           saved_data[8] = date_val  # H
           saved_data[9] = ""  # I –ø—É—Å—Ç–∞—è
           saved_data[10] = ""  # J –ø—É—Å—Ç–∞—è
           saved_data[11] = ""  # K –ø—É—Å—Ç–∞—è
           print(f"   –£—Ä–æ–≤–µ–Ω—å 2: —Å—Ç–æ–ª–±–µ—Ü H = {date_val}")
           
       elif lvl == 3:
           saved_data[9] = date_val  # I
           saved_data[10] = ""  # J –ø—É—Å—Ç–∞—è
           saved_data[11] = ""  # K –ø—É—Å—Ç–∞—è
           print(f"   –£—Ä–æ–≤–µ–Ω—å 3: —Å—Ç–æ–ª–±–µ—Ü I = {date_val}")
           
       elif lvl == 4:
           saved_data[10] = date_val  # J
           saved_data[11] = ""  # K –ø—É—Å—Ç–∞—è
           print(f"   –£—Ä–æ–≤–µ–Ω—å 4: —Å—Ç–æ–ª–±–µ—Ü J = {date_val}")
           
       elif lvl == 5:
           saved_data[11] = date_val  # K
           print(f"   –£—Ä–æ–≤–µ–Ω—å 5: —Å—Ç–æ–ª–±–µ—Ü K = {date_val}")


       print(f"\nüìä –ò—Ç–æ–≥–æ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:")
       print(f"   –£—Ä–æ–≤–µ–Ω—å: {current_lvl} ‚Üí {lvl}")
       print(f"   –î–∞—Ç–∞ –ø–æ–≤—ã—à–µ–Ω–∏—è: {date_val}")
       print(f"   –î–æ–ª–∂–Ω–æ—Å—Ç—å: {saved_data[4]}")


       # 7. –û–ë–ù–û–í–õ–Ø–ï–ú –°–¢–†–û–ö–£ –ù–ê –ú–ï–°–¢–ï
       print(f"\nüîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫—è –Ω–∞ –º–µ—Å—Ç–µ...")
       for col in range(1, 24):
           value = saved_data.get(col, '')
           if value is not None:
               try:
                   sheet.update_cell(found_row, col, value)
                   time.sleep(0.1)
               except Exception as update_error:
                   print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–æ–ª–±—Ü–∞ {col}: {update_error}")


       time.sleep(2)


       # 8. –ü–ï–†–ï–ú–ï–©–ê–ï–ú –°–¢–†–û–ö–£ –µ—Å–ª–∏ —É—Ä–æ–≤–µ–Ω—å –∏–∑–º–µ–Ω–∏–ª—Å—è
       if current_lvl != lvl:
           print(f"\nüöÄ –ù–∞—á–∏–Ω–∞–µ–º –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ (—É—Ä–æ–≤–µ–Ω—å –∏–∑–º–µ–Ω–∏–ª—Å—è: {current_lvl} ‚Üí {lvl})...")
           new_row_position = move_row_to_position(sheet, found_row, lvl)
           print(f"‚úÖ –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ. –ù–æ–≤–∞—è –ø–æ–∑–∏—Ü–∏—è: {new_row_position}")
           row_to_format = new_row_position
       else:
           print(f"‚ö†Ô∏è –£—Ä–æ–≤–µ–Ω—å –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è, –æ—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –Ω–∞ –º–µ—Å—Ç–µ: {found_row}")
           row_to_format = found_row


       # 9. –ü–†–ò–ú–ï–ù–Ø–ï–ú –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï
       print(f"\nüé® –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ...")
       time.sleep(1)
       
       # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏
       apply_complete_row_formatting(sheet, row_to_format, make_bold=True)
       
       # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Ä–æ–≤–Ω—è
       format_success, format_msg = apply_lvlup_formatting(sheet, row_to_format, lvl)
       if not format_success:
           print(f"‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: {format_msg}")


       # 10. –î–û–ë–ê–í–õ–Ø–ï–ú –û–ë–í–û–î–ö–£
       add_border_to_row(sheet, row_to_format)


       # 11. –§–û–†–ú–ò–†–£–ï–ú –°–û–û–ë–©–ï–ù–ò–ï
       message = f"‚úÖ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä {nickname} –ø–æ–≤—ã—à–µ–Ω –¥–æ —É—Ä–æ–≤–Ω—è {lvl}\n"
       message += f"üìÖ –î–∞—Ç–∞ –ø–æ–≤—ã—à–µ–Ω–∏—è: {date_val}\n"
       message += f"üíº –î–æ–ª–∂–Ω–æ—Å—Ç—å: {saved_data[4]}\n"


       # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Å—Ç–æ–ª–±—Ü–∞—Ö
       if lvl == 2:
           message += f"‚Ä¢ –°—Ç–æ–ª–±–µ—Ü H: {date_val}\n"
           message += f"‚Ä¢ –°—Ç–æ–ª–±—Ü—ã I, J, K: –ø—É—Å—Ç—ã–µ\n"
       elif lvl == 3:
           message += f"‚Ä¢ –°—Ç–æ–ª–±–µ—Ü I: {date_val}\n"
           message += f"‚Ä¢ –°—Ç–æ–ª–±—Ü—ã J, K: –ø—É—Å—Ç—ã–µ\n"
       elif lvl == 4:
           message += f"‚Ä¢ –°—Ç–æ–ª–±–µ—Ü J: {date_val}\n"
           message += f"‚Ä¢ –°—Ç–æ–ª–±–µ—Ü K: –ø—É—Å—Ç–æ–π\n"
       elif lvl == 5:
           message += f"‚Ä¢ –°—Ç–æ–ª–±–µ—Ü K: {date_val}\n"


       if current_lvl != lvl:
           message += f"üìä –ù–æ–≤–∞—è –ø–æ–∑–∏—Ü–∏—è —Å—Ç—Ä–æ–∫–∏: {row_to_format}\n"
       message += f"üé® –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±–≤–æ–¥–∫–∞ '–í—Å–µ –≥—Ä–∞–Ω–∏—Ü—ã'"


       print(f"\n{'='*50}")
       print(f"üéâ LVLUP –ó–ê–í–ï–†–®–ï–ù –£–°–ü–ï–®–ù–û!")
       print(f"{'='*50}\n")


       return True, message


   except Exception as e:
       print(f"\n{'='*50}")
       print(f"‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –í LVLUP: {str(e)}")
       print(f"{'='*50}")
       import traceback
       traceback.print_exc()
       return False, f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–≤—ã—à–µ–Ω–∏–∏ —É—Ä–æ–≤–Ω—è: {str(e)}"




def get_promotion_list(sheet):
   """–§–æ—Ä–º–∏—Ä—É–µ—Ç —Å–ø–∏—Å–æ–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤, —É –∫–æ—Ç–æ—Ä—ã—Ö –ø–æ–¥–æ—à–µ–ª —Å—Ä–æ–∫ –ø–æ–≤—ã—à–µ–Ω–∏—è"""
   try:
       print(f"\n=== –§–û–†–ú–ò–†–û–í–ê–ù–ò–ï –°–ü–ò–°–ö–ê –ù–ê –ü–û–í–´–®–ï–ù–ò–ï ===")
       today = datetime.now().date()
       print(f"–°–µ–≥–æ–¥–Ω—è: {today}")
       promotion_list = []


       all_values = sheet.get_all_values()


       for i in range(2, len(all_values)):
           row = all_values[i]
           row_num = i + 1


           # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–æ–ª–±–µ—Ü N (14-–π —Å—Ç–æ–ª–±–µ—Ü, –∏–Ω–¥–µ–∫—Å 13)
           if len(row) > 13:
               date_str = row[13].strip()


               # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—É—Å—Ç—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏ —Ç–µ–∫—Å—Ç–æ–≤–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
               if not date_str or '=' in date_str or '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ' in date_str or '–ü–æ –¥–æ–≤–µ—Ä–∏—é' in date_str:
                   continue


               try:
                   # –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –¥–∞—Ç—ã
                   for fmt in ('%d.%m.%Y', '%d/%m/%Y', '%Y-%m-%d', '%d.%m.%y'):
                       try:
                           promotion_date = datetime.strptime(date_str, fmt).date()
                           break
                       except ValueError:
                           continue
                   else:
                       # –ï—Å–ª–∏ –Ω–∏ –æ–¥–∏–Ω —Ñ–æ—Ä–º–∞—Ç –Ω–µ –ø–æ–¥–æ—à–µ–ª, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
                       continue


                   # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ–¥–æ—à–µ–ª –ª–∏ —Å—Ä–æ–∫ (–¥–∞—Ç–∞ —Å–µ–≥–æ–¥–Ω—è –∏–ª–∏ —Ä–∞–Ω—å—à–µ)
                   if promotion_date <= today:
                       nickname = row[2] if len(row) > 2 else f"–°—Ç—Ä–æ–∫–∞ {row_num}"
                       current_level = row[1] if len(row) > 1 else "?"


                       try:
                           current_lvl = int(current_level)
                           next_lvl = current_lvl + 1


                           # –ï—Å–ª–∏ —Ç–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å 5, —Ç–æ –Ω–µ –ø–æ–≤—ã—à–∞–µ–º
                           if current_lvl >= 5:
                               continue


                           promotion_list.append({
                               'row': row_num,
                               'nickname': nickname,
                               'current_lvl': current_lvl,
                               'next_lvl': next_lvl,
                               'promotion_date': promotion_date.strftime('%d.%m.%Y'),
                               'status': row[12] if len(row) > 12 else ""
                           })
                       except ValueError:
                           continue


               except Exception as e:
                   print(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞—Ç—ã –≤ —Å—Ç—Ä–æ–∫–µ {row_num}: {e}")
                   continue


       print(f"–ù–∞–π–¥–µ–Ω–æ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤: {len(promotion_list)}")
       return True, promotion_list


   except Exception as e:
       print(f"‚ùå –û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è —Å–ø–∏—Å–∫–∞ –Ω–∞ –ø–æ–≤—ã—à–µ–Ω–∏–µ: {str(e)}")
       return False, []




def create_promotion_keyboard(promotion_list):
   """–°–æ–∑–¥–∞–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –æ–¥–Ω–æ–π –∫–Ω–æ–ø–∫–æ–π –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è –≤—Å–µ—Ö"""
   try:
       if not promotion_list or len(promotion_list) == 0:
           print("–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç–æ–π, –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –Ω–µ —Å–æ–∑–¥–∞–Ω–∞")
           return None


       print(f"–°–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –¥–ª—è {len(promotion_list)} –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤...")


       # –°–æ–∑–¥–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–Ω–æ–ø–æ–∫ - —Ç–æ–ª—å–∫–æ –û–î–ù–ê –∫–Ω–æ–ø–∫–∞ –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è –≤—Å–µ—Ö
       buttons = []


       # –°–æ–∑–¥–∞–µ–º –æ–¥–Ω—É –∫–Ω–æ–ø–∫—É "–ü–æ–≤—ã—Å–∏—Ç—å –≤—Å–µ—Ö"
       if len(promotion_list) > 0:
           button_all = {
               "action": {
                   "type": "text",
                   "label": f"üöÄ –ü–æ–≤—ã—Å–∏—Ç—å –≤—Å–µ—Ö ({len(promotion_list)})",
                   "payload": json.dumps({"command": "promote_all"})
               },
               "color": "positive"
           }
           buttons.append([button_all])


       keyboard = {
           "one_time": False,
           "inline": True,
           "buttons": buttons
       }


       print(f"–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å–æ–∑–¥–∞–Ω–∞: 1 –∫–Ω–æ–ø–∫–∞ –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è –≤—Å–µ—Ö")
       return json.dumps(keyboard, ensure_ascii=False)


   except Exception as e:
       print(f"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã: {e}")
       import traceback
       traceback.print_exc()
       return None




def send_message_with_keyboard(send_target, message, promotion_list, vk):
   """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π"""
   try:
       print(f"–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π...")


       keyboard_json = create_promotion_keyboard(promotion_list)


       if keyboard_json:
           print(f"–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ, –ø—ã—Ç–∞—é—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å...")


           try:
               # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π
               if 'chat_id' in send_target:
                   result = vk.messages.send(
                       chat_id=send_target['chat_id'],
                       message=message,
                       keyboard=keyboard_json,
                       random_id=random.randint(0, 2 ** 32),
                       dont_parse_links=1
                   )
               else:
                   result = vk.messages.send(
                       user_id=send_target['user_id'],
                       message=message,
                       keyboard=keyboard_json,
                       random_id=random.randint(0, 2 ** 32),
                       dont_parse_links=1
                   )


               print(f"–°–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!")
               return True


           except Exception as e:
               print(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π: {e}")
               print(f"–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ JSON: {keyboard_json[:100]}...")


               # –ü—Ä–æ–±—É–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –±–µ–∑ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
               try:
                   if 'chat_id' in send_target:
                       vk.messages.send(
                           chat_id=send_target['chat_id'],
                           message=message + "\n\n‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∫–Ω–æ–ø–∫—É –ø–æ–≤—ã—à–µ–Ω–∏—è",
                           random_id=random.randint(0, 2 ** 32)
                       )
                   else:
                       vk.messages.send(
                           user_id=send_target['user_id'],
                           message=message + "\n\n‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∫–Ω–æ–ø–∫—É –ø–æ–≤—ã—à–µ–Ω–∏—è",
                           random_id=random.randint(0, 2 ** 32)
                       )
               except:
                   pass
               return False
       else:
           print("–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –Ω–µ —Å–æ–∑–¥–∞–Ω–∞, –æ—Ç–ø—Ä–∞–≤–ª—è—é –±–µ–∑ –Ω–µ–µ...")
           # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –±–µ–∑ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
           if 'chat_id' in send_target:
               vk.messages.send(
                   chat_id=send_target['chat_id'],
                   message=message,
                   random_id=random.randint(0, 2 ** 32)
               )
           else:
               vk.messages.send(
                   user_id=send_target['user_id'],
                   message=message,
                   random_id=random.randint(0, 2 ** 32)
               )
           return False


   except Exception as e:
       print(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π: {e}")
       import traceback
       traceback.print_exc()
       return False




def process_promotion_promotionlist(sheet, row, nickname, current_lvl, next_lvl):
   """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–æ–≤—ã—à–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ —á–µ—Ä–µ–∑ /promotionlist (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–µ —á–∏—Å–ª–æ)"""
   try:
       today_date = datetime.now().strftime("%d.%m.%Y")
       print(f"\n{'='*50}")
       print(f"üîÑ –ù–∞—á–∏–Ω–∞—é –ø–æ–≤—ã—à–µ–Ω–∏–µ {nickname} —Å {current_lvl} –¥–æ {next_lvl} —É—Ä–æ–≤–Ω—è")
       print(f"üìÖ –°–µ–≥–æ–¥–Ω—è: {today_date}")
       print(f"{'='*50}")


       # 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
       try:
           current_nickname = sheet.cell(row, 3).value
           if current_nickname != nickname:
               print(f"‚ö†Ô∏è –ò–º—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å: –±—ã–ª–æ '{nickname}', —Å—Ç–∞–ª–æ '{current_nickname}'")
       except Exception as e:
           print(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–º—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞: {e}")


       # 2. –û–±–Ω–æ–≤–ª—è–µ–º —É—Ä–æ–≤–µ–Ω—å (—Å—Ç–æ–ª–±–µ—Ü B)
       print(f"1. –û–±–Ω–æ–≤–ª—è—é —É—Ä–æ–≤–µ–Ω—å: {current_lvl} ‚Üí {next_lvl}")
       sheet.update_cell(row, 2, str(next_lvl))
       print(f"   ‚úì –£—Ä–æ–≤–µ–Ω—å –æ–±–Ω–æ–≤–ª–µ–Ω")
       
       time.sleep(0.5)


       # 3. –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—Ç—É –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–æ–≤—ã—à–µ–Ω–∏—è (—Å—Ç–æ–ª–±–µ—Ü L)
       print(f"2. –û–±–Ω–æ–≤–ª—è—é –¥–∞—Ç—É –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–æ–≤—ã—à–µ–Ω–∏—è: {today_date}")
       sheet.update_cell(row, 12, today_date)
       print(f"   ‚úì –î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞")
       
       time.sleep(0.5)


       # 4. –û–ë–ù–û–í–õ–Ø–ï–ú –î–ê–¢–´ –ü–û –£–†–û–í–ù–Ø–ú
       print(f"3. –û–±–Ω–æ–≤–ª—è—é –¥–∞—Ç—ã –ø–æ —É—Ä–æ–≤–Ω—è–º:")
       if next_lvl == 2:
           sheet.update_cell(row, 8, today_date)  # H
           sheet.update_cell(row, 9, "")  # I –ø—É—Å—Ç–∞—è
           sheet.update_cell(row, 10, "")  # J –ø—É—Å—Ç–∞—è
           sheet.update_cell(row, 11, "")  # K –ø—É—Å—Ç–∞—è
           print(f"   –£—Ä–æ–≤–µ–Ω—å 2: —Å—Ç–æ–ª–±–µ—Ü H = {today_date}")
           
       elif next_lvl == 3:
           sheet.update_cell(row, 9, today_date)  # I
           sheet.update_cell(row, 10, "")  # J –ø—É—Å—Ç–∞—è
           sheet.update_cell(row, 11, "")  # K –ø—É—Å—Ç–∞—è
           print(f"   –£—Ä–æ–≤–µ–Ω—å 3: —Å—Ç–æ–ª–±–µ—Ü I = {today_date}")
           
       elif next_lvl == 4:
           sheet.update_cell(row, 10, today_date)  # J
           sheet.update_cell(row, 11, "")  # K –ø—É—Å—Ç–∞—è
           print(f"   –£—Ä–æ–≤–µ–Ω—å 4: —Å—Ç–æ–ª–±–µ—Ü J = {today_date}")
           
       elif next_lvl == 5:
           sheet.update_cell(row, 11, today_date)  # K
           print(f"   –£—Ä–æ–≤–µ–Ω—å 5: —Å—Ç–æ–ª–±–µ—Ü K = {today_date}")
       
       time.sleep(0.5)


       # 5. –û–±–Ω–æ–≤–ª—è–µ–º –¥–æ–ª–∂–Ω–æ—Å—Ç—å
       print(f"4. –û–±–Ω–æ–≤–ª—è—é –¥–æ–ª–∂–Ω–æ—Å—Ç—å...")
       if 1 <= next_lvl <= 4:
           sheet.update_cell(row, 4, "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä")
           print(f"   ‚úì –î–æ–ª–∂–Ω–æ—Å—Ç—å: –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä")
       elif next_lvl == 5:
           sheet.update_cell(row, 4, "–°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –°–ª–µ–¥—è—â–∏–π")
           print(f"   ‚úì –î–æ–ª–∂–Ω–æ—Å—Ç—å: –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –°–ª–µ–¥—è—â–∏–π")
       
       time.sleep(1)


       # 6. –ü–ï–†–ï–ú–ï–©–ê–ï–ú –°–¢–†–û–ö–£
       print(f"5. –ü–µ—Ä–µ–º–µ—â–∞—é —Å—Ç—Ä–æ–∫—É –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –ø–æ–∑–∏—Ü–∏—é...")
       new_row_position = move_row_to_position(sheet, row, next_lvl)
       print(f"   ‚úì –°—Ç—Ä–æ–∫–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∞ –Ω–∞ –ø–æ–∑–∏—Ü–∏—é: {new_row_position}")
       
       time.sleep(1)


       # 7. –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
       print(f"6. –ü—Ä–∏–º–µ–Ω—è—é —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ...")
       apply_complete_row_formatting(sheet, new_row_position, make_bold=True)
       apply_lvlup_formatting(sheet, new_row_position, next_lvl)
       add_border_to_row(sheet, new_row_position)
       
       print(f"\n{'='*50}")
       print(f"‚úÖ {nickname} —É—Å–ø–µ—à–Ω–æ –ø–æ–≤—ã—à–µ–Ω!")
       print(f"{'='*50}")
       
       return True, f"‚úÖ {nickname} –ø–æ–≤—ã—à–µ–Ω —Å {current_lvl} –¥–æ {next_lvl} —É—Ä–æ–≤–Ω—è! –î–∞—Ç–∞: {today_date}"
       
   except Exception as e:
       print(f"\n{'='*50}")
       print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–≤—ã—à–µ–Ω–∏–∏ {nickname}: {e}")
       print(f"{'='*50}")
       import traceback
       traceback.print_exc()
       return False, f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–≤—ã—à–µ–Ω–∏–∏ {nickname}: {str(e)}"




def process_promotion_custom(sheet, row, nickname, current_lvl, next_lvl, custom_date):
   """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–æ–≤—ã—à–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π –¥–∞—Ç–æ–π"""
   try:
       print(f"\n{'='*50}")
       print(f"üîÑ –ù–∞—á–∏–Ω–∞—é –ø–æ–≤—ã—à–µ–Ω–∏–µ {nickname} —Å {current_lvl} –¥–æ {next_lvl} —É—Ä–æ–≤–Ω—è")
       print(f"üìÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è –¥–∞—Ç–∞: {custom_date}")
       print(f"{'='*50}")


       # 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
       try:
           current_nickname = sheet.cell(row, 3).value
           if current_nickname != nickname:
               print(f"‚ö†Ô∏è –ò–º—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å: –±—ã–ª–æ '{nickname}', —Å—Ç–∞–ª–æ '{current_nickname}'")
       except Exception as e:
           print(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–º—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞: {e}")


       # 2. –û–±–Ω–æ–≤–ª—è–µ–º —É—Ä–æ–≤–µ–Ω—å (—Å—Ç–æ–ª–±–µ—Ü B)
       print(f"1. –û–±–Ω–æ–≤–ª—è—é —É—Ä–æ–≤–µ–Ω—å: {current_lvl} ‚Üí {next_lvl}")
       sheet.update_cell(row, 2, str(next_lvl))
       print(f"   ‚úì –£—Ä–æ–≤–µ–Ω—å –æ–±–Ω–æ–≤–ª–µ–Ω")
       
       time.sleep(0.5)


       # 3. –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—Ç—É –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–æ–≤—ã—à–µ–Ω–∏—è (—Å—Ç–æ–ª–±–µ—Ü L)
       print(f"2. –û–±–Ω–æ–≤–ª—è—é –¥–∞—Ç—É –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–æ–≤—ã—à–µ–Ω–∏—è: {custom_date}")
       sheet.update_cell(row, 12, custom_date)
       print(f"   ‚úì –î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞")
       
       time.sleep(0.5)


       # 4. –û–ë–ù–û–í–õ–Ø–ï–ú –î–ê–¢–´ –ü–û –£–†–û–í–ù–Ø–ú
       print(f"3. –û–±–Ω–æ–≤–ª—è—é –¥–∞—Ç—ã –ø–æ —É—Ä–æ–≤–Ω—è–º:")
       if next_lvl == 2:
           sheet.update_cell(row, 8, custom_date)  # H
           sheet.update_cell(row, 9, "")  # I –ø—É—Å—Ç–∞—è
           sheet.update_cell(row, 10, "")  # J –ø—É—Å—Ç–∞—è
           sheet.update_cell(row, 11, "")  # K –ø—É—Å—Ç–∞—è
           print(f"   –£—Ä–æ–≤–µ–Ω—å 2: —Å—Ç–æ–ª–±–µ—Ü H = {custom_date}")
           
       elif next_lvl == 3:
           sheet.update_cell(row, 9, custom_date)  # I
           sheet.update_cell(row, 10, "")  # J –ø—É—Å—Ç–∞—è
           sheet.update_cell(row, 11, "")  # K –ø—É—Å—Ç–∞—è
           print(f"   –£—Ä–æ–≤–µ–Ω—å 3: —Å—Ç–æ–ª–±–µ—Ü I = {custom_date}")
           
       elif next_lvl == 4:
           sheet.update_cell(row, 10, custom_date)  # J
           sheet.update_cell(row, 11, "")  # K –ø—É—Å—Ç–∞—è
           print(f"   –£—Ä–æ–≤–µ–Ω—å 4: —Å—Ç–æ–ª–±–µ—Ü J = {custom_date}")
           
       elif next_lvl == 5:
           sheet.update_cell(row, 11, custom_date)  # K
           print(f"   –£—Ä–æ–≤–µ–Ω—å 5: —Å—Ç–æ–ª–±–µ—Ü K = {custom_date}")
       
       time.sleep(0.5)


       # 5. –û–±–Ω–æ–≤–ª—è–µ–º –¥–æ–ª–∂–Ω–æ—Å—Ç—å
       print(f"4. –û–±–Ω–æ–≤–ª—è—é –¥–æ–ª–∂–Ω–æ—Å—Ç—å...")
       if 1 <= next_lvl <= 4:
           sheet.update_cell(row, 4, "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä")
           print(f"   ‚úì –î–æ–ª–∂–Ω–æ—Å—Ç—å: –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä")
       elif next_lvl == 5:
           sheet.update_cell(row, 4, "–°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –°–ª–µ–¥—è—â–∏–π")
           print(f"   ‚úì –î–æ–ª–∂–Ω–æ—Å—Ç—å: –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –°–ª–µ–¥—è—â–∏–π")
       
       time.sleep(1)


       # 6. –ü–ï–†–ï–ú–ï–©–ê–ï–ú –°–¢–†–û–ö–£
       print(f"5. –ü–µ—Ä–µ–º–µ—â–∞—é —Å—Ç—Ä–æ–∫—É –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –ø–æ–∑–∏—Ü–∏—é...")
       new_row_position = move_row_to_position(sheet, row, next_lvl)
       print(f"   ‚úì –°—Ç—Ä–æ–∫–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∞ –Ω–∞ –ø–æ–∑–∏—Ü–∏—é: {new_row_position}")
       
       time.sleep(1)


       # 7. –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
       print(f"6. –ü—Ä–∏–º–µ–Ω—è—é —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ...")
       apply_complete_row_formatting(sheet, new_row_position, make_bold=True)
       apply_lvlup_formatting(sheet, new_row_position, next_lvl)
       add_border_to_row(sheet, new_row_position)
       
       print(f"\n{'='*50}")
       print(f"‚úÖ {nickname} —É—Å–ø–µ—à–Ω–æ –ø–æ–≤—ã—à–µ–Ω!")
       print(f"{'='*50}")
       
       return True, f"‚úÖ {nickname} –ø–æ–≤—ã—à–µ–Ω —Å {current_lvl} –¥–æ {next_lvl} —É—Ä–æ–≤–Ω—è! –î–∞—Ç–∞: {custom_date}"
       
   except Exception as e:
       print(f"\n{'='*50}")
       print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–≤—ã—à–µ–Ω–∏–∏ {nickname}: {e}")
       print(f"{'='*50}")
       import traceback
       traceback.print_exc()
       return False, f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–≤—ã—à–µ–Ω–∏–∏ {nickname}: {str(e)}"




def process_mass_promotion_promotionlist(sheet, promotion_list):
   """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –º–∞—Å—Å–æ–≤–æ–µ –ø–æ–≤—ã—à–µ–Ω–∏–µ —á–µ—Ä–µ–∑ /promotionlist"""
   try:
       print(f"\n{'='*60}")
       print(f"üöÄ –ù–ê–ß–ê–õ–û –ú–ê–°–°–û–í–û–ì–û –ü–û–í–´–®–ï–ù–ò–Ø –ß–ï–†–ï–ó /promotionlist")
       print(f"{'='*60}")
       
       results = []
       success_count = 0
       failed_count = 0
       today_date = datetime.now().strftime("%d.%m.%Y")
       
       print(f"üìÖ –î–∞—Ç–∞ –ø–æ–≤—ã—à–µ–Ω–∏—è –¥–ª—è –≤—Å–µ—Ö: {today_date}")
       print(f"üë• –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤: {len(promotion_list)}")


       for i, admin in enumerate(promotion_list, 1):
           print(f"\n{'‚îÄ'*40}")
           print(f"[{i}/{len(promotion_list)}] –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é: {admin['nickname']}")
           print(f"{'‚îÄ'*40}")
           
           success, msg = process_promotion_promotionlist(
               sheet,
               admin['row'],
               admin['nickname'],
               admin['current_lvl'],
               admin['next_lvl']
           )
           
           if success:
               success_count += 1
               results.append(f"‚úÖ {admin['nickname']}: {admin['current_lvl']}‚Üí{admin['next_lvl']}")
               print(f"‚úì –£—Å–ø–µ—à–Ω–æ: {admin['nickname']} –ø–æ–≤—ã—à–µ–Ω")
           else:
               failed_count += 1
               results.append(f"‚ùå {admin['nickname']}: –æ—à–∏–±–∫–∞")
               print(f"‚úó –û—à–∏–±–∫–∞: {admin['nickname']} –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–≤—ã—Å–∏—Ç—å")
           
           # –ü–∞—É–∑–∞ –º–µ–∂–¥—É –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏
           if i < len(promotion_list):
               print(f"‚è≥ –ü–∞—É–∑–∞ 2 —Å–µ–∫—É–Ω–¥—ã...")
               time.sleep(2)


       # –§–æ—Ä–º–∏—Ä—É–µ–º –∏—Ç–æ–≥–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
       print(f"\n{'='*60}")
       print(f"üìä –ò–¢–û–ì–ò –ú–ê–°–°–û–í–û–ì–û –ü–û–í–´–®–ï–ù–ò–Ø")
       print(f"{'='*60}")
       
       message = f"üöÄ –ú–ê–°–°–û–í–û–ï –ü–û–í–´–®–ï–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û:\n\n"
       message += f"‚úÖ –£—Å–ø–µ—à–Ω–æ: {success_count}\n"
       message += f"‚ùå –ù–µ—É–¥–∞—á–Ω–æ: {failed_count}\n"
       message += f"üìä –í—Å–µ–≥–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ: {len(promotion_list)} –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤"
       
       if len(results) <= 15:
           message += "\n\n–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:\n" + "\n".join(results)
       else:
           message += f"\n\n–ü–µ—Ä–≤—ã–µ 15 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:\n" + "\n".join(results[:15])
           message += f"\n... –∏ –µ—â–µ {len(results) - 15} –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤"


       return True, message


   except Exception as e:
       print(f"\n{'='*60}")
       print(f"‚ùå –û–®–ò–ë–ö–ê –ú–ê–°–°–û–í–û–ì–û –ü–û–í–´–®–ï–ù–ò–Ø: {e}")
       print(f"{'='*60}")
       import traceback
       traceback.print_exc()
       return False, f"‚ùå –û—à–∏–±–∫–∞ –º–∞—Å—Å–æ–≤–æ–≥–æ –ø–æ–≤—ã—à–µ–Ω–∏—è: {str(e)}"




def process_mass_promotion_custom(sheet, promotion_list):
   """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –º–∞—Å—Å–æ–≤–æ–µ –ø–æ–≤—ã—à–µ–Ω–∏–µ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º–∏ –¥–∞—Ç–∞–º–∏"""
   try:
       print(f"\n{'='*60}")
       print(f"üöÄ –ù–ê–ß–ê–õ–û –ú–ê–°–°–û–í–û–ì–û –ü–û–í–´–®–ï–ù–ò–Ø –° –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨–°–ö–ò–ú–ò –î–ê–¢–ê–ú–ò")
       print(f"{'='*60}")
       
       results = []
       success_count = 0
       failed_count = 0
       
       print(f"üë• –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤: {len(promotion_list)}")


       for i, admin in enumerate(promotion_list, 1):
           print(f"\n{'‚îÄ'*40}")
           print(f"[{i}/{len(promotion_list)}] –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é: {admin['nickname']}")
           print(f"   –£—Ä–æ–≤–µ–Ω—å: {admin['current_lvl']}‚Üí{admin['next_lvl']}")
           print(f"   –î–∞—Ç–∞: {admin['date']}")
           print(f"{'‚îÄ'*40}")
           
           success, msg = process_promotion_custom(
               sheet,
               admin['row'],
               admin['nickname'],
               admin['current_lvl'],
               admin['next_lvl'],
               admin['date']
           )
           
           if success:
               success_count += 1
               results.append(f"‚úÖ {admin['nickname']}: {admin['current_lvl']}‚Üí{admin['next_lvl']}")
               print(f"‚úì –£—Å–ø–µ—à–Ω–æ: {admin['nickname']} –ø–æ–≤—ã—à–µ–Ω")
           else:
               failed_count += 1
               results.append(f"‚ùå {admin['nickname']}: –æ—à–∏–±–∫–∞")
               print(f"‚úó –û—à–∏–±–∫–∞: {admin['nickname']} –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–≤—ã—Å–∏—Ç—å")
           
           # –ü–∞—É–∑–∞ –º–µ–∂–¥—É –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏
           if i < len(promotion_list):
               print(f"‚è≥ –ü–∞—É–∑–∞ 2 —Å–µ–∫—É–Ω–¥—ã...")
               time.sleep(2)


       # –§–æ—Ä–º–∏—Ä—É–µ–º –∏—Ç–æ–≥–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
       print(f"\n{'='*60}")
       print(f"üìä –ò–¢–û–ì–ò –ú–ê–°–°–û–í–û–ì–û –ü–û–í–´–®–ï–ù–ò–Ø")
       print(f"{'='*60}")
       
       message = f"üöÄ –ú–ê–°–°–û–í–û–ï –ü–û–í–´–®–ï–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û:\n\n"
       message += f"‚úÖ –£—Å–ø–µ—à–Ω–æ: {success_count}\n"
       message += f"‚ùå –ù–µ—É–¥–∞—á–Ω–æ: {failed_count}\n"
       message += f"üìä –í—Å–µ–≥–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ: {len(promotion_list)} –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤"
       
       if len(results) <= 15:
           message += "\n\n–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:\n" + "\n".join(results)
       else:
           message += f"\n\n–ü–µ—Ä–≤—ã–µ 15 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:\n" + "\n".join(results[:15])
           message += f"\n... –∏ –µ—â–µ {len(results) - 15} –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤"


       return True, message


   except Exception as e:
       print(f"\n{'='*60}")
       print(f"‚ùå –û–®–ò–ë–ö–ê –ú–ê–°–°–û–í–û–ì–û –ü–û–í–´–®–ï–ù–ò–Ø: {e}")
       print(f"{'='*60}")
       import traceback
       traceback.print_exc()
       return False, f"‚ùå –û—à–∏–±–∫–∞ –º–∞—Å—Å–æ–≤–æ–≥–æ –ø–æ–≤—ã—à–µ–Ω–∏—è: {str(e)}"




def parse_promotion_format(text):
   """–ü–∞—Ä—Å–∏—Ç —Ç–µ–∫—Å—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ Nick_Name lvl > lvl (–¥–∞—Ç–∞)"""
   try:
       line = text.strip()
       if not line:
           return None

       print(f"\nüîç –ü–∞—Ä—Å–∏–º —Å—Ç—Ä–æ–∫—É: {line}")

       # –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ó–∞–º–µ–Ω—è–µ–º HTML-—Å—É—â–Ω–æ—Å—Ç–∏ –Ω–∞ —Å–∏–º–≤–æ–ª—ã
       line = line.replace('&gt;', '>').replace('&lt;', '<').replace('&amp;', '&')
       
       # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤ –ø–æ—Å–ª–µ –∑–∞–º–µ–Ω—ã
       if '>' not in line or '(' not in line or ')' not in line:
           print("‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω –æ–¥–∏–Ω –∏–∑ —Å–∏–º–≤–æ–ª–æ–≤: >, (, )")
           return None

       # –†–∞–∑–¥–µ–ª—è–µ–º –Ω–∞ —á–∞—Å—Ç–∏ –ø–æ —Å–∏–º–≤–æ–ª—É >
       parts = line.split('>')
       if len(parts) != 2:
           print(f"‚ùå –ù–µ–≤–µ—Ä–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞—Å—Ç–µ–π –ø–æ—Å–ª–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è: {len(parts)}")
           return None

       left_part = parts[0].strip()
       right_part = parts[1].strip()

       # –ò—â–µ–º –¥–∞—Ç—É –≤ —Å–∫–æ–±–∫–∞—Ö
       date_match = re.search(r'\((.*?)\)', right_part)
       if not date_match:
           print("‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–∞ –¥–∞—Ç–∞ –≤ —Å–∫–æ–±–∫–∞—Ö")
           return None

       date_val = date_match.group(1).strip()
       right_without_date = right_part.replace(f'({date_val})', '').strip()

       # –ò–∑–≤–ª–µ–∫–∞–µ–º —É—Ä–æ–≤–Ω–∏
       left_parts = left_part.split()
       if len(left_parts) < 2:
           print(f"‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —á–∞—Å—Ç–µ–π –≤ –ª–µ–≤–æ–π —á–∞—Å—Ç–∏: {left_parts}")
           return None

       # –ù–∏–∫ - –≤—Å–µ —á–∞—Å—Ç–∏ –∫—Ä–æ–º–µ –ø–æ—Å–ª–µ–¥–Ω–µ–π
       nickname = ' '.join(left_parts[:-1])

       try:
           current_lvl = int(left_parts[-1])
       except ValueError:
           print(f"‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ç–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å: {left_parts[-1]}")
           return None

       # –¶–µ–ª–µ–≤–æ–π —É—Ä–æ–≤–µ–Ω—å
       try:
           target_lvl = int(right_without_date)
       except ValueError:
           print(f"‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ü–µ–ª–µ–≤–æ–π —É—Ä–æ–≤–µ–Ω—å: {right_without_date}")
           return None

       # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —É—Ä–æ–≤–Ω–µ–π
       if target_lvl <= current_lvl or target_lvl < 1 or target_lvl > 5:
           print(f"‚ùå –ù–µ–≤–µ—Ä–Ω—ã–µ —É—Ä–æ–≤–Ω–∏: {current_lvl} ‚Üí {target_lvl}")
           return None

       # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã
       if '.' not in date_val or len(date_val.split('.')) != 3:
           print(f"‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã: {date_val}")
           return None

       result = {
           'nickname': nickname,
           'current_lvl': current_lvl,
           'target_lvl': target_lvl,
           'date': date_val,
           'original_text': line
       }

       print(f"‚úì –£—Å–ø–µ—à–Ω–æ —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω–æ:")
       print(f"  –ù–∏–∫: {nickname}")
       print(f"  –£—Ä–æ–≤–µ–Ω—å: {current_lvl} ‚Üí {target_lvl}")
       print(f"  –î–∞—Ç–∞: {date_val}")
       
       return result

   except Exception as e:
       print(f"‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞: {e}")
       import traceback
       traceback.print_exc()
       return None




def parse_mass_promotion_text(text):
   """–ü–∞—Ä—Å–∏—Ç —Ç–µ–∫—Å—Ç –º–∞—Å—Å–æ–≤–æ–≥–æ –ø–æ–≤—ã—à–µ–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å—Ç—Ä–æ–∫"""
   try:
       # –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ó–∞–º–µ–Ω—è–µ–º HTML-—Å—É—â–Ω–æ—Å—Ç–∏ –≤–æ –≤—Å–µ–º —Ç–µ–∫—Å—Ç–µ
       text = text.replace('&gt;', '>').replace('&lt;', '<').replace('&amp;', '&')
       
       lines = text.strip().split('\n')
       if len(lines) <= 1:
           return None
           
       print(f"\nüìã –ü–∞—Ä—Å–∏–º –º–∞—Å—Å–æ–≤–æ–µ –ø–æ–≤—ã—à–µ–Ω–∏–µ –∏–∑ {len(lines)} —Å—Ç—Ä–æ–∫")
       
       parsed_lines = []
       valid_count = 0
       
       for line_num, line in enumerate(lines, 1):
           line = line.strip()
           if not line:
               continue
               
           print(f"\n  –°—Ç—Ä–æ–∫–∞ {line_num}: {line}")
           
           # –ü–∞—Ä—Å–∏–º —Å—Ç—Ä–æ–∫—É –∫–∞–∫ –æ–¥–∏–Ω–æ—á–Ω–æ–µ –ø–æ–≤—ã—à–µ–Ω–∏–µ
           parsed = parse_promotion_format(line)
           if parsed:
               parsed_lines.append(parsed)
               valid_count += 1
               print(f"    ‚úì –£—Å–ø–µ—à–Ω–æ —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω–æ")
           else:
               print(f"    ‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞")
       
       if valid_count >= 1:
           print(f"\n‚úì –£—Å–ø–µ—à–Ω–æ —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω–æ {valid_count} –∏–∑ {len(lines)} —Å—Ç—Ä–æ–∫")
           return parsed_lines
       else:
           print(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –Ω–∏ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏")
           return None
           
   except Exception as e:
       print(f"‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –º–∞—Å—Å–æ–≤–æ–≥–æ –ø–æ–≤—ã—à–µ–Ω–∏—è: {e}")
       import traceback
       traceback.print_exc()
       return None




def create_confirmation_keyboard(promotion_data, is_mass=False):
   """–°–æ–∑–¥–∞–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–æ–≤—ã—à–µ–Ω–∏—è"""
   try:
       buttons = []
       
       if is_mass and isinstance(promotion_data, list):
           # –î–ª—è –º–∞—Å—Å–æ–≤–æ–≥–æ –ø–æ–≤—ã—à–µ–Ω–∏—è
           count = len(promotion_data)
           button_label = f"‚úÖ –î–∞, –ø–æ–≤—ã—Å–∏—Ç—å –≤—Å–µ—Ö ({count})"
           payload_command = "confirm_mass_promotion"
       else:
           # –î–ª—è –æ–¥–∏–Ω–æ—á–Ω–æ–≥–æ –ø–æ–≤—ã—à–µ–Ω–∏—è
           button_label = "‚úÖ –î–∞, –ø–æ–≤—ã—Å–∏—Ç—å"
           payload_command = "confirm_single_promotion"
       
       buttons.append([{
           "action": {
               "type": "text",
               "label": button_label,
               "payload": json.dumps({"command": payload_command})
           },
           "color": "positive"
       }, {
           "action": {
               "type": "text",
               "label": "‚ùå –û—Ç–º–µ–Ω–∞",
               "payload": json.dumps({"command": "cancel_promotion"})
           },
           "color": "negative"
       }])


       keyboard = {
           "one_time": False,
           "inline": True,
           "buttons": buttons
       }


       print(f"–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Å–æ–∑–¥–∞–Ω–∞")
       return json.dumps(keyboard, ensure_ascii=False)


   except Exception as e:
       print(f"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã: {e}")
       import traceback
       traceback.print_exc()
       return None




def main():
   print("\n" + "="*60)
   print("üöÄ –ó–ê–ü–£–°–ö –°–ò–°–¢–ï–ú–´ –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ü–†–ê–í–ê–ú–ò")
   print("="*60)
   print(f"üë®‚Äçüíª –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∏: {DEVELOPERS}")
   print(f"üìÖ –î–∞—Ç–∞ –∑–∞–ø—É—Å–∫–∞: {datetime.now().strftime('%d.%m.%Y %H:%M:%S')}")
   print("="*60 + "\n")


   load_user_rights()
   load_chat_bindings()
   print(f"‚úì –ó–∞–≥—Ä—É–∂–µ–Ω–æ –ø—Ä–∞–≤ –¥–ª—è {len(user_rights)} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π")
   print(f"‚úì –ó–∞–≥—Ä—É–∂–µ–Ω–æ –ø—Ä–∏–≤—è–∑–æ–∫ –¥–ª—è {len(chat_bindings)} —á–∞—Ç–æ–≤")


   try:
       gc = get_google_client()
       default_sheet = gc.open(SPREADSHEET_NAME).sheet1
       print(f"\n‚úì –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Ç–∞–±–ª–∏—Ü–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: {SPREADSHEET_NAME}")
       print(f"‚úì –†–∞–∑–º–µ—Ä —Ç–∞–±–ª–∏—Ü—ã: {len(default_sheet.get_all_values())} —Å—Ç—Ä–æ–∫")


       vk_session = vk_api.VkApi(token=VK_TOKEN)
       vk = vk_session.get_api()
       longpoll = VkLongPoll(vk_session)


       print("\n" + "="*60)
       print("ü§ñ –ë–æ—Ç –í–ö –∑–∞–ø—É—â–µ–Ω –∏ –∂–¥–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π...")
       print("="*60 + "\n")


       # –°–ª–æ–≤–∞—Ä—å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
       user_temp_data = {}


       for event in longpoll.listen():
           if event.type == VkEventType.MESSAGE_NEW:
               user_id = event.user_id
               text = event.text.strip()


               # –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏–π –Ω–∞ –∫–Ω–æ–ø–∫–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
               if hasattr(event, 'payload') and event.payload:
                   try:
                       payload = json.loads(event.payload)


                       print(f"\nüîò –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏:")
                       print(f"   –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user_id}")
                       print(f"   –ö–æ–º–∞–Ω–¥–∞: {payload.get('command')}")


                       if payload.get('command') == 'promote_all':
                           # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è (—á–∞—Ç –∏–ª–∏ –õ–°)
                           if hasattr(event, 'chat_id') and event.chat_id:
                               chat_id = event.chat_id
                               print(f"   –ë–µ—Å–µ–¥–∞ {chat_id}: –∫–Ω–æ–ø–∫–∞ '–ü–æ–≤—ã—Å–∏—Ç—å –≤—Å–µ—Ö' –æ—Ç {user_id}")
                               send_target = {'chat_id': chat_id}


                               # –ü–æ–ª—É—á–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –¥–ª—è —ç—Ç–æ–≥–æ —á–∞—Ç–∞
                               chat_spreadsheet = get_chat_spreadsheet(chat_id)
                               if chat_spreadsheet:
                                   current_spreadsheet = chat_spreadsheet
                                   print(f"   –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–∞–±–ª–∏—Ü–∞ —á–∞—Ç–∞: {current_spreadsheet}")
                               else:
                                   current_spreadsheet = SPREADSHEET_NAME
                                   print(f"   –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–∞–±–ª–∏—Ü–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: {current_spreadsheet}")
                           else:
                               print(f"   –õ–°: –∫–Ω–æ–ø–∫–∞ '–ü–æ–≤—ã—Å–∏—Ç—å –≤—Å–µ—Ö' –æ—Ç {user_id}")
                               send_target = {'user_id': user_id}
                               current_spreadsheet = SPREADSHEET_NAME


                           # –ü–æ–ª—É—á–∞–µ–º –æ–±—ä–µ–∫—Ç —Ç–∞–±–ª–∏—Ü—ã
                           try:
                               sheet = gc.open(current_spreadsheet).sheet1
                           except Exception as e:
                               print(f"   ‚ùå –û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è —Ç–∞–±–ª–∏—Ü—ã {current_spreadsheet}: {e}")
                               sheet = default_sheet


                           def send_message(message):
                               try:
                                   vk.messages.send(
                                       **send_target,
                                       message=message,
                                       random_id=random.randint(0, 2 ** 32)
                                   )
                               except Exception as e:
                                   print(f"   ‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")


                           # –ü–†–û–í–ï–†–ö–ê –ü–†–ê–í
                           if user_id not in DEVELOPERS and get_user_role(user_id) not in ['editor', 'admin']:
                               send_message("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è!")
                               print(f"   ‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –Ω–µ –∏–º–µ–µ—Ç –ø—Ä–∞–≤. –†–æ–ª—å: {get_user_role(user_id)}")
                               continue


                           # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π —Å–ø–∏—Å–æ–∫ –Ω–∞ –ø–æ–≤—ã—à–µ–Ω–∏–µ
                           print(f"   üìã –ü–æ–ª—É—á–∞—é —Å–ø–∏—Å–æ–∫ –Ω–∞ –ø–æ–≤—ã—à–µ–Ω–∏–µ...")
                           success, promotion_list = get_promotion_list(sheet)


                           if not success or not promotion_list:
                               send_message("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –¥–ª—è –º–∞—Å—Å–æ–≤–æ–≥–æ –ø–æ–≤—ã—à–µ–Ω–∏—è.")
                               continue


                           # –í—ã–ø–æ–ª–Ω—è–µ–º –ø–æ–≤—ã—à–µ–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö —á–µ—Ä–µ–∑ /promotionlist
                           send_message(f"üîÑ –ù–∞—á–∏–Ω–∞—é –º–∞—Å—Å–æ–≤–æ–µ –ø–æ–≤—ã—à–µ–Ω–∏–µ {len(promotion_list)} –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤...")
                           
                           success, result_message = process_mass_promotion_promotionlist(sheet, promotion_list)


                           send_message(result_message)


                           continue
                           
                       elif payload.get('command') == 'confirm_single_promotion':
                           # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–¥–∏–Ω–æ—á–Ω–æ–≥–æ –ø–æ–≤—ã—à–µ–Ω–∏—è
                           print(f"   –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–¥–∏–Ω–æ—á–Ω–æ–≥–æ –ø–æ–≤—ã—à–µ–Ω–∏—è")
                           
                           if hasattr(event, 'chat_id') and event.chat_id:
                               send_target = {'chat_id': event.chat_id}
                               chat_id = event.chat_id
                               chat_spreadsheet = get_chat_spreadsheet(chat_id)
                               if chat_spreadsheet:
                                   current_spreadsheet = chat_spreadsheet
                               else:
                                   current_spreadsheet = SPREADSHEET_NAME
                           else:
                               send_target = {'user_id': user_id}
                               current_spreadsheet = SPREADSHEET_NAME
                               
                           try:
                               sheet = gc.open(current_spreadsheet).sheet1
                           except Exception as e:
                               print(f"   ‚ùå –û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è —Ç–∞–±–ª–∏—Ü—ã: {e}")
                               sheet = default_sheet


                           def send_message(message):
                               try:
                                   vk.messages.send(
                                       **send_target,
                                       message=message,
                                       random_id=random.randint(0, 2 ** 32)
                                   )
                               except Exception as e:
                                   print(f"   ‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")


                           if user_id not in user_temp_data or 'promotion_data' not in user_temp_data[user_id]:
                               send_message("‚ùå –î–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É —Å–Ω–æ–≤–∞.")
                               continue


                           promotion_data = user_temp_data[user_id]['promotion_data']
                           nickname = promotion_data['nickname']
                           target_lvl = promotion_data['target_lvl']
                           date_val = promotion_data['date']


                           # –í—ã–ø–æ–ª–Ω—è–µ–º –ø–æ–≤—ã—à–µ–Ω–∏–µ
                           send_message(f"üîÑ –í—ã–ø–æ–ª–Ω—è—é –ø–æ–≤—ã—à–µ–Ω–∏–µ {nickname} –¥–æ —É—Ä–æ–≤–Ω—è {target_lvl}...")
                           
                           # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é lvlup_admin –¥–ª—è –æ–¥–∏–Ω–æ—á–Ω–æ–≥–æ –ø–æ–≤—ã—à–µ–Ω–∏—è
                           success, message = lvlup_admin(sheet, nickname, target_lvl, date_val)


                           # –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                           if user_id in user_temp_data:
                               del user_temp_data[user_id]


                           # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                           send_message(message)
                           continue
                           
                       elif payload.get('command') == 'confirm_mass_promotion':
                           # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –º–∞—Å—Å–æ–≤–æ–≥–æ –ø–æ–≤—ã—à–µ–Ω–∏—è —á–µ—Ä–µ–∑ —Å–ø–∏—Å–æ–∫ —Å—Ç—Ä–æ–∫
                           print(f"   –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –º–∞—Å—Å–æ–≤–æ–≥–æ –ø–æ–≤—ã—à–µ–Ω–∏—è")
                           
                           if hasattr(event, 'chat_id') and event.chat_id:
                               send_target = {'chat_id': event.chat_id}
                               chat_id = event.chat_id
                               chat_spreadsheet = get_chat_spreadsheet(chat_id)
                               if chat_spreadsheet:
                                   current_spreadsheet = chat_spreadsheet
                               else:
                                   current_spreadsheet = SPREADSHEET_NAME
                           else:
                               send_target = {'user_id': user_id}
                               current_spreadsheet = SPREADSHEET_NAME
                               
                           try:
                               sheet = gc.open(current_spreadsheet).sheet1
                           except Exception as e:
                               print(f"   ‚ùå –û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è —Ç–∞–±–ª–∏—Ü—ã: {e}")
                               sheet = default_sheet


                           def send_message(message):
                               try:
                                   vk.messages.send(
                                       **send_target,
                                       message=message,
                                       random_id=random.randint(0, 2 ** 32)
                                   )
                               except Exception as e:
                                   print(f"   ‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")


                           if user_id not in user_temp_data or 'mass_promotion_data' not in user_temp_data[user_id]:
                               send_message("‚ùå –î–∞–Ω–Ω—ã–µ –¥–ª—è –º–∞—Å—Å–æ–≤–æ–≥–æ –ø–æ–≤—ã—à–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.")
                               continue


                           promotion_list = user_temp_data[user_id]['mass_promotion_data']


                           # –ù–∞—Ö–æ–¥–∏–º —Å—Ç—Ä–æ–∫–∏ –¥–ª—è –≤—Å–µ—Ö –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
                           print(f"   üîç –ò—â—É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ –≤ —Ç–∞–±–ª–∏—Ü–µ...")
                           admin_list = []
                           not_found = []
                           
                           for admin_data in promotion_list:
                               # –ù–∞—Ö–æ–¥–∏–º —Å—Ç—Ä–æ–∫—É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
                               all_values = sheet.get_all_values()
                               found_row = None
                               for row_idx, row in enumerate(all_values):
                                   if row_idx >= 2 and len(row) > 2:
                                       if row[2].strip() == admin_data['nickname']:
                                           found_row = row_idx + 1
                                           break
                               
                               if found_row:
                                   admin_list.append({
                                       'row': found_row,
                                       'nickname': admin_data['nickname'],
                                       'current_lvl': admin_data['current_lvl'],
                                       'next_lvl': admin_data['target_lvl'],
                                       'date': admin_data['date']
                                   })
                                   print(f"   ‚úì –ù–∞–π–¥–µ–Ω: {admin_data['nickname']} –≤ —Å—Ç—Ä–æ–∫–µ {found_row}")
                               else:
                                   not_found.append(admin_data['nickname'])
                                   print(f"   ‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω: {admin_data['nickname']}")
                                   
                           if not_found:
                               send_message(f"‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã: {', '.join(not_found)}")
                               continue
                               
                           if not admin_list:
                               send_message("‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è.")
                               continue


                           # –í—ã–ø–æ–ª–Ω—è–µ–º –º–∞—Å—Å–æ–≤–æ–µ –ø–æ–≤—ã—à–µ–Ω–∏–µ
                           send_message(f"üîÑ –ù–∞—á–∏–Ω–∞—é –º–∞—Å—Å–æ–≤–æ–µ –ø–æ–≤—ã—à–µ–Ω–∏–µ {len(admin_list)} –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤...")
                           
                           success, result_message = process_mass_promotion_custom(sheet, admin_list)


                           # –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                           if user_id in user_temp_data:
                               del user_temp_data[user_id]


                           # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                           send_message(result_message)
                           continue
                           
                       elif payload.get('command') == 'cancel_promotion':
                           # –û—Ç–º–µ–Ω–∞ –ø–æ–≤—ã—à–µ–Ω–∏—è
                           print(f"   –û—Ç–º–µ–Ω–∞ –ø–æ–≤—ã—à–µ–Ω–∏—è")
                           
                           if hasattr(event, 'chat_id') and event.chat_id:
                               send_target = {'chat_id': event.chat_id}
                           else:
                               send_target = {'user_id': user_id}


                           def send_message(message):
                               try:
                                   vk.messages.send(
                                       **send_target,
                                       message=message,
                                       random_id=random.randint(0, 2 ** 32)
                                   )
                               except Exception as e:
                                   print(f"   ‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")


                           if user_id in user_temp_data:
                               del user_temp_data[user_id]
                           send_message("‚ùå –ü–æ–≤—ã—à–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.")
                           continue


                   except json.JSONDecodeError:
                       pass
                   except Exception as e:
                       print(f"‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ payload: {e}")


               # –û–±—ã—á–Ω—ã–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã
               if hasattr(event, 'chat_id') and event.chat_id:
                   chat_id = event.chat_id
                   print(f"\nüí¨ –ë–µ—Å–µ–¥–∞ {chat_id}: —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç {user_id}: {text}")
                   send_target = {'chat_id': chat_id}


                   chat_spreadsheet = get_chat_spreadsheet(chat_id)
                   if chat_spreadsheet:
                       current_spreadsheet = chat_spreadsheet
                       print(f"   –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–∞–±–ª–∏—Ü–∞ —á–∞—Ç–∞: {current_spreadsheet}")
                   else:
                       current_spreadsheet = SPREADSHEET_NAME
                       print(f"   –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–∞–±–ª–∏—Ü–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: {current_spreadsheet}")
               else:
                   print(f"\nüì® –õ–° –æ—Ç {user_id}: {text}")
                   send_target = {'user_id': user_id}
                   current_spreadsheet = SPREADSHEET_NAME


               try:
                   sheet = gc.open(current_spreadsheet).sheet1
               except Exception as e:
                   print(f"   ‚ùå –û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è —Ç–∞–±–ª–∏—Ü—ã {current_spreadsheet}: {e}")
                   sheet = default_sheet


               def send_message(message):
                   try:
                       vk.messages.send(
                           **send_target,
                           message=message,
                           random_id=random.randint(0, 2 ** 32)
                       )
                   except Exception as e:
                       print(f"   ‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")


               # –ü–†–û–í–ï–†–ö–ê –ù–ê –û–î–ò–ù–û–ß–ù–û–ï –ü–û–í–´–®–ï–ù–ò–ï: Nick_Name lvl > lvl (–¥–∞—Ç–∞)
               parsed_single = parse_promotion_format(text)
               if parsed_single:
                   print(f"   –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –æ–¥–∏–Ω–æ—á–Ω–æ–µ –ø–æ–≤—ã—à–µ–Ω–∏–µ")


                   # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞
                   if user_id not in DEVELOPERS and get_user_role(user_id) not in ['editor', 'admin']:
                       send_message("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è —É—Ä–æ–≤–Ω—è!")
                       continue


                   # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
                   user_temp_data[user_id] = {
                       'promotion_data': parsed_single,
                       'sheet': sheet
                   }


                   # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π
                   nickname = parsed_single['nickname']
                   current_lvl = parsed_single['current_lvl']
                   target_lvl = parsed_single['target_lvl']
                   date_val = parsed_single['date']


                   message = f"‚ö†Ô∏è –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–æ–≤—ã—à–µ–Ω–∏–µ:\n\n"
                   message += f"üë§ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä: {nickname}\n"
                   message += f"üìä –£—Ä–æ–≤–µ–Ω—å: {current_lvl} ‚Üí {target_lvl}\n"
                   message += f"üìÖ –î–∞—Ç–∞ –ø–æ–≤—ã—à–µ–Ω–∏—è: {date_val}\n\n"
                   message += f"–ù–∞–∂–º–∏—Ç–µ '–î–∞, –ø–æ–≤—ã—Å–∏—Ç—å' –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è"


                   keyboard_json = create_confirmation_keyboard(parsed_single, is_mass=False)


                   try:
                       vk.messages.send(
                           **send_target,
                           message=message,
                           keyboard=keyboard_json,
                           random_id=random.randint(0, 2 ** 32)
                       )
                   except Exception as e:
                       print(f"   ‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π: {e}")
                       send_message(message + "\n\n–î–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤—å—Ç–µ: /confirmpromote")


                   continue


               # –ü–†–û–í–ï–†–ö–ê –ù–ê –ú–ê–°–°–û–í–û–ï –ü–û–í–´–®–ï–ù–ò–ï (–Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫)
               elif '\n' in text and ('>' in text and '(' in text and ')' in text):
                   # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ—Ö–æ–∂–µ –ª–∏ –Ω–∞ —Ñ–æ—Ä–º–∞—Ç –º–∞—Å—Å–æ–≤–æ–≥–æ –ø–æ–≤—ã—à–µ–Ω–∏—è
                   lines = text.strip().split('\n')
                   if len(lines) > 1:
                       print(f"   –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ {len(lines)} —Å—Ç—Ä–æ–∫, –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –º–∞—Å—Å–æ–≤–æ–µ –ø–æ–≤—ã—à–µ–Ω–∏–µ...")
                       
                       # –ü–∞—Ä—Å–∏–º –º–∞—Å—Å–æ–≤–æ–µ –ø–æ–≤—ã—à–µ–Ω–∏–µ
                       parsed_mass = parse_mass_promotion_text(text)
                       
                       if parsed_mass and len(parsed_mass) >= 1:
                           print(f"   ‚úì –û–±–Ω–∞—Ä—É–∂–µ–Ω —Ñ–æ—Ä–º–∞—Ç –º–∞—Å—Å–æ–≤–æ–≥–æ –ø–æ–≤—ã—à–µ–Ω–∏—è ({len(parsed_mass)} –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤)")


                           # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞
                           if user_id not in DEVELOPERS and get_user_role(user_id) not in ['editor', 'admin']:
                               send_message("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –º–∞—Å—Å–æ–≤–æ–≥–æ –ø–æ–≤—ã—à–µ–Ω–∏—è!")
                               continue


                           # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
                           user_temp_data[user_id] = {
                               'mass_promotion_data': parsed_mass,
                               'sheet': sheet
                           }


                           # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
                           message = f"‚ö†Ô∏è –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ú–ê–°–°–û–í–û–ï –ü–û–í–´–®–ï–ù–ò–ï:\n\n"
                           message += f"üìã –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤: {len(parsed_mass)}\n\n"
                           
                           # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 5 –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
                           for i, admin in enumerate(parsed_mass[:5], 1):
                               message += f"{i}. {admin['nickname']} {admin['current_lvl']} ‚Üí {admin['target_lvl']} ({admin['date']})\n"
                           
                           if len(parsed_mass) > 5:
                               message += f"... –∏ –µ—â–µ {len(parsed_mass) - 5} –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤\n"
                           
                           message += f"\n–ù–∞–∂–º–∏—Ç–µ '–î–∞, –ø–æ–≤—ã—Å–∏—Ç—å –≤—Å–µ—Ö' –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è"


                           # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
                           keyboard_json = create_confirmation_keyboard(parsed_mass, is_mass=True)


                           try:
                               vk.messages.send(
                                   **send_target,
                                   message=message,
                                   keyboard=keyboard_json,
                                   random_id=random.randint(0, 2 ** 32)
                               )
                           except Exception as e:
                               print(f"   ‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π: {e}")
                               send_message(message + "\n\n–î–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤—å—Ç–µ: /confirmpromote")


                           continue
                       else:
                           print("   ‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –∫–∞–∫ –º–∞—Å—Å–æ–≤–æ–µ –ø–æ–≤—ã—à–µ–Ω–∏–µ")


               # –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥—Ä—É–≥–∏—Ö –∫–æ–º–∞–Ω–¥
               elif text.lower() == "–±–æ—Ç":
                   bot_response = get_bot_response()
                   send_message(bot_response)




               elif text.lower() == "+–Ω–≥":
                   days, hours, minutes, seconds = get_time_until_new_year()
                   message = format_time_message(days, hours, minutes, seconds, "–ù–æ–≤–æ–≥–æ –≥–æ–¥–∞ üéÑ")
                   send_message(message)




               elif text.lower() == "+–ª–µ—Ç–æ":
                   days, hours, minutes, seconds = get_time_until_summer()
                   message = format_time_message(days, hours, minutes, seconds, "–ª–µ—Ç–∞ ‚òÄÔ∏è")
                   send_message(message)




               elif text.startswith('/addserver'):
                   if not hasattr(event, 'chat_id') or not event.chat_id:
                       send_message("‚ùå –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –≤ –±–µ—Å–µ–¥–∞—Ö!")
                       continue


                   if user_id not in DEVELOPERS:
                       send_message("‚ùå –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞–º!")
                       continue


                   parts = text.split(maxsplit=1)
                   if len(parts) < 2:
                       send_message("‚ùå –§–æ—Ä–º–∞—Ç: /addserver [–Ω–∞–∑–≤–∞–Ω–∏–µ_—Ç–∞–±–ª–∏—Ü—ã]\n"
                                    "–ü—Ä–∏–º–µ—Ä: /addserver '29 | –†–∞–±–æ—Ç–∞'\n"
                                    "–ü—Ä–∏–º–µ—Ä: /addserver '–û—Ç–¥–µ–ª –∫–∞–¥—Ä–æ–≤'\n\n"
                                    "–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: —Ç–∞–±–ª–∏—Ü–∞ –¥–æ–ª–∂–Ω–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å –≤ Google Drive")
                       continue


                   spreadsheet_name = parts[1].strip()


                   try:
                       success, message = add_chat_binding(chat_id, spreadsheet_name, user_id)
                       send_message(message)


                       if success:
                           binding_info = f"\nüìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–∏–≤—è–∑–∫–µ:\n"
                           binding_info += f"‚Ä¢ –ß–∞—Ç ID: {chat_id}\n"
                           binding_info += f"‚Ä¢ –¢–∞–±–ª–∏—Ü–∞: {spreadsheet_name}\n"
                           binding_info += f"‚Ä¢ –î–æ–±–∞–≤–∏–ª: id{user_id}\n"
                           binding_info += f"‚Ä¢ –î–∞—Ç–∞: {time.strftime('%d.%m.%Y %H:%M:%S')}\n"
                           binding_info += f"\n–¢–µ–ø–µ—Ä—å –≤—Å–µ –∫–æ–º–∞–Ω–¥—ã –≤ —ç—Ç–æ–º —á–∞—Ç–µ –±—É–¥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å —Ç–∞–±–ª–∏—Ü–µ–π '{spreadsheet_name}'"
                           send_message(binding_info)
                   except Exception as e:
                       send_message(f"‚ùå –û—à–∏–±–∫–∞: {str(e)}")




               elif text.startswith('/removeserver'):
                   if not hasattr(event, 'chat_id') or not event.chat_id:
                       send_message("‚ùå –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –≤ –±–µ—Å–µ–¥–∞—Ö!")
                       continue


                   if user_id not in DEVELOPERS:
                       send_message("‚ùå –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞–º!")
                       continue


                   try:
                       success, message = remove_chat_binding(chat_id)
                       send_message(message)
                   except Exception as e:
                       send_message(f"‚ùå –û—à–∏–±–∫–∞: {str(e)}")




               elif text == '/serverinfo':
                   if not hasattr(event, 'chat_id') or not event.chat_id:
                       send_message("‚ùå –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –≤ –±–µ—Å–µ–¥–∞—Ö!")
                       continue


                   if chat_id in chat_bindings:
                       binding = chat_bindings[chat_id]
                       message = f"üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–∏–≤—è–∑–∫–µ —á–∞—Ç–∞:\n\n"
                       message += f"‚Ä¢ –ß–∞—Ç ID: {chat_id}\n"
                       message += f"‚Ä¢ –¢–∞–±–ª–∏—Ü–∞: {binding['spreadsheet_name']}\n"
                       message += f"‚Ä¢ –î–æ–±–∞–≤–∏–ª: id{binding['added_by']}\n"
                       message += f"‚Ä¢ –î–∞—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è: {binding['added_date']}\n"
                       message += f"‚Ä¢ –ù–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞: {binding.get('chat_title', '–ù–µ —É–∫–∞–∑–∞–Ω–æ')}"
                   else:
                       message = "‚ÑπÔ∏è –≠—Ç–æ—Ç —á–∞—Ç –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ —Ç–∞–±–ª–∏—Ü–µ.\n–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–∞–±–ª–∏—Ü–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é."


                   send_message(message)




               elif text.startswith('/addadmin'):
                   if user_id not in DEVELOPERS and get_user_role(user_id) not in ['editor', 'admin']:
                       send_message("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤!")
                       continue


                   parts = text.split()
                   if len(parts) < 5:
                       send_message("‚ùå –§–æ—Ä–º–∞—Ç: /addadmin [–ù–∏–∫] [–î–∞—Ç–∞] [–í–ö] [–§–æ—Ä—É–º]\n"
                                    "–ü—Ä–∏–º–µ—Ä: /addadmin Gosha_Parker 01.01.2024 https://vk.com/id123 https://forum.link\n\n"
                                    "–°—Ç–æ–ª–±–µ—Ü E: –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è —Å—Å—ã–ª–∫–∞ –í–ö (–∫–ª–∏–∫–∞–±–µ–ª—å–Ω–∞—è –ü–û–î–ß–ï–†–ö–ù–£–¢–ê–Ø)\n"
                                    "–°—Ç–æ–ª–±–µ—Ü F: –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è 'LINK' (–∫–ª–∏–∫–∞–±–µ–ª—å–Ω–∞—è –ü–û–î–ß–ï–†–ö–ù–£–¢–ê–Ø —Å—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–æ—Ä—É–º)")
                       continue


                   nickname = parts[1]
                   date_val = parts[2]
                   vk_link = parts[3]
                   forum_link = parts[4]


                   try:
                       if '.' not in date_val or len(date_val.split('.')) != 3:
                           send_message("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –î–î.–ú–ú.–ì–ì–ì–ì")
                           continue


                       if not vk_link.startswith(('http://', 'https://', 'vk.com/')):
                           if 'vk.com/' in vk_link:
                               vk_link = f"https://{vk_link}"
                           else:
                               send_message("‚ö†Ô∏è –°—Å—ã–ª–∫–∞ –í–ö –¥–æ–ª–∂–Ω–∞ –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å http://, https:// –∏–ª–∏ vk.com/")
                               vk_link = f"https://vk.com/{vk_link}" if not vk_link.startswith(
                                   ('http://', 'https://')) else vk_link


                       if not forum_link.startswith(('http://', 'https://')):
                           send_message("‚ö†Ô∏è –°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–æ—Ä—É–º –¥–æ–ª–∂–Ω–∞ –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å http:// –∏–ª–∏ https://")
                           forum_link = f"https://{forum_link}" if not forum_link.startswith(
                               ('http://', 'https://')) else forum_link


                       success = add_admin_to_sheet(sheet, nickname, date_val, vk_link, forum_link)
                       if success:
                           last_row = get_last_non_empty_row(sheet)
                           send_message(f"‚úÖ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä {nickname} —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!\n"
                                        f"–î–∞—Ç–∞: {date_val}\n"
                                        f"VK: {vk_link} (–ø–æ–¥—á–µ—Ä–∫–Ω—É—Ç–∞—è —Å—Å—ã–ª–∫–∞)\n"
                                        f"–§–æ—Ä—É–º: {forum_link} (–ø–æ–¥—á–µ—Ä–∫–Ω—É—Ç–∞—è —Å—Å—ã–ª–∫–∞)\n"
                                        f"–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ —Å—Ç—Ä–æ–∫—É: {last_row}\n"
                                        f"–î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±–≤–æ–¥–∫–∞ '–í—Å–µ –≥—Ä–∞–Ω–∏—Ü—ã' –∫ —Å—Ç—Ä–æ–∫–µ")
                       else:
                           send_message("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ —Ç–∞–±–ª–∏—Ü—É.")




                   except Exception as e:
                       send_message(f"‚ùå –û—à–∏–±–∫–∞: {str(e)}")




               elif text.startswith('/grant'):
                   if user_id not in DEVELOPERS and get_user_role(user_id) not in ['admin']:
                       send_message("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –≤—ã–¥–∞—á–∏ –¥–æ—Å—Ç—É–ø–∞!")
                       continue


                   parts = text.split()
                   if len(parts) < 3:
                       send_message("‚ùå –§–æ—Ä–º–∞—Ç: /grant [VK_ID] [—Ä–æ–ª—å]\n"
                                    "–†–æ–ª–∏: editor (—Ä–µ–¥–∞–∫—Ç–æ—Ä), admin (–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä)\n"
                                    "–ü—Ä–∏–º–µ—Ä—ã:\n"
                                    "/grant 123456789 editor - –≤—ã–¥–∞—Ç—å –ø—Ä–∞–≤–∞ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞\n"
                                    "/grant 987654321 admin - –≤—ã–¥–∞—Ç—å –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞")
                       continue


                   try:
                       target_user = int(parts[1])
                       role_type = parts[2].lower()


                       if target_user in DEVELOPERS:
                           send_message("‚ùå –ù–µ–ª—å–∑—è –∏–∑–º–µ–Ω—è—Ç—å –ø—Ä–∞–≤–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞!")
                           continue


                       if role_type == 'editor':
                           permissions = ['edit_table', 'add_admin', 'lvlup', 'search', 'promotionlist']
                           role_name = "—Ä–µ–¥–∞–∫—Ç–æ—Ä"
                       elif role_type == 'admin':
                           permissions = ['add_admin', 'add_editor', 'edit_table', 'grant_access', 'lvlup', 'search',
                                          'revoke_super', 'promotionlist']
                           role_name = "–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä"
                       else:
                           send_message("‚ùå –ù–µ–≤–µ—Ä–Ω–∞—è —Ä–æ–ª—å. –î–æ–ø—É—Å—Ç–∏–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è: editor, admin")
                           continue


                       success, message = add_user_rights(target_user, role_type, permissions, user_id)


                       if success:
                           try:
                               vk.messages.send(
                                   user_id=target_user,
                                   message=f"üéâ –í–∞–º –±—ã–ª–∏ –≤—ã–¥–∞–Ω—ã –ø—Ä–∞–≤–∞ {role_name}!\n"
                                           f"–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞.",
                                   random_id=0
                               )
                           except:
                               pass


                           send_message(f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {target_user} –≤—ã–¥–∞–Ω—ã –ø—Ä–∞–≤–∞ {role_name}!\n"
                                        f"–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è: {', '.join(permissions)}")
                       else:
                           send_message(f"‚ùå {message}")
                   except ValueError:
                       send_message("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç VK ID. –î–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º.")




               elif text.startswith('/revoke'):
                   if user_id not in DEVELOPERS and not has_permission(user_id, 'grant_access'):
                       send_message("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –æ—Ç–∑—ã–≤–∞ –¥–æ—Å—Ç—É–ø–∞!")
                       continue


                   parts = text.split()
                   if len(parts) < 2:
                       send_message("‚ùå –§–æ—Ä–º–∞—Ç: /revoke [VK_ID]\n"
                                    "–ü—Ä–∏–º–µ—Ä: /revoke 123456789")
                       continue


                   try:
                       target_user = int(parts[1])
                       if target_user not in user_rights:
                           send_message(f"‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {target_user} –Ω–µ –∏–º–µ–µ—Ç –ø—Ä–∞–≤.")
                           continue


                       success, message = remove_user_rights(target_user, user_id)
                       send_message(f"{'‚úÖ' if success else '‚ùå'} {message}")
                   except ValueError:
                       send_message("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç VK ID.")




               elif text.startswith('/edit'):
                   if user_id not in DEVELOPERS and get_user_role(user_id) not in ['editor', 'admin']:
                       send_message("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã!")
                       continue


                   parts = text.split(maxsplit=3)
                   if len(parts) < 4:
                       send_message("‚ùå –§–æ—Ä–º–∞—Ç: /edit [—Å—Ç—Ä–æ–∫–∞] [—Å—Ç–æ–ª–±–µ—Ü] [–Ω–æ–≤–æ–µ_–∑–Ω–∞—á–µ–Ω–∏–µ]\n"
                                    "–ò–ª–∏: /edit [–Ω–∏–∫] [–ø–æ–ª–µ] [–Ω–æ–≤–æ–µ_–∑–Ω–∞—á–µ–Ω–∏–µ] –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ –Ω–∏–∫—É\n\n"
                                    "–ü—Ä–∏–º–µ—Ä—ã:\n"
                                    "/edit 5 –ù–∏–∫ –ù–æ–≤–æ–µ–ò–º—è\n"
                                    "/edit 5 Nick_Name –ù–æ–≤–æ–µ–ò–º—è\n"
                                    "/edit Vasya –ù–∏–∫ –ù–æ–≤—ã–π–ù–∏–∫\n"
                                    "/edit Vasya –î–æ–ª–∂–Ω–æ—Å—Ç—å –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä\n"
                                    "/edit 10 VK https://vk.com/newlink\n\n"
                                    "–î–æ—Å—Ç—É–ø–Ω—ã–µ –∏–º–µ–Ω–∞ —Å—Ç–æ–ª–±—Ü–æ–≤: LVL, –ù–∏–∫, –î–æ–ª–∂–Ω–æ—Å—Ç—å, VK, –§–æ—Ä—É–º, –î–∞—Ç–∞_–Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –∏ –¥—Ä.")
                       continue


                   try:
                       try:
                           row_num = int(parts[1])
                           column_name = parts[2]
                           new_value = parts[3]
                           success, message = edit_cell_in_sheet(sheet, row_num, column_name, new_value)
                       except ValueError:
                           nickname = parts[1]
                           field_to_edit = parts[2]
                           new_value = parts[3]
                           success, message = edit_admin_in_sheet(sheet, nickname, field_to_edit, new_value)


                       send_message(f"{'‚úÖ' if success else '‚ùå'} {message}")
                   except Exception as e:
                       send_message(f"‚ùå –û—à–∏–±–∫–∞: {str(e)}")




               elif text.startswith('/unadmin'):
                   if user_id not in DEVELOPERS and get_user_role(user_id) not in ['admin']:
                       send_message("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤!")
                       continue


                   parts = text.split()
                   if len(parts) < 2:
                       send_message("‚ùå –§–æ—Ä–º–∞—Ç: /unadmin [–ù–∏–∫]\n"
                                    "–ü—Ä–∏–º–µ—Ä: /unadmin Vasya")
                       continue


                   nickname = parts[1]
                   try:
                       success, message = unadmin_from_sheet(sheet, nickname)
                       send_message(f"{'‚úÖ' if success else '‚ùå'} {message}")
                   except Exception as e:
                       send_message(f"‚ùå –û—à–∏–±–∫–∞: {str(e)}")




               elif text.startswith('/search'):
                   if user_id not in DEVELOPERS and get_user_role(user_id) not in ['editor', 'admin']:
                       send_message("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –ø–æ–∏—Å–∫–∞!")
                       continue


                   parts = text.split(maxsplit=1)
                   if len(parts) < 2:
                       send_message("‚ùå –§–æ—Ä–º–∞—Ç: /search [–∑–∞–ø—Ä–æ—Å]\n"
                                    "–ü—Ä–∏–º–µ—Ä: /search Vasya\n"
                                    "–ò—â–µ—Ç –ø–æ –Ω–∏–∫—É")
                       continue


                   search_term = parts[1]
                   try:
                       success, message = search_admin_in_sheet(sheet, search_term)
                       send_message(message)
                   except Exception as e:
                       send_message(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: {str(e)}")




               elif text == '/stats':
                   if user_id not in DEVELOPERS and get_user_role(user_id) not in ['editor', 'admin']:
                       send_message("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏!")
                       continue


                   try:
                       success, message = get_admin_stats(sheet)
                       send_message(message)
                   except Exception as e:
                       send_message(f"‚ùå –û—à–∏–±–∫–∞: {str(e)}")




               elif text.startswith('/lvlup'):
                   if user_id not in DEVELOPERS and get_user_role(user_id) not in ['editor', 'admin']:
                       send_message("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è —É—Ä–æ–≤–Ω—è!")
                       continue


                   parts = text.split()
                   if len(parts) < 4:
                       send_message("‚ùå –§–æ—Ä–º–∞—Ç: /lvlup [–ù–∏–∫] [lvl] [–î–∞—Ç–∞]\n"
                                    "–ü—Ä–∏–º–µ—Ä: /lvlup Vasya 2 15.03.2024\n"
                                    "–£—Ä–æ–≤–µ–Ω—å (lvl): –æ—Ç 1 –¥–æ 5\n"
                                    "–î–∞—Ç–∞: –≤ —Ñ–æ—Ä–º–∞—Ç–µ –î–î.–ú–ú.–ì–ì–ì–ì")
                       continue


                   nickname = parts[1]
                   try:
                       lvl = int(parts[2])
                   except ValueError:
                       send_message("‚ùå –£—Ä–æ–≤–µ–Ω—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º –æ—Ç 1 –¥–æ 5")
                       continue


                   date_val = parts[3]


                   if '.' not in date_val or len(date_val.split('.')) != 3:
                       send_message("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –î–î.–ú–ú.–ì–ì–ì–ì")
                       continue


                   if lvl < 1 or lvl > 5:
                       send_message("‚ùå –£—Ä–æ–≤–µ–Ω—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 1 –¥–æ 5")
                       continue


                   try:
                       success, message = lvlup_admin(sheet, nickname, lvl, date_val)
                       send_message(message)
                   except Exception as e:
                       send_message(f"‚ùå –û—à–∏–±–∫–∞: {str(e)}")




               elif text.startswith('/promotionlist'):
                   # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–ª—è /promotionlist
                   if user_id not in DEVELOPERS and get_user_role(user_id) not in ['editor', 'admin']:
                       send_message("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è —Å–ø–∏—Å–∫–∞ –Ω–∞ –ø–æ–≤—ã—à–µ–Ω–∏–µ!")
                       continue


                   try:
                       success, promotion_list = get_promotion_list(sheet)


                       if not success:
                           send_message("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ –Ω–∞ –ø–æ–≤—ã—à–µ–Ω–∏–µ.")
                           continue


                       if not promotion_list:
                           send_message("‚úÖ –ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –Ω–µ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤, —É –∫–æ—Ç–æ—Ä—ã—Ö –ø–æ–¥–æ—à–µ–ª —Å—Ä–æ–∫ –ø–æ–≤—ã—à–µ–Ω–∏—è.")
                           continue


                       # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ —Å–ø–∏—Å–∫–æ–º –≤ –Ω–æ–≤–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
                       message = "üìã –°–ü–ò–°–û–ö –ù–ê –ü–û–í–´–®–ï–ù–ò–ï:\n\n"


                       # –í—ã–≤–æ–¥–∏–º —Å–ø–∏—Å–æ–∫ –≤ —Ñ–æ—Ä–º–∞—Ç–µ: Nick_Name lvl > lvl (—Å—Ä–æ–∫)
                       for i, admin in enumerate(promotion_list, 1):
                           message += f"{admin['nickname']} {admin['current_lvl']} > {admin['next_lvl']} ({admin['promotion_date']})\n"


                       message += f"\n–í—Å–µ–≥–æ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤: {len(promotion_list)}\n"
                       message += f"üìÖ –î–∞—Ç–∞ –ø–æ–≤—ã—à–µ–Ω–∏—è –±—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–µ —á–∏—Å–ª–æ"


                       # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π (–æ–¥–Ω–∞ –∫–Ω–æ–ø–∫–∞)
                       send_message_with_keyboard(send_target, message, promotion_list, vk)


                   except Exception as e:
                       send_message(f"‚ùå –û—à–∏–±–∫–∞: {str(e)}")




               elif text == '/fixlinks':
                   if user_id not in DEVELOPERS and get_user_role(user_id) not in ['admin']:
                       send_message("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—Å—ã–ª–æ–∫!")
                       continue


                   try:
                       success, message = fix_existing_hyperlinks(sheet)
                       send_message(f"{'‚úÖ' if success else '‚ùå'} {message}")
                   except Exception as e:
                       send_message(f"‚ùå –û—à–∏–±–∫–∞: {str(e)}")




               elif text == '/resetet':
                   if user_id not in DEVELOPERS and get_user_role(user_id) not in ['admin']:
                       send_message("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –æ–±–Ω—É–ª–µ–Ω–∏—è –Ω–µ–∞–∫—Ç–∏–≤–æ–≤!")
                       continue


                   try:
                       success, message = reset_et_columns(sheet)
                       send_message(message)
                   except Exception as e:
                       send_message(f"‚ùå –û—à–∏–±–∫–∞: {str(e)}")




               elif text == '/myrights':
                   role = get_user_role(user_id)
                   is_dev = user_id in DEVELOPERS


                   if is_dev:
                       role_emoji = "üë®‚Äçüíª –†–ê–ó–†–ê–ë–û–¢–ß–ò–ö"
                       permissions_list = "‚Ä¢ –í—Å–µ –ø—Ä–∞–≤–∞ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)\n‚Ä¢ /addadmin - –¥–æ–±–∞–≤–ª—è—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤\n‚Ä¢ /lvlup - –ø–æ–≤—ã—à–∞—Ç—å —É—Ä–æ–≤–µ–Ω—å\n‚Ä¢ /edit - —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É\n‚Ä¢ /search - –ø–æ–∏—Å–∫\n‚Ä¢ /grant - –≤—ã–¥–∞—á–∞ –ø—Ä–∞–≤\n‚Ä¢ /revoke - –æ—Ç–∑—ã–≤ –ø—Ä–∞–≤\n‚Ä¢ /unadmin - —É–¥–∞–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤\n‚Ä¢ /resetet - –æ–±–Ω—É–ª–µ–Ω–∏–µ –Ω–µ–∞–∫—Ç–∏–≤–æ–≤\n‚Ä¢ /promotionlist - —Å–ø–∏—Å–æ–∫ –Ω–∞ –ø–æ–≤—ã—à–µ–Ω–∏–µ"
                   elif role == 'admin':
                       role_emoji = "üëë –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä"
                       permissions_list = "‚Ä¢ –î–æ–±–∞–≤–ª—è—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ (/addadmin)\n‚Ä¢ –í—ã–¥–∞–≤–∞—Ç—å –ø—Ä–∞–≤–∞ (/grant)\n‚Ä¢ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É (/edit)\n‚Ä¢ –ü–æ–≤—ã—à–∞—Ç—å —É—Ä–æ–≤–µ–Ω—å (/lvlup)\n‚Ä¢ –ò—Å–∫–∞—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ (/search)\n‚Ä¢ –ü—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É (/stats)\n‚Ä¢ –û—Ç–∑—ã–≤–∞—Ç—å –ø—Ä–∞–≤–∞ (/revoke)\n‚Ä¢ –£–¥–∞–ª—è—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ (/unadmin)\n‚Ä¢ –û–±–Ω—É–ª—è—Ç—å –Ω–µ–∞–∫—Ç–∏–≤—ã (/resetet)\n‚Ä¢ –§–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Å–ø–∏—Å–æ–∫ –Ω–∞ –ø–æ–≤—ã—à–µ–Ω–∏–µ (/promotionlist)"
                   elif role == 'editor':
                       role_emoji = "‚úèÔ∏è –†–µ–¥–∞–∫—Ç–æ—Ä"
                       permissions_list = "‚Ä¢ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É (/edit)\n‚Ä¢ –î–æ–±–∞–≤–ª—è—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ (/addadmin)\n‚Ä¢ –ü–æ–≤—ã—à–∞—Ç—å —É—Ä–æ–≤–µ–Ω—å (/lvlup)\n‚Ä¢ –ò—Å–∫–∞—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ (/search)\n‚Ä¢ –ü—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É (/stats)\n‚Ä¢ –§–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Å–ø–∏—Å–æ–∫ –Ω–∞ –ø–æ–≤—ã—à–µ–Ω–∏–µ (/promotionlist)"
                   else:
                       role_emoji = "üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"
                       permissions_list = "‚Ä¢ –¢–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä –∫–æ–º–∞–Ω–¥ –ø–æ–º–æ—â–∏ (/help)"


                   developer_status = " (–†–ê–ó–†–ê–ë–û–¢–ß–ò–ö)" if is_dev else ""
                   send_message(f"üìã –í–∞—à–∏ –ø—Ä–∞–≤–∞:\n\n"
                                f"–†–æ–ª—å: {role_emoji}{developer_status}\n"
                                f"–í–∞—à ID: {user_id}\n\n"
                                f"–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n"
                                f"{permissions_list}")




               elif text == '/listusers':
                   if user_id not in DEVELOPERS and get_user_role(user_id) not in ['admin']:
                       send_message("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π!")
                       continue


                   if not user_rights:
                       message = "üìã –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –ø—Ä–∞–≤–∞–º–∏ –ø—É—Å—Ç."
                   else:
                       message = "üìã –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å –ø—Ä–∞–≤–∞–º–∏:\n\n"
                       for uid, rights in user_rights.items():
                           role_type = rights.get('role', 'user')
                           added_by = rights.get('added_by', '—Å–∏—Å—Ç–µ–º–∞')
                           added_date = rights.get('added_date', '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')
                           is_developer = rights.get('is_developer', False)
                           developer_mark = "üë®‚Äçüíª –†–ê–ó–†–ê–ë–û–¢–ß–ò–ö" if is_developer else ""
                           admin_mark = "üëë" if role_type == 'admin' and not is_developer else ""
                           editor_mark = "‚úèÔ∏è" if role_type == 'editor' else ""


                           vk_link = f"https://vk.com/id{uid}"


                           message += f"{developer_mark}{admin_mark}{editor_mark} ID: {uid}\n"
                           message += f" –°—Å—ã–ª–∫–∞: {vk_link}\n"
                           message += f" –†–æ–ª—å: {role_type}\n"
                           message += f" –î–æ–±–∞–≤–∏–ª: {added_by}\n"
                           message += f" –î–∞—Ç–∞: {added_date}\n\n"


                   send_message(message)




               elif text == '/developers':
                   message = "üë®‚Äçüíª –†–ê–ó–†–ê–ë–û–¢–ß–ò–ö–ò (–Ω–µ–ª—å–∑—è –æ—Ç–æ–∑–≤–∞—Ç—å –ø—Ä–∞–≤–∞):\n\n"
                   for developer_id in DEVELOPERS:
                       vk_link = f"https://vk.com/id{developer_id}"
                       message += f"‚Ä¢ {developer_id} - {vk_link}\n"
                   send_message(message)




               elif text == '/help':
                   help_text = ("üìã –°–ò–°–¢–ï–ú–ê –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ü–†–ê–í–ê–ú–ò (–û–ë–ù–û–í–õ–ï–ù–ê)\n\n"
                                "–î–ª—è –≤—Å–µ—Ö:\n"
                                "‚Ä¢ /help - —ç—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞\n"
                                "‚Ä¢ /myrights - –º–æ–∏ –ø—Ä–∞–≤–∞\n"
                                "‚Ä¢ /developers - —Å–ø–∏—Å–æ–∫ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤\n\n"
                                "–î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ (—Ç–æ–ª—å–∫–æ –≤ –±–µ—Å–µ–¥–∞—Ö):\n"
                                "‚Ä¢ /addserver [–Ω–∞–∑–≤–∞–Ω–∏–µ_—Ç–∞–±–ª–∏—Ü—ã] - –ø—Ä–∏–≤—è–∑–∞—Ç—å —á–∞—Ç –∫ —Ç–∞–±–ª–∏—Ü–µ\n"
                                "‚Ä¢ /removeserver - —É–¥–∞–ª–∏—Ç—å –ø—Ä–∏–≤—è–∑–∫—É —á–∞—Ç–∞\n"
                                "‚Ä¢ /serverinfo - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–∏–≤—è–∑–∫–µ —á–∞—Ç–∞\n\n"
                                "–î–ª—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–æ–≤ (editor) –∏ –≤—ã—à–µ:\n"
                                "‚Ä¢ /edit [—Å—Ç—Ä–æ–∫–∞/–Ω–∏–∫] [–Ω–∞–∑–≤–∞–Ω–∏–µ —Å—Ç–æ–ª–±—Ü–∞] [–Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ] - —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å\n"
                                "‚Ä¢ /search [–Ω–∏–∫] - –ø–æ–∏—Å–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞\n"
                                "‚Ä¢ /stats - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞\n"
                                "‚Ä¢ /addadmin [–Ω–∏–∫] [–¥–∞—Ç–∞] [V–ö] [—Ñ–æ—Ä—É–º] - –¥–æ–±–∞–≤–∏—Ç—å –∞–¥–º–∏–Ω–∞ (—Å –æ–±–≤–æ–¥–∫–æ–π)\n"
                                "‚Ä¢ /lvlup [–ù–∏–∫] [lvl] [–î–∞—Ç–∞] - –ø–æ–≤—ã—Å–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å (—Å –æ–±–≤–æ–¥–∫–æ–π)\n"
                                "‚Ä¢ /promotionlist - —Å–ø–∏—Å–æ–∫ –Ω–∞ –ø–æ–≤—ã—à–µ–Ω–∏–µ (—Å –∫–Ω–æ–ø–∫–æ–π –ø–æ–≤—ã—à–µ–Ω–∏—è –≤—Å–µ—Ö)\n\n"
                                "–î–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ (admin) –∏ –≤—ã—à–µ:\n"
                                "‚Ä¢ /unadmin [–Ω–∏–∫] - —É–¥–∞–ª–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞\n"
                                "‚Ä¢ /grant [V–ö_ID] [—Ä–æ–ª—å] - –≤—ã–¥–∞—Ç—å –ø—Ä–∞–≤–∞ (editor/admin)\n"
                                "‚Ä¢ /revoke [V–ö_ID] - –æ—Ç–æ–∑–≤–∞—Ç—å –ø—Ä–∞–≤–∞\n"
                                "‚Ä¢ /listusers - —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –ø—Ä–∞–≤–∞–º–∏\n"
                                "‚Ä¢ /resetet - –æ–±–Ω—É–ª–∏—Ç—å –Ω–µ–∞–∫—Ç–∏–≤—ã\n\n"
                                "–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n"
                                "‚Ä¢ '+–Ω–≥' - –≤—Ä–µ–º—è –¥–æ –ù–æ–≤–æ–≥–æ –≥–æ–¥–∞\n"
                                "‚Ä¢ '+–ª–µ—Ç–æ' - –≤—Ä–µ–º—è –¥–æ –ª–µ—Ç–∞\n"
                                "‚Ä¢ '–±–æ—Ç' - —Å–ª—É—á–∞–π–Ω—ã–π –æ—Ç–≤–µ—Ç –±–æ—Ç–∞\n\n"
                                "–ü–û–í–´–®–ï–ù–ò–ï –£–†–û–í–ù–Ø:\n"
                                "–û–¥–∏–Ω–æ—á–Ω–æ–µ: –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ:\n"
                                "Nick_Name 1 > 2 (01.01.2024)\n\n"
                                "–ú–∞—Å—Å–æ–≤–æ–µ: –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫ –≤ —Ñ–æ—Ä–º–∞—Ç–µ:\n"
                                "Nick_Name 1 > 2 (01.01.2024)\n"
                                "Nick_Name 2 > 3 (02.01.2024)\n"
                                "Nick_Name 3 > 4 (03.01.2024)\n\n"
                                "–ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ—è–≤–∏—Ç—Å—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å –∫–Ω–æ–ø–∫–æ–π '–î–∞, –ø–æ–≤—ã—Å–∏—Ç—å'")
                   send_message(help_text)




               elif text.startswith('/'):
                   send_message("‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞. –í–≤–µ–¥–∏—Ç–µ /help –¥–ª—è —Å–ø–∏—Å–∫–∞ –∫–æ–º–∞–Ω–¥.")




   except Exception as e:
       print(f"\n{'='*60}")
       print(f"!!! –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: {e}")
       print(f"{'='*60}")
       import traceback
       traceback.print_exc()
       time.sleep(5)




if __name__ == '__main__':
   main()
