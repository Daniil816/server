import os
import pickle
import vk_api
import time
import gspread
import json
from vk_api.longpoll import VkLongPoll, VkEventType
from google.auth.transport.requests import Request
from google_auth_oauthlib.flow import InstalledAppFlow

# --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---
VK_TOKEN = 'vk1.a.hnuRWe9zj3RAiXc-2Jhi3ix1wDAYPeA3vv5EuURXKIptRpDR8G948Q891ndVNMuOnz69LxbvAbXQVACkIlLuhQidngypMtSGg4Sv6keay8XH-0WZOs9_L9m4LmXcV3F8pg3dyOTiujoSmzTqi9j2g5j_txPUcKILy_kbavL40GLZ_qLhzbuQjBI_PokDT1cExggdvo2CSgUOsdZBkFayLQ'
SPREADSHEET_NAME = '29 | –†–∞–±–æ—Ç–∞'
RIGHTS_FILE = 'user_rights.json'
# –°–£–ü–ï–†–ê–î–ú–ò–ù–´ - –Ω–µ–ª—å–∑—è –æ—Ç–æ–∑–≤–∞—Ç—å –ø—Ä–∞–≤–∞
SUPER_ADMINS = [807253464, 679050151]
SCOPES = ['https://www.googleapis.com/auth/spreadsheets']
user_rights = {}

def load_user_rights():
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –ø—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ —Ñ–∞–π–ª–∞"""
    global user_rights
    if os.path.exists(RIGHTS_FILE):
        try:
            with open(RIGHTS_FILE, 'r', encoding='utf-8') as f:
                user_rights = json.load(f)
            user_rights = {int(k): v for k, v in user_rights.items()}
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∞–≤: {e}")
            user_rights = {}
    else:
        user_rights = {}
    
    # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ–º —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω–æ–≤, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç –≤ —Ñ–∞–π–ª–µ
    for super_admin_id in SUPER_ADMINS:
        if super_admin_id not in user_rights:
            user_rights[super_admin_id] = {
                'role': 'super_admin',
                'permissions': ['add_admin', 'add_editor', 'edit_table', 'grant_access', 'revoke_super'],
                'is_super': True,
                'added_by': 'system',
                'added_date': time.strftime("%d.%m.%Y %H:%M:%S")
            }
    save_user_rights()

def save_user_rights():
    """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ —Ñ–∞–π–ª"""
    try:
        with open(RIGHTS_FILE, 'w', encoding='utf-8') as f:
            json.dump(user_rights, f, ensure_ascii=False, indent=2)
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–∞–≤: {e}")

def get_user_role(user_id):
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    if user_id in user_rights:
        return user_rights[user_id].get('role', 'user')
    return 'user'

def is_super_admin(user_id):
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω–æ–º"""
    return user_id in SUPER_ADMINS

def has_permission(user_id, permission):
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –µ—Å—Ç—å –ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ"""
    if user_id in user_rights:
        permissions = user_rights[user_id].get('permissions', [])
        return permission in permissions
    return False

def can_revoke_rights(revoker_id, target_id):
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –º–æ–∂–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–æ–∑–≤–∞—Ç—å –ø—Ä–∞–≤–∞ —É –¥—Ä—É–≥–æ–≥–æ"""
    if is_super_admin(revoker_id):
        return not is_super_admin(target_id)
    if has_permission(revoker_id, 'grant_access'):
        return not (is_super_admin(target_id) or has_permission(target_id, 'grant_access'))
    return False

def add_user_rights(user_id, role, permissions, added_by):
    """–î–æ–±–∞–≤–ª—è–µ—Ç –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –ø—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    if is_super_admin(user_id):
        return False, "–ù–µ–ª—å–∑—è –∏–∑–º–µ–Ω—è—Ç—å –ø—Ä–∞–≤–∞ —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω–∞!"
    
    user_rights[user_id] = {
        'role': role,
        'permissions': permissions,
        'added_by': added_by,
        'added_date': time.strftime("%d.%m.%Y %H:%M:%S"),
        'is_super': False
    }
    save_user_rights()
    return True, "–ü—Ä–∞–≤–∞ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω—ã"

def remove_user_rights(user_id, remover_id):
    """–£–¥–∞–ª—è–µ—Ç –ø—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    if not can_revoke_rights(remover_id, user_id):
        return False, "–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –æ—Ç–∑—ã–≤–∞ –ø—Ä–∞–≤ —É —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è!"
    
    if user_id in user_rights:
        if user_rights[user_id].get('is_super', False):
            return False, "–ù–µ–ª—å–∑—è —É–¥–∞–ª—è—Ç—å —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω–∞!"
        
        role = user_rights[user_id].get('role', 'user')
        del user_rights[user_id]
        save_user_rights()
        return True, f"–ü—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} ({role}) —É—Å–ø–µ—à–Ω–æ –æ—Ç–æ–∑–≤–∞–Ω—ã!"
    return False, "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω"

def get_google_client():
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ Google Sheets"""
    creds = None
    if os.path.exists('token.pickle'):
        with open('token.pickle', 'rb') as token:
            creds = pickle.load(token)
    
    if not creds or not creds.valid:
        if creds and creds.expired and creds.refresh_token:
            creds.refresh(Request())
        else:
            flow = InstalledAppFlow.from_client_secrets_file('client_secret.json', SCOPES)
            print("–ù—É–∂–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –¥–æ—Å—Ç—É–ø –≤ –±—Ä–∞—É–∑–µ—Ä–µ...")
            creds = flow.run_local_server(port=8080)
        
        with open('token.pickle', 'wb') as token:
            pickle.dump(creds, token)
    
    return gspread.authorize(creds)

def set_cell_value(row_data, header_map, header_name, value, default_index=None):
    """–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –≤ —è—á–µ–π–∫—É –ø–æ –∏–º–µ–Ω–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –∏–ª–∏ –∏–Ω–¥–µ–∫—Å—É"""
    if header_name in header_map:
        col_index = header_map[header_name]
        # –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ –∫–æ—Ä–æ—á–µ, —á–µ–º –Ω—É–∂–Ω–æ - —Ä–∞—Å—à–∏—Ä—è–µ–º –µ—ë
        while len(row_data) <= col_index:
            row_data.append('')
        row_data[col_index] = value
        return True
    elif default_index is not None:
        while len(row_data) <= default_index:
            row_data.append('')
        row_data[default_index] = value
        return True
    return False

def get_next_admin_number(sheet):
    """–ü–æ–ª—É—á–∞–µ—Ç —Å–ª–µ–¥—É—é—â–∏–π –Ω–æ–º–µ—Ä –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (—Å—Ç–æ–ª–±–µ—Ü B)"""
    try:
        # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è —Å—Ç–æ–ª–±—Ü–∞ B (–∏–Ω–¥–µ–∫—Å 1)
        all_values = sheet.get_all_values()
        # –ò—â–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —á–∏—Å–ª–æ –≤ —Å—Ç–æ–ª–±—Ü–µ B, –Ω–∞—á–∏–Ω–∞—è —Å–æ –≤—Ç–æ—Ä–æ–π —Å—Ç—Ä–æ–∫–∏
        max_number = 0
        for i, row in enumerate(all_values):
            if i == 0:  # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
                continue
            if len(row) > 1 and row[1].strip():  # –°—Ç–æ–ª–±–µ—Ü B (–∏–Ω–¥–µ–∫—Å 1)
                try:
                    num = int(row[1].strip())
                    if num > max_number:
                        max_number = num
                except ValueError:
                    continue
        return max_number + 1
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–æ–º–µ—Ä–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞: {e}")
        return 1

def add_admin_to_sheet(sheet, headers, header_map, nickname, date_val, vk_link, forum_link):
    """–î–æ–±–∞–≤–ª—è–µ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –≤ —Ç–∞–±–ª–∏—Ü—É"""
    try:
        # –ü–æ–ª—É—á–∞–µ–º —Å–ª–µ–¥—É—é—â–∏–π –Ω–æ–º–µ—Ä –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
        admin_number = get_next_admin_number(sheet)
        
        # –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç–æ–ª–±—Ü–æ–≤ –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
        num_columns = len(headers)
        
        # –°–æ–∑–¥–∞–µ–º –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É —Å –Ω—É–∂–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —Å—Ç–æ–ª–±—Ü–æ–≤
        row_data = [''] * num_columns
        
        # –§–æ—Ä–º—É–ª—ã –¥–ª—è —Å—Ç–æ–ª–±—Ü–æ–≤ M –∏ N
        formula_m = '=–ï–°–õ–ò(INDIRECT("B"&ROW())=1;"–ñ–¥—ë—Ç 2 —É—Ä–æ–≤–µ–Ω—å";–ï–°–õ–ò(INDIRECT("B"&ROW())=2;"–ñ–¥—ë—Ç 3 —É—Ä–æ–≤–µ–Ω—å";–ï–°–õ–ò(INDIRECT("B"&ROW())=3;"–ñ–¥—ë—Ç 4 —É—Ä–æ–≤–µ–Ω—å";–ï–°–õ–ò(INDIRECT("B"&ROW())=4;"–ñ–¥—ë—Ç 5 —É—Ä–æ–≤–µ–Ω—å";–ï–°–õ–ò(INDIRECT("B"&ROW())=5;"–°–ø–µ—Ü. –°–ª–µ–¥—è—â–∏–π";"–ù–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–ª —É—Ä–æ–≤–µ–Ω—å")))))'
        formula_n = '=–ï–°–õ–ò(INDIRECT("M"&ROW())="–ñ–¥—ë—Ç 2 —É—Ä–æ–≤–µ–Ω—å";INDIRECT("L"&ROW())+7;–ï–°–õ–ò(INDIRECT("M"&ROW())="–ñ–¥—ë—Ç 3 —É—Ä–æ–≤–µ–Ω—å";INDIRECT("L"&ROW())+31;–ï–°–õ–ò(INDIRECT("M"&ROW())="–ñ–¥—ë—Ç 4 —É—Ä–æ–≤–µ–Ω—å";INDIRECT("L"&ROW())+60;–ï–°–õ–ò(INDIRECT("M"&ROW())="–ñ–¥—ë—Ç 5 —É—Ä–æ–≤–µ–Ω—å";"–ü–æ –¥–æ–≤–µ—Ä–∏—é";–ï–°–õ–ò(INDIRECT("M"&ROW())="–°–ø–µ—Ü. –°–ª–µ–¥—è—â–∏–π";"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ";"–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Å—Ç–∞—Ç—É—Å")))))'
        
        # –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
        set_cell_value(row_data, header_map, 'LVL', '1', 1)  # –°—Ç–æ–ª–±–µ—Ü B
        set_cell_value(row_data, header_map, 'Nick_Name', nickname, 2)  # –°—Ç–æ–ª–±–µ—Ü C
        set_cell_value(row_data, header_map, '–î–æ–ª–∂–Ω–æ—Å—Ç—å', '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä', 3)  # –°—Ç–æ–ª–±–µ—Ü D
        set_cell_value(row_data, header_map, 'VK', vk_link, 4)  # –°—Ç–æ–ª–±–µ—Ü E
        
        # –§–æ—Ä—É–º —Å—Å—ã–ª–∫–∞ —Å –≥–∏–ø–µ—Ä—Å—Å—ã–ª–∫–æ–π
        forum_cell = f'=HYPERLINK("{forum_link}"; "LINK")'
        set_cell_value(row_data, header_map, '–°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–æ—Ä—É–º', forum_cell, 5)  # –°—Ç–æ–ª–±–µ—Ü F
        
        set_cell_value(row_data, header_map, '–î–∞—Ç–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞ 1', date_val, 6)  # –°—Ç–æ–ª–±–µ—Ü G
        set_cell_value(row_data, header_map, '–î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–æ–≤—ã—à–µ–Ω–∏—è', date_val, 11)  # –°—Ç–æ–ª–±–µ—Ü L
        set_cell_value(row_data, header_map, '–ñ–¥–µ—Ç —É—Ä–æ–≤–µ–Ω—å', formula_m, 12)  # –°—Ç–æ–ª–±–µ—Ü M
        set_cell_value(row_data, header_map, '–î–∞—Ç–∞ –ø–æ–≤—ã—à–µ–Ω–∏—è', formula_n, 13)  # –°—Ç–æ–ª–±–µ—Ü N
        
        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
        set_cell_value(row_data, header_map, '–†–∞–∑–æ–≤—ã–µ', "–†–∞–∑–æ–≤—ã–µ [0/3]", 16)  # –°—Ç–æ–ª–±–µ—Ü Q
        set_cell_value(row_data, header_map, '–î–ª–∏—Ç–µ–ª—å–Ω—ã–µ', "–î–ª–∏—Ç–µ–ª—å–Ω—ã–µ [0/1]", 17)  # –°—Ç–æ–ª–±–µ—Ü R
        set_cell_value(row_data, header_map, '–ü—è—Ç–∏–¥–µ—Å—è—Ç–∏–ø—Ä–æ—Ü–µ–Ω—Ç–Ω—ã–µ', "–ü—è—Ç–∏–¥–µ—Å—è—Ç–∏–ø—Ä–æ—Ü–µ–Ω—Ç–Ω—ã–π [0/2]", 18)  # –°—Ç–æ–ª–±–µ—Ü S
        set_cell_value(row_data, header_map, '–í—ã–≥–æ–≤–æ—Ä—ã', "–í—ã–≥–æ–≤–æ—Ä—ã [0/3]", 19)  # –°—Ç–æ–ª–±–µ—Ü T
        set_cell_value(row_data, header_map, '–í—ã–≥–æ–≤–æ—Ä—ã –±/—Å', "–ò–∑ –Ω–∏—Ö –≤—ã–≥–æ–≤–æ—Ä—ã –±/—Å [0]", 20)  # –°—Ç–æ–ª–±–µ—Ü U
        set_cell_value(row_data, header_map, '–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è', "–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è [0/3]", 21)  # –°—Ç–æ–ª–±–µ—Ü V
        set_cell_value(row_data, header_map, '–õ–æ–≥–∏ –Ω–æ—Ä–º—ã', "–õ–æ–≥–∏ –Ω–æ—Ä–º—ã [0/3]", 22)  # –°—Ç–æ–ª–±–µ—Ü W
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –≤ —Ç–∞–±–ª–∏—Ü—É
        sheet.append_row(values=row_data, value_input_option='USER_ENTERED')
        print(f"–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –¥–æ–±–∞–≤–ª–µ–Ω: –Ω–∏–∫={nickname}, –Ω–æ–º–µ—Ä={admin_number}")
        print(f"–î–∞–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏: {row_data}")
        return True
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞: {e}")
        import traceback
        traceback.print_exc()
        return False

def edit_cell_in_sheet(sheet, row_number, column_name, new_value, header_map):
    """–†–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç —è—á–µ–π–∫—É –≤ —Ç–∞–±–ª–∏—Ü–µ"""
    try:
        if column_name in header_map:
            col_index = header_map[column_name] + 1
            if row_number <= len(sheet.get_all_values()):
                sheet.update_cell(row_number, col_index, new_value)
                return True, f"–Ø—á–µ–π–∫–∞ ({row_number}, {column_name}) –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –Ω–∞ '{new_value}'"
            else:
                return False, f"–°—Ç—Ä–æ–∫–∞ {row_number} –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
        else:
            return False, f"–°—Ç–æ–ª–±–µ—Ü '{column_name}' –Ω–µ –Ω–∞–π–¥–µ–Ω"
    except Exception as e:
        return False, f"–û—à–∏–±–∫–∞: {str(e)}"

def edit_admin_in_sheet(sheet, headers, header_map, nickname, field_to_edit, new_value):
    """–†–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞"""
    try:
        all_values = sheet.get_all_values()
        nick_column_index = header_map.get('Nick_Name', 2)
        found_row = None
        
        for i, row in enumerate(all_values):
            if i > 0 and len(row) > nick_column_index:
                if row[nick_column_index].strip() == nickname:
                    found_row = i + 1
                    break
        
        if not found_row:
            return False, f"–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å –Ω–∏–∫–æ–º '{nickname}' –Ω–µ –Ω–∞–π–¥–µ–Ω"
        
        if field_to_edit in header_map:
            col_index = header_map[field_to_edit] + 1
            sheet.update_cell(found_row, col_index, new_value)
            return True, f"–ü–æ–ª–µ '{field_to_edit}' –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ '{nickname}' –æ–±–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞ '{new_value}'"
        else:
            return False, f"–ü–æ–ª–µ '{field_to_edit}' –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ —Ç–∞–±–ª–∏—Ü–µ"
    except Exception as e:
        return False, f"–û—à–∏–±–∫–∞: {str(e)}"

def delete_admin_from_sheet(sheet, headers, header_map, nickname):
    """–£–¥–∞–ª—è–µ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã"""
    try:
        all_values = sheet.get_all_values()
        nick_column_index = header_map.get('Nick_Name', 2)
        found_row = None
        
        for i, row in enumerate(all_values):
            if i > 0 and len(row) > nick_column_index:
                if row[nick_column_index].strip() == nickname:
                    found_row = i + 1
                    break
        
        if not found_row:
            return False, f"–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å –Ω–∏–∫–æ–º '{nickname}' –Ω–µ –Ω–∞–π–¥–µ–Ω"
        
        sheet.delete_rows(found_row)
        return True, f"–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä '{nickname}' —É–¥–∞–ª–µ–Ω –∏–∑ —Ç–∞–±–ª–∏—Ü—ã"
    except Exception as e:
        return False, f"–û—à–∏–±–∫–∞: {str(e)}"

def search_admin_in_sheet(sheet, headers, header_map, search_term):
    """–ò—â–µ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –≤ —Ç–∞–±–ª–∏—Ü–µ"""
    try:
        all_values = sheet.get_all_values()
        search_fields = ['Nick_Name', 'VK', '–î–æ–ª–∂–Ω–æ—Å—Ç—å']
        results = []
        
        for i, row in enumerate(all_values):
            if i == 0:
                continue
            for field in search_fields:
                if field in header_map:
                    col_index = header_map[field]
                    if col_index < len(row):
                        cell_value = row[col_index]
                        if search_term.lower() in cell_value.lower():
                            admin_info = f"–°—Ç—Ä–æ–∫–∞ {i + 1}:\n"
                            if 'Nick_Name' in header_map and header_map['Nick_Name'] < len(row):
                                admin_info += f"–ù–∏–∫: {row[header_map['Nick_Name']]}\n"
                            if '–î–æ–ª–∂–Ω–æ—Å—Ç—å' in header_map and header_map['–î–æ–ª–∂–Ω–æ—Å—Ç—å'] < len(row):
                                admin_info += f"–î–æ–ª–∂–Ω–æ—Å—Ç—å: {row[header_map['–î–æ–ª–∂–Ω–æ—Å—Ç—å']]}\n"
                            if 'VK' in header_map and header_map['VK'] < len(row):
                                admin_info += f"VK: {row[header_map['VK']]}\n"
                            if '–î–∞—Ç–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞ 1' in header_map and header_map['–î–∞—Ç–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞ 1'] < len(row):
                                admin_info += f"–î–∞—Ç–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è: {row[header_map['–î–∞—Ç–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞ 1']]}\n"
                            results.append(admin_info)
                            break
        
        if results:
            return True, "–ù–∞–π–¥–µ–Ω—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã:\n\n" + "\n---\n".join(results[:10])
        else:
            return False, f"–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –ø–æ –∑–∞–ø—Ä–æ—Å—É '{search_term}' –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
    except Exception as e:
        return False, f"–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: {str(e)}"

def get_admin_stats(sheet, headers, header_map):
    """–ü–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º"""
    try:
        all_values = sheet.get_all_values()
        if len(all_values) <= 1:
            return True, "–í —Ç–∞–±–ª–∏—Ü–µ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ–± –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞—Ö"
        
        total_admins = len(all_values) - 1
        positions = {}
        
        if '–î–æ–ª–∂–Ω–æ—Å—Ç—å' in header_map:
            position_index = header_map['–î–æ–ª–∂–Ω–æ—Å—Ç—å']
            for i, row in enumerate(all_values):
                if i > 0 and len(row) > position_index:
                    position = row[position_index].strip()
                    if position:
                        positions[position] = positions.get(position, 0) + 1
        
        stats = f"üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤:\n\n"
        stats += f"–í—Å–µ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤: {total_admins}\n\n"
        
        if positions:
            stats += "–ü–æ –¥–æ–ª–∂–Ω–æ—Å—Ç—è–º:\n"
            for position, count in positions.items():
                stats += f"‚Ä¢ {position}: {count}\n"
        
        return True, stats
    except Exception as e:
        return False, f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: {str(e)}"

def get_table_summary(sheet):
    """–ü–æ–ª—É—á–∞–µ—Ç —Å–≤–æ–¥–∫—É –ø–æ —Ç–∞–±–ª–∏—Ü–µ"""
    try:
        all_values = sheet.get_all_values()
        if len(all_values) <= 1:
            return "–¢–∞–±–ª–∏—Ü–∞ –ø—É—Å—Ç–∞"
        
        total_rows = len(all_values) - 1
        summary = f"üìã –°–≤–æ–¥–∫–∞ –ø–æ —Ç–∞–±–ª–∏—Ü–µ:\n"
        summary += f"–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: {total_rows}\n"
        
        # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 –∑–∞–ø–∏—Å–µ–π
        if total_rows > 0:
            summary += f"\n–ü–æ—Å–ª–µ–¥–Ω–∏–µ {min(5, total_rows)} –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤:\n"
            start_idx = max(1, len(all_values) - 5)
            for i in range(start_idx, len(all_values)):
                row = all_values[i]
                if len(row) > 2:  # –ï—Å—Ç—å —Ö–æ—Ç—è –±—ã –Ω–∏–∫
                    nick = row[2] if len(row) > 2 else "–ù–µ—Ç –Ω–∏–∫–∞"
                    position = row[3] if len(row) > 3 else "–ù–µ—Ç –¥–æ–ª–∂–Ω–æ—Å—Ç–∏"
                    summary += f"{i}. {nick} - {position}\n"
        
        return summary
    except Exception as e:
        return f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–≤–æ–¥–∫–∏: {str(e)}"

def main():
    print("--- –ó–ê–ü–£–°–ö –°–ò–°–¢–ï–ú–´ –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ü–†–ê–í–ê–ú–ò ---")
    print(f"–°—É–ø–µ—Ä–∞–¥–º–∏–Ω—ã: {SUPER_ADMINS}")
    
    load_user_rights()
    print(f"–ó–∞–≥—Ä—É–∂–µ–Ω–æ –ø—Ä–∞–≤ –¥–ª—è {len(user_rights)} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π")
    
    print("\n–¢–µ–∫—É—â–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å –ø—Ä–∞–≤–∞–º–∏:")
    for user_id, rights in user_rights.items():
        role = rights.get('role', 'user')
        is_super = rights.get('is_super', False)
        super_mark = " [–°–£–ü–ï–†]" if is_super else ""
        print(f" ID: {user_id}, –†–æ–ª—å: {role}{super_mark}")
    
    try:
        gc = get_google_client()
        sheet = gc.open(SPREADSHEET_NAME).sheet1
        print(f"\n‚úì –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Ç–∞–±–ª–∏—Ü–µ: {SPREADSHEET_NAME}")
        
        headers = sheet.get_all_values()[0]
        header_map = {header: index for index, header in enumerate(headers)}
        
        print(f"\n–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ {len(headers)} —Å—Ç–æ–ª–±—Ü–æ–≤:")
        for index, header in enumerate(headers):
            print(f"  {index}: '{header}'")
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–≤–æ–¥–∫—É –ø–æ —Ç–∞–±–ª–∏—Ü–µ
        summary = get_table_summary(sheet)
        print(f"\n{summary}")
        
        vk_session = vk_api.VkApi(token=VK_TOKEN)
        vk = vk_session.get_api()
        longpoll = VkLongPoll(vk_session)
        
        print("\n‚úì –ë–æ—Ç –í–ö –∑–∞–ø—É—â–µ–Ω –∏ –∂–¥–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π...")
        
        for event in longpoll.listen():
            if event.type == VkEventType.MESSAGE_NEW:
                user_id = event.user_id
                text = event.text.strip()
                
                if hasattr(event, 'from_chat') and event.from_chat:
                    chat_id = event.chat_id
                    print(f"–ß–∞—Ç {chat_id}: —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç {user_id}: {text}")
                else:
                    print(f"–õ–° –æ—Ç {user_id}: {text}")
                
                # –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
                if text.startswith('/addadmin'):
                    if not has_permission(user_id, 'add_admin'):
                        vk.messages.send(
                            user_id=user_id,
                            message="‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤!",
                            random_id=0
                        )
                        continue
                    
                    parts = text.split()
                    if len(parts) < 5:
                        vk.messages.send(
                            user_id=user_id,
                            message="‚ùå –§–æ—Ä–º–∞—Ç: /addadmin [–ù–∏–∫] [–î–∞—Ç–∞] [–í–ö] [–§–æ—Ä—É–º]\n"
                                    "–ü—Ä–∏–º–µ—Ä: /addadmin Gosha_Parker 01.01.2024 https://vk.com/id123 https://forum.link\n\n"
                                    "–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –î–∞—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –î–î.–ú–ú.–ì–ì–ì–ì",
                            random_id=0
                        )
                        continue
                    
                    nickname = parts[1]
                    date_val = parts[2]
                    vk_link = parts[3]
                    forum_link = parts[4]
                    
                    try:
                        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∞—Ç—É
                        if '.' not in date_val or len(date_val.split('.')) != 3:
                            vk.messages.send(
                                user_id=user_id,
                                message="‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –î–î.–ú–ú.–ì–ì–ì–ì",
                                random_id=0
                            )
                            continue
                        
                        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å —Ç–∞–∫–∏–º –Ω–∏–∫–æ–º
                        all_values = sheet.get_all_values()
                        nick_column_index = header_map.get('Nick_Name', 2)
                        for i, row in enumerate(all_values):
                            if i > 0 and len(row) > nick_column_index:
                                if row[nick_column_index].strip() == nickname:
                                    vk.messages.send(
                                        user_id=user_id,
                                        message=f"‚ùå –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å –Ω–∏–∫–æ–º '{nickname}' —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ —Å—Ç—Ä–æ–∫–µ {i + 1}!",
                                        random_id=0
                                    )
                                    continue
                        
                        success = add_admin_to_sheet(sheet, headers, header_map, nickname, date_val, vk_link, forum_link)
                        
                        if success:
                            vk.messages.send(
                                user_id=user_id,
                                message=f"‚úÖ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä {nickname} —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Ç–∞–±–ª–∏—Ü—É!\n"
                                        f"–î–∞—Ç–∞: {date_val}\n"
                                        f"VK: {vk_link}\n"
                                        f"–§–æ—Ä—É–º: {forum_link}",
                                random_id=0
                            )
                            print(f"–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä {nickname} –¥–æ–±–∞–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º {user_id}")
                        else:
                            vk.messages.send(
                                user_id=user_id,
                                message="‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ —Ç–∞–±–ª–∏—Ü—É.",
                                random_id=0
                            )
                    except Exception as e:
                        vk.messages.send(
                            user_id=user_id,
                            message=f"‚ùå –û—à–∏–±–∫–∞: {str(e)}",
                            random_id=0
                        )
                
                # ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ...
                # –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –≤—ã–¥–∞—á–∏ –ø—Ä–∞–≤
                elif text.startswith('/grant'):
                    if not has_permission(user_id, 'grant_access'):
                        vk.messages.send(
                            user_id=user_id,
                            message="‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –≤—ã–¥–∞—á–∏ –¥–æ—Å—Ç—É–ø–∞!",
                            random_id=0
                        )
                        continue
                    
                    parts = text.split()
                    if len(parts) < 3:
                        vk.messages.send(
                            user_id=user_id,
                            message="‚ùå –§–æ—Ä–º–∞—Ç: /grant [VK_ID] [—Ä–æ–ª—å]\n"
                                    "–†–æ–ª–∏: editor (—Ä–µ–¥–∞–∫—Ç–æ—Ä), admin (–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä)\n"
                                    "–ü—Ä–∏–º–µ—Ä—ã:\n"
                                    "/grant 123456789 editor - –≤—ã–¥–∞—Ç—å –ø—Ä–∞–≤–∞ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞\n"
                                    "/grant 987654321 admin - –≤—ã–¥–∞—Ç—å –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞",
                            random_id=0
                        )
                        continue
                    
                    try:
                        target_user = int(parts[1])
                        role = parts[2].lower()
                        
                        if is_super_admin(target_user):
                            vk.messages.send(
                                user_id=user_id,
                                message="‚ùå –ù–µ–ª—å–∑—è –∏–∑–º–µ–Ω—è—Ç—å –ø—Ä–∞–≤–∞ —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω–∞!",
                                random_id=0
                            )
                            continue
                        
                        if role == 'editor':
                            permissions = ['edit_table']
                            role_name = "—Ä–µ–¥–∞–∫—Ç–æ—Ä"
                        elif role == 'admin':
                            permissions = ['add_admin', 'add_editor', 'edit_table', 'grant_access']
                            role_name = "–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä"
                        else:
                            vk.messages.send(
                                user_id=user_id,
                                message="‚ùå –ù–µ–≤–µ—Ä–Ω–∞—è —Ä–æ–ª—å. –î–æ–ø—É—Å—Ç–∏–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è: editor, admin",
                                random_id=0
                            )
                            continue
                        
                        success, message = add_user_rights(target_user, role, permissions, user_id)
                        
                        if success:
                            try:
                                vk.messages.send(
                                    user_id=target_user,
                                    message=f"üéâ –í–∞–º –±—ã–ª–∏ –≤—ã–¥–∞–Ω—ã –ø—Ä–∞–≤–∞ {role_name}!\n"
                                            f"–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞.",
                                    random_id=0
                                )
                            except:
                                pass
                            
                            vk.messages.send(
                                user_id=user_id,
                                message=f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {target_user} –≤—ã–¥–∞–Ω—ã –ø—Ä–∞–≤–∞ {role_name}!\n"
                                        f"–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è: {', '.join(permissions)}",
                                random_id=0
                            )
                            print(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {target_user} –≤—ã–¥–∞–Ω—ã –ø—Ä–∞–≤–∞ {role_name} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º {user_id}")
                        else:
                            vk.messages.send(
                                user_id=user_id,
                                message=f"‚ùå {message}",
                                random_id=0
                            )
                    except ValueError:
                        vk.messages.send(
                            user_id=user_id,
                            message="‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç VK ID. –î–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º.",
                            random_id=0
                        )
                
                # ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –∫–æ–º–∞–Ω–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ...
                # (—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, —É–¥–∞–ª–µ–Ω–∏–µ, –ø–æ–∏—Å–∫, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ —Ç.–¥.)
                
    except Exception as e:
        print(f"!!! –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: {e}")
        import traceback
        traceback.print_exc()
        time.sleep(5)

if __name__ == '__main__':
    main()
