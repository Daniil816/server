import os
import pickle
import vk_api
import time
import gspread
import json
from vk_api.longpoll import VkLongPoll, VkEventType
from google.auth.transport.requests import Request
from google_auth_oauthlib.flow import InstalledAppFlow

# --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---
VK_TOKEN = 'vk1.a.hnuRWe9zj3RAiXc-2Jhi3ix1wDAYPeA3vv5EuURXKIptRpDR8G948Q891ndVNMuOnz69LxbvAbXQVACkIlLuhQidngypMtSGg4Sv6keay8XH-0WZOs9_L9m4LmXcV3F8pg3dyOTiujoSmzTqi9j2g5j_txPUcKILy_kbavL40GLZ_qLhzbuQjBI_PokDT1cExggdvo2CSgUOsdZBkFayLQ'
SPREADSHEET_NAME = '29 | –†–∞–±–æ—Ç–∞'
RIGHTS_FILE = 'user_rights.json'

# –°–£–ü–ï–†–ê–î–ú–ò–ù–´ - –Ω–µ–ª—å–∑—è –æ—Ç–æ–∑–≤–∞—Ç—å –ø—Ä–∞–≤–∞
SUPER_ADMINS = [807253464, 679050151]

SCOPES = ['https://www.googleapis.com/auth/spreadsheets']

user_rights = {}

def load_user_rights():
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –ø—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ —Ñ–∞–π–ª–∞"""
    global user_rights
    if os.path.exists(RIGHTS_FILE):
        try:
            with open(RIGHTS_FILE, 'r', encoding='utf-8') as f:
                user_rights = json.load(f)
                # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –∫–ª—é—á–∏ –∏–∑ —Å—Ç—Ä–æ–∫ –≤ —á–∏—Å–ª–∞
                user_rights = {int(k): v for k, v in user_rights.items()}
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∞–≤: {e}")
            user_rights = {}
    else:
        user_rights = {}
    
    # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ–º —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω–æ–≤, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç –≤ —Ñ–∞–π–ª–µ
    for super_admin_id in SUPER_ADMINS:
        if super_admin_id not in user_rights:
            user_rights[super_admin_id] = {
                'role': 'super_admin',
                'permissions': ['add_admin', 'add_editor', 'edit_table', 'grant_access', 'revoke_super'],
                'is_super': True,
                'added_by': 'system',
                'added_date': time.strftime("%d.%m.%Y %H:%M:%S")
            }
    
    save_user_rights()
    print(f"–ó–∞–≥—Ä—É–∂–µ–Ω–æ –ø—Ä–∞–≤ –¥–ª—è {len(user_rights)} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π")

def save_user_rights():
    """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ —Ñ–∞–π–ª"""
    try:
        with open(RIGHTS_FILE, 'w', encoding='utf-8') as f:
            json.dump(user_rights, f, ensure_ascii=False, indent=2)
        print("–ü—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã")
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–∞–≤: {e}")

def get_user_role(user_id):
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    if user_id in user_rights:
        return user_rights[user_id].get('role', 'user')
    return 'user'

def is_super_admin(user_id):
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω–æ–º"""
    return user_id in SUPER_ADMINS

def has_permission(user_id, permission):
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –µ—Å—Ç—å –ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ"""
    if user_id in user_rights:
        permissions = user_rights[user_id].get('permissions', [])
        return permission in permissions
    return False

def can_revoke_rights(revoker_id, target_id):
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –º–æ–∂–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–æ–∑–≤–∞—Ç—å –ø—Ä–∞–≤–∞ —É –¥—Ä—É–≥–æ–≥–æ"""
    if is_super_admin(revoker_id):
        return not is_super_admin(target_id)
    
    if has_permission(revoker_id, 'grant_access'):
        return not (is_super_admin(target_id) or has_permission(target_id, 'grant_access'))
    
    return False

def add_user_rights(user_id, role, permissions, added_by):
    """–î–æ–±–∞–≤–ª—è–µ—Ç –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –ø—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    if is_super_admin(user_id):
        return False, "–ù–µ–ª—å–∑—è –∏–∑–º–µ–Ω—è—Ç—å –ø—Ä–∞–≤–∞ —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω–∞!"
    
    user_rights[user_id] = {
        'role': role,
        'permissions': permissions,
        'added_by': added_by,
        'added_date': time.strftime("%d.%m.%Y %H:%M:%S"),
        'is_super': False
    }
    save_user_rights()
    return True, "–ü—Ä–∞–≤–∞ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω—ã"

def remove_user_rights(user_id, remover_id):
    """–£–¥–∞–ª—è–µ—Ç –ø—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    if not can_revoke_rights(remover_id, user_id):
        return False, "–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –æ—Ç–∑—ã–≤–∞ –ø—Ä–∞–≤ —É —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è!"
    
    if user_id in user_rights:
        if user_rights[user_id].get('is_super', False):
            return False, "–ù–µ–ª—å–∑—è —É–¥–∞–ª—è—Ç—å —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω–∞!"
        
        role = user_rights[user_id].get('role', 'user')
        del user_rights[user_id]
        save_user_rights()
        return True, f"–ü—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} ({role}) —É—Å–ø–µ—à–Ω–æ –æ—Ç–æ–∑–≤–∞–Ω—ã!"
    return False, "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω"

def get_google_client():
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ Google Sheets"""
    creds = None
    if os.path.exists('token.pickle'):
        with open('token.pickle', 'rb') as token:
            creds = pickle.load(token)

    if not creds or not creds.valid:
        if creds and creds.expired and creds.refresh_token:
            creds.refresh(Request())
        else:
            flow = InstalledAppFlow.from_client_secrets_file('client_secret.json', SCOPES)
            print("–ù—É–∂–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –¥–æ—Å—Ç—É–ø –≤ –±—Ä–∞—É–∑–µ—Ä–µ...")
            creds = flow.run_local_server(port=8080)
        with open('token.pickle', 'wb') as token:
            pickle.dump(creds, token)

    return gspread.authorize(creds)

def set_cell_value(row_data, header_map, header_name, value, default_index=None):
    """–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –≤ —è—á–µ–π–∫—É –ø–æ –∏–º–µ–Ω–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –∏–ª–∏ –∏–Ω–¥–µ–∫—Å—É"""
    if header_name in header_map:
        col_index = header_map[header_name]
        if col_index < len(row_data):
            row_data[col_index] = value
            return True
    elif default_index is not None and default_index < len(row_data):
        row_data[default_index] = value
        return True
    return False

def get_next_admin_number(sheet):
    """–ü–æ–ª—É—á–∞–µ—Ç —Å–ª–µ–¥—É—é—â–∏–π –Ω–æ–º–µ—Ä –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (—Å—Ç–æ–ª–±–µ—Ü B)"""
    try:
        # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è —Å—Ç–æ–ª–±—Ü–∞ B (–∏–Ω–¥–µ–∫—Å 1)
        all_values = sheet.get_all_values()
        
        # –ò—â–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —á–∏—Å–ª–æ –≤ —Å—Ç–æ–ª–±—Ü–µ B, –Ω–∞—á–∏–Ω–∞—è —Å–æ –≤—Ç–æ—Ä–æ–π —Å—Ç—Ä–æ–∫–∏
        max_number = 0
        for i, row in enumerate(all_values):
            if i == 0:  # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
                continue
            if len(row) > 1 and row[1].strip():  # –°—Ç–æ–ª–±–µ—Ü B (–∏–Ω–¥–µ–∫—Å 1)
                try:
                    num = int(row[1].strip())
                    if num > max_number:
                        max_number = num
                except ValueError:
                    continue
        
        return max_number + 1
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–æ–º–µ—Ä–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞: {e}")
        return 1

def add_admin_to_sheet(sheet, headers, header_map, nickname, date_val, vk_link, forum_link):
    """–î–æ–±–∞–≤–ª—è–µ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –≤ —Ç–∞–±–ª–∏—Ü—É"""
    try:
        # –ü–æ–ª—É—á–∞–µ–º —Å–ª–µ–¥—É—é—â–∏–π –Ω–æ–º–µ—Ä –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
        admin_number = get_next_admin_number(sheet)
        
        row_data = [''] * len(headers)
        
        # –§–æ—Ä–º—É–ª—ã –¥–ª—è —Å—Ç–æ–ª–±—Ü–æ–≤ M –∏ N
        formula_m = '=–ï–°–õ–ò(INDIRECT("B"&ROW())=1;"–ñ–¥—ë—Ç 2 —É—Ä–æ–≤–µ–Ω—å";–ï–°–õ–ò(INDIRECT("B"&ROW())=2;"–ñ–¥—ë—Ç 3 —É—Ä–æ–≤–µ–Ω—å";–ï–°–õ–ò(INDIRECT("B"&ROW())=3;"–ñ–¥—ë—Ç 4 —É—Ä–æ–≤–µ–Ω—å";–ï–°–õ–ò(INDIRECT("B"&ROW())=4;"–ñ–¥—ë—Ç 5 —É—Ä–æ–≤–µ–Ω—å";–ï–°–õ–ò(INDIRECT("B"&ROW())=5;"–°–ø–µ—Ü. –°–ª–µ–¥—è—â–∏–π";"–ù–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–ª —É—Ä–æ–≤–µ–Ω—å")))))'
        formula_n = '=–ï–°–õ–ò(INDIRECT("M"&ROW())="–ñ–¥—ë—Ç 2 —É—Ä–æ–≤–µ–Ω—å";INDIRECT("L"&ROW())+7;–ï–°–õ–ò(INDIRECT("M"&ROW())="–ñ–¥—ë—Ç 3 —É—Ä–æ–≤–µ–Ω—å";INDIRECT("L"&ROW())+31;–ï–°–õ–ò(INDIRECT("M"&ROW())="–ñ–¥—ë—Ç 4 —É—Ä–æ–≤–µ–Ω—å";INDIRECT("L"&ROW())+60;–ï–°–õ–ò(INDIRECT("M"&ROW())="–ñ–¥—ë—Ç 5 —É—Ä–æ–≤–µ–Ω—å";"–ü–æ –¥–æ–≤–µ—Ä–∏—é";–ï–°–õ–ò(INDIRECT("M"&ROW())="–°–ø–µ—Ü. –°–ª–µ–¥—è—â–∏–π";"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ";"–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Å—Ç–∞—Ç—É—Å")))))'
        
        # –°—Ç–æ–ª–±–µ—Ü A - –ø—É—Å—Ç–æ–π (–∏–Ω–¥–µ–∫—Å 0)
        row_data[0] = ""
        
        # –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –∏–Ω–¥–µ–∫—Å–∞–º–∏
        # –°—Ç–æ–ª–±–µ—Ü B (1) - –Ω–æ–º–µ—Ä –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
        set_cell_value(row_data, header_map, '–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç', str(admin_number), 1)
        
        # –°—Ç–æ–ª–±–µ—Ü C (2) - Nick_Name
        set_cell_value(row_data, header_map, 'Nick_Name', nickname, 2)
        
        # –°—Ç–æ–ª–±–µ—Ü D (3) - –î–æ–ª–∂–Ω–æ—Å—Ç—å
        set_cell_value(row_data, header_map, '–î–æ–ª–∂–Ω–æ—Å—Ç—å', '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä', 3)
        
        # –°—Ç–æ–ª–±–µ—Ü E (4) - VK
        set_cell_value(row_data, header_map, 'VK', vk_link, 4)
        
        # –°—Ç–æ–ª–±–µ—Ü F (5) - –°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–æ—Ä—É–º
        forum_cell = f'=HYPERLINK("{forum_link}"; "LINK")'
        set_cell_value(row_data, header_map, '–°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–æ—Ä—É–º', forum_cell, 5)
        
        # –°—Ç–æ–ª–±–µ—Ü G (6) - –î–∞—Ç–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞ 1
        set_cell_value(row_data, header_map, '–î–∞—Ç–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞ 1', date_val, 6)
        
        # –°—Ç–æ–ª–±–µ—Ü L (11) - –î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–æ–≤—ã—à–µ–Ω–∏—è
        set_cell_value(row_data, header_map, '–î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–æ–≤—ã—à–µ–Ω–∏—è', date_val, 11)
        
        # –°—Ç–æ–ª–±–µ—Ü M (12) - –ñ–¥–µ—Ç —É—Ä–æ–≤–µ–Ω—å
        set_cell_value(row_data, header_map, '–ñ–¥–µ—Ç —É—Ä–æ–≤–µ–Ω—å', formula_m, 12)
        
        # –°—Ç–æ–ª–±–µ—Ü N (13) - –î–∞—Ç–∞ –ø–æ–≤—ã—à–µ–Ω–∏—è
        set_cell_value(row_data, header_map, '–î–∞—Ç–∞ –ø–æ–≤—ã—à–µ–Ω–∏—è', formula_n, 13)
        
        # –û—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è
        set_cell_value(row_data, header_map, '–†–∞–∑–æ–≤—ã–µ', "–†–∞–∑–æ–≤—ã–µ [0/3]", 16)
        set_cell_value(row_data, header_map, '–î–ª–∏—Ç–µ–ª—å–Ω—ã–µ', "–î–ª–∏—Ç–µ–ª—å–Ω—ã–µ [0/1]", 17)
        set_cell_value(row_data, header_map, '–ü—è—Ç–∏–¥–µ—Å—è—Ç–∏–ø—Ä–æ—Ü–µ–Ω—Ç–Ω—ã–µ', "–ü—è—Ç–∏–¥–µ—Å—è—Ç–∏–ø—Ä–æ—Ü–µ–Ω—Ç–Ω—ã–π [0/2]", 18)
        set_cell_value(row_data, header_map, '–í—ã–≥–æ–≤–æ—Ä—ã', "–í—ã–≥–æ–≤–æ—Ä—ã [0/3]", 19)
        set_cell_value(row_data, header_map, '–í—ã–≥–æ–≤–æ—Ä—ã –±/—Å', "–ò–∑ –Ω–∏—Ö –≤—ã–≥–æ–≤–æ—Ä—ã –±/—Å [0]", 20)
        set_cell_value(row_data, header_map, '–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è', "–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è [0/3]", 21)
        set_cell_value(row_data, header_map, '–õ–æ–≥–∏ –Ω–æ—Ä–º—ã', "–õ–æ–≥–∏ –Ω–æ—Ä–º—ã [0/3]", 22)
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –≤ —Ç–∞–±–ª–∏—Ü—É
        sheet.append_row(values=row_data, value_input_option='USER_ENTERED')
        
        print(f"–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –¥–æ–±–∞–≤–ª–µ–Ω: –Ω–∏–∫={nickname}, –Ω–æ–º–µ—Ä={admin_number}")
        return True
        
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞: {e}")
        return False

def edit_cell_in_sheet(sheet, row_number, column_name, new_value, header_map):
    """–†–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç —è—á–µ–π–∫—É –≤ —Ç–∞–±–ª–∏—Ü–µ"""
    try:
        if column_name in header_map:
            col_index = header_map[column_name] + 1
            
            if row_number <= len(sheet.get_all_values()):
                sheet.update_cell(row_number, col_index, new_value)
                return True, f"–Ø—á–µ–π–∫–∞ ({row_number}, {column_name}) –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –Ω–∞ '{new_value}'"
            else:
                return False, f"–°—Ç—Ä–æ–∫–∞ {row_number} –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
        else:
            return False, f"–°—Ç–æ–ª–±–µ—Ü '{column_name}' –Ω–µ –Ω–∞–π–¥–µ–Ω"
    except Exception as e:
        return False, f"–û—à–∏–±–∫–∞: {str(e)}"

def edit_admin_in_sheet(sheet, headers, header_map, nickname, field_to_edit, new_value):
    """–†–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞"""
    try:
        all_values = sheet.get_all_values()
        nick_column_index = header_map.get('Nick_Name', 2)
        
        found_row = None
        for i, row in enumerate(all_values):
            if i > 0 and len(row) > nick_column_index:
                if row[nick_column_index].strip() == nickname:
                    found_row = i + 1
                    break
        
        if not found_row:
            return False, f"–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å –Ω–∏–∫–æ–º '{nickname}' –Ω–µ –Ω–∞–π–¥–µ–Ω"
        
        if field_to_edit in header_map:
            col_index = header_map[field_to_edit] + 1
            sheet.update_cell(found_row, col_index, new_value)
            return True, f"–ü–æ–ª–µ '{field_to_edit}' –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ '{nickname}' –æ–±–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞ '{new_value}'"
        else:
            return False, f"–ü–æ–ª–µ '{field_to_edit}' –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ —Ç–∞–±–ª–∏—Ü–µ"
            
    except Exception as e:
        return False, f"–û—à–∏–±–∫–∞: {str(e)}"

def delete_admin_from_sheet(sheet, headers, header_map, nickname):
    """–£–¥–∞–ª—è–µ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã"""
    try:
        all_values = sheet.get_all_values()
        nick_column_index = header_map.get('Nick_Name', 2)
        
        found_row = None
        for i, row in enumerate(all_values):
            if i > 0 and len(row) > nick_column_index:
                if row[nick_column_index].strip() == nickname:
                    found_row = i + 1
                    break
        
        if not found_row:
            return False, f"–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å –Ω–∏–∫–æ–º '{nickname}' –Ω–µ –Ω–∞–π–¥–µ–Ω"
        
        sheet.delete_rows(found_row)
        return True, f"–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä '{nickname}' —É–¥–∞–ª–µ–Ω –∏–∑ —Ç–∞–±–ª–∏—Ü—ã"
            
    except Exception as e:
        return False, f"–û—à–∏–±–∫–∞: {str(e)}"

def search_admin_in_sheet(sheet, headers, header_map, search_term):
    """–ò—â–µ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –≤ —Ç–∞–±–ª–∏—Ü–µ"""
    try:
        all_values = sheet.get_all_values()
        
        search_fields = ['Nick_Name', 'VK', '–î–æ–ª–∂–Ω–æ—Å—Ç—å']
        
        results = []
        for i, row in enumerate(all_values):
            if i == 0:
                continue
            
            for field in search_fields:
                if field in header_map:
                    col_index = header_map[field]
                    if col_index < len(row):
                        cell_value = row[col_index]
                        if search_term.lower() in cell_value.lower():
                            admin_info = f"–°—Ç—Ä–æ–∫–∞ {i+1}:\n"
                            
                            if 'Nick_Name' in header_map and header_map['Nick_Name'] < len(row):
                                admin_info += f"–ù–∏–∫: {row[header_map['Nick_Name']]}\n"
                            if '–î–æ–ª–∂–Ω–æ—Å—Ç—å' in header_map and header_map['–î–æ–ª–∂–Ω–æ—Å—Ç—å'] < len(row):
                                admin_info += f"–î–æ–ª–∂–Ω–æ—Å—Ç—å: {row[header_map['–î–æ–ª–∂–Ω–æ—Å—Ç—å']]}\n"
                            if 'VK' in header_map and header_map['VK'] < len(row):
                                admin_info += f"VK: {row[header_map['VK']]}\n"
                            if '–î–∞—Ç–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞ 1' in header_map and header_map['–î–∞—Ç–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞ 1'] < len(row):
                                admin_info += f"–î–∞—Ç–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è: {row[header_map['–î–∞—Ç–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞ 1']]}\n"
                            
                            results.append(admin_info)
                            break
        
        if results:
            return True, "–ù–∞–π–¥–µ–Ω—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã:\n\n" + "\n---\n".join(results[:10])
        else:
            return False, f"–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –ø–æ –∑–∞–ø—Ä–æ—Å—É '{search_term}' –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
            
    except Exception as e:
        return False, f"–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: {str(e)}"

def get_admin_stats(sheet, headers, header_map):
    """–ü–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º"""
    try:
        all_values = sheet.get_all_values()
        if len(all_values) <= 1:
            return True, "–í —Ç–∞–±–ª–∏—Ü–µ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ–± –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞—Ö"
        
        total_admins = len(all_values) - 1
        
        positions = {}
        if '–î–æ–ª–∂–Ω–æ—Å—Ç—å' in header_map:
            position_index = header_map['–î–æ–ª–∂–Ω–æ—Å—Ç—å']
            for i, row in enumerate(all_values):
                if i > 0 and len(row) > position_index:
                    position = row[position_index].strip()
                    if position:
                        positions[position] = positions.get(position, 0) + 1
        
        stats = f"üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤:\n\n"
        stats += f"–í—Å–µ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤: {total_admins}\n\n"
        
        if positions:
            stats += "–ü–æ –¥–æ–ª–∂–Ω–æ—Å—Ç—è–º:\n"
            for position, count in positions.items():
                stats += f"‚Ä¢ {position}: {count}\n"
        
        return True, stats
            
    except Exception as e:
        return False, f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: {str(e)}"

def get_table_summary(sheet):
    """–ü–æ–ª—É—á–∞–µ—Ç —Å–≤–æ–¥–∫—É –ø–æ —Ç–∞–±–ª–∏—Ü–µ"""
    try:
        all_values = sheet.get_all_values()
        if len(all_values) <= 1:
            return "–¢–∞–±–ª–∏—Ü–∞ –ø—É—Å—Ç–∞"
        
        total_rows = len(all_values) - 1
        
        summary = f"üìã –°–≤–æ–¥–∫–∞ –ø–æ —Ç–∞–±–ª–∏—Ü–µ:\n"
        summary += f"–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: {total_rows}\n"
        
        # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 –∑–∞–ø–∏—Å–µ–π
        if total_rows > 0:
            summary += f"\n–ü–æ—Å–ª–µ–¥–Ω–∏–µ {min(5, total_rows)} –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤:\n"
            start_idx = max(1, len(all_values) - 5)
            for i in range(start_idx, len(all_values)):
                row = all_values[i]
                if len(row) > 2:  # –ï—Å—Ç—å —Ö–æ—Ç—è –±—ã –Ω–∏–∫
                    nick = row[2] if len(row) > 2 else "–ù–µ—Ç –Ω–∏–∫–∞"
                    position = row[3] if len(row) > 3 else "–ù–µ—Ç –¥–æ–ª–∂–Ω–æ—Å—Ç–∏"
                    summary += f"{i}. {nick} - {position}\n"
        
        return summary
        
    except Exception as e:
        return f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–≤–æ–¥–∫–∏: {str(e)}"

def main():
    print("=" * 50)
    print("–ó–ê–ü–£–°–ö –°–ò–°–¢–ï–ú–´ –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–ê–ú–ò")
    print("=" * 50)
    
    # –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    load_user_rights()
    print(f"\n–°—É–ø–µ—Ä–∞–¥–º–∏–Ω—ã: {SUPER_ADMINS}")
    print(f"–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –ø—Ä–∞–≤–∞–º–∏: {len(user_rights)}")

    try:
        print("\n–ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ Google –¢–∞–±–ª–∏—Ü–∞–º...")
        gc = get_google_client()
        if not gc:
            print("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Google –¢–∞–±–ª–∏—Ü–∞–º!")
            print("–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–∞ client_secret.json")
            time.sleep(10)
            return
        
        sheet = gc.open(SPREADSHEET_NAME).sheet1
        print(f"‚úì –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Ç–∞–±–ª–∏—Ü–µ: '{SPREADSHEET_NAME}'")

        # –ü–æ–ª—É—á–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã
        headers = sheet.get_all_values()[0]
        header_map = {header: index for index, header in enumerate(headers)}
        
        print(f"\n–ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(headers)} —Å—Ç–æ–ª–±—Ü–æ–≤:")
        for i, header in enumerate(headers):
            print(f"  {i}: '{header}'")
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–≤–æ–¥–∫—É
        summary = get_table_summary(sheet)
        print(f"\n{summary}")

        # –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ VK
        print("\n–ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ VK API...")
        vk_session = vk_api.VkApi(token=VK_TOKEN)
        vk = vk_session.get_api()
        longpoll = VkLongPoll(vk_session)
        
        print("‚úì –ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω!")
        print("\n" + "=" * 50)
        print("–ë–æ—Ç –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!")
        print("–†–∞–±–æ—Ç–∞–µ—Ç –≤ –ª–∏—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö –∏ —á–∞—Ç–∞—Ö")
        print("–í–≤–µ–¥–∏—Ç–µ /help –¥–ª—è —Å–ø–∏—Å–∫–∞ –∫–æ–º–∞–Ω–¥")
        print("=" * 50 + "\n")

        # –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
        for event in longpoll.listen():
            if event.type == VkEventType.MESSAGE_NEW:
                user_id = event.user_id
                text = event.text.strip()
                
                # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –æ—Ç–∫—É–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ
                if hasattr(event, 'from_chat') and event.from_chat:
                    chat_id = event.chat_id
                    print(f"[–ß–ê–¢ {chat_id}] {user_id}: {text}")
                else:
                    print(f"[–õ–°] {user_id}: {text}")

                # –ö–æ–º–∞–Ω–¥–∞ –ø–æ–º–æ—â–∏
                if text == '/help':
                    help_text = (
                        "üìã –°–ò–°–¢–ï–ú–ê –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–ê–ú–ò\n\n"
                        "–î–ª—è –≤—Å–µ—Ö:\n"
                        "‚Ä¢ /help - —ç—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞\n"
                        "‚Ä¢ /myrights - –º–æ–∏ –ø—Ä–∞–≤–∞\n"
                        "‚Ä¢ /superadmins - —Å–ø–∏—Å–æ–∫ —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω–æ–≤\n\n"
                        
                        "–î–ª—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–æ–≤ –∏ –≤—ã—à–µ:\n"
                        "‚Ä¢ /edit [—Å—Ç—Ä–æ–∫–∞/–Ω–∏–∫] [–ø–æ–ª–µ] [–∑–Ω–∞—á–µ–Ω–∏–µ] - —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å\n"
                        "‚Ä¢ /search [–∑–∞–ø—Ä–æ—Å] - –ø–æ–∏—Å–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞\n"
                        "‚Ä¢ /stats - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞\n"
                        "‚Ä¢ /summary - —Å–≤–æ–¥–∫–∞ –ø–æ —Ç–∞–±–ª–∏—Ü–µ\n\n"
                        
                        "–î–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ –∏ –≤—ã—à–µ:\n"
                        "‚Ä¢ /addadmin [–Ω–∏–∫] [–¥–∞—Ç–∞] [VK] [—Ñ–æ—Ä—É–º] - –¥–æ–±–∞–≤–∏—Ç—å –∞–¥–º–∏–Ω–∞\n"
                        "‚Ä¢ /deleteadmin [–Ω–∏–∫] - —É–¥–∞–ª–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞\n"
                        "‚Ä¢ /grant [VK_ID] [—Ä–æ–ª—å] - –≤—ã–¥–∞—Ç—å –ø—Ä–∞–≤–∞ (editor/admin)\n"
                        "‚Ä¢ /revoke [VK_ID] - –æ—Ç–æ–∑–≤–∞—Ç—å –ø—Ä–∞–≤–∞\n"
                        "‚Ä¢ /listusers - —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –ø—Ä–∞–≤–∞–º–∏\n\n"
                        
                        "üëë –°—É–ø–µ—Ä–∞–¥–º–∏–Ω—ã:\n"
                        f"{', '.join(map(str, SUPER_ADMINS))}\n\n"
                        
                        "–ü—Ä–∏–º–µ—Ä—ã:\n"
                        "‚Ä¢ /addadmin Vasya 01.01.2024 https://vk.com/id1 https://forum.link\n"
                        "‚Ä¢ /grant 123456789 editor\n"
                        "‚Ä¢ /grant 987654321 admin\n"
                        "‚Ä¢ /edit 5 Nick_Name –ù–æ–≤–æ–µ–ò–º—è\n"
                        "‚Ä¢ /edit Vasya –î–æ–ª–∂–Ω–æ—Å—Ç—å –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä\n"
                        "‚Ä¢ /search Vasya\n"
                        "‚Ä¢ /deleteadmin Vasya"
                    )
                    
                    vk.messages.send(
                        user_id=user_id,
                        message=help_text,
                        random_id=0
                    )

                # –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –≤—ã–¥–∞—á–∏ –ø—Ä–∞–≤
                elif text.startswith('/grant'):
                    if not has_permission(user_id, 'grant_access'):
                        vk.messages.send(
                            user_id=user_id,
                            message="‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –≤—ã–¥–∞—á–∏ –¥–æ—Å—Ç—É–ø–∞!",
                            random_id=0
                        )
                        continue
                    
                    parts = text.split()
                    if len(parts) < 3:
                        vk.messages.send(
                            user_id=user_id,
                            message="‚ùå –§–æ—Ä–º–∞—Ç: /grant [VK_ID] [—Ä–æ–ª—å]\n"
                                    "–†–æ–ª–∏: editor (—Ä–µ–¥–∞–∫—Ç–æ—Ä), admin (–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä)\n"
                                    "–ü—Ä–∏–º–µ—Ä—ã:\n"
                                    "/grant 123456789 editor - –≤—ã–¥–∞—Ç—å –ø—Ä–∞–≤–∞ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞\n"
                                    "/grant 987654321 admin - –≤—ã–¥–∞—Ç—å –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞",
                            random_id=0
                        )
                        continue
                    
                    try:
                        target_user = int(parts[1])
                        role = parts[2].lower()
                        
                        if is_super_admin(target_user):
                            vk.messages.send(
                                user_id=user_id,
                                message="‚ùå –ù–µ–ª—å–∑—è –∏–∑–º–µ–Ω—è—Ç—å –ø—Ä–∞–≤–∞ —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω–∞!",
                                random_id=0
                            )
                            continue
                        
                        if role == 'editor':
                            permissions = ['edit_table']
                            role_name = "—Ä–µ–¥–∞–∫—Ç–æ—Ä"
                        elif role == 'admin':
                            permissions = ['add_admin', 'add_editor', 'edit_table', 'grant_access']
                            role_name = "–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä"
                        else:
                            vk.messages.send(
                                user_id=user_id,
                                message="‚ùå –ù–µ–≤–µ—Ä–Ω–∞—è —Ä–æ–ª—å. –î–æ–ø—É—Å—Ç–∏–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è: editor, admin",
                                random_id=0
                            )
                            continue
                        
                        success, message = add_user_rights(target_user, role, permissions, user_id)
                        
                        if success:
                            try:
                                vk.messages.send(
                                    user_id=target_user,
                                    message=f"üéâ –í–∞–º –±—ã–ª–∏ –≤—ã–¥–∞–Ω—ã –ø—Ä–∞–≤–∞ {role_name}!\n"
                                            f"–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞.",
                                    random_id=0
                                )
                            except:
                                pass  # –ù–µ –º–æ–∂–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                            
                            vk.messages.send(
                                user_id=user_id,
                                message=f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {target_user} –≤—ã–¥–∞–Ω—ã –ø—Ä–∞–≤–∞ {role_name}!\n"
                                        f"–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è: {', '.join(permissions)}",
                                random_id=0
                            )
                            print(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {target_user} –≤—ã–¥–∞–Ω—ã –ø—Ä–∞–≤–∞ {role_name}")
                        else:
                            vk.messages.send(
                                user_id=user_id,
                                message=f"‚ùå {message}",
                                random_id=0
                            )
                        
                    except ValueError:
                        vk.messages.send(
                            user_id=user_id,
                            message="‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç VK ID. –î–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º.",
                            random_id=0
                        )

                # –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –æ—Ç–∑—ã–≤–∞ –ø—Ä–∞–≤
                elif text.startswith('/revoke'):
                    if not has_permission(user_id, 'grant_access'):
                        vk.messages.send(
                            user_id=user_id,
                            message="‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –æ—Ç–∑—ã–≤–∞ –¥–æ—Å—Ç—É–ø–∞!",
                            random_id=0
                        )
                        continue
                    
                    parts = text.split()
                    if len(parts) < 2:
                        vk.messages.send(
                            user_id=user_id,
                            message="‚ùå –§–æ—Ä–º–∞—Ç: /revoke [VK_ID]\n"
                                    "–ü—Ä–∏–º–µ—Ä: /revoke 123456789",
                            random_id=0
                        )
                        continue
                    
                    try:
                        target_user = int(parts[1])
                        
                        if target_user not in user_rights:
                            vk.messages.send(
                                user_id=user_id,
                                message=f"‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {target_user} –Ω–µ –∏–º–µ–µ—Ç –ø—Ä–∞–≤.",
                                random_id=0
                            )
                            continue
                        
                        success, message = remove_user_rights(target_user, user_id)
                        
                        vk.messages.send(
                            user_id=user_id,
                            message=f"{'‚úÖ' if success else '‚ùå'} {message}",
                            random_id=0
                        )
                        
                        if success:
                            print(f"–ü—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {target_user} –æ—Ç–æ–∑–≤–∞–Ω—ã")
                        
                    except ValueError:
                        vk.messages.send(
                            user_id=user_id,
                            message="‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç VK ID.",
                            random_id=0
                        )

                # –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
                elif text.startswith('/addadmin'):
                    if not has_permission(user_id, 'add_admin'):
                        vk.messages.send(
                            user_id=user_id,
                            message="‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤!",
                            random_id=0
                        )
                        continue
                    
                    parts = text.split()
                    if len(parts) < 5:
                        vk.messages.send(
                            user_id=user_id,
                            message="‚ùå –§–æ—Ä–º–∞—Ç: /addadmin [–ù–∏–∫] [–î–∞—Ç–∞] [–í–ö] [–§–æ—Ä—É–º]\n"
                                    "–ü—Ä–∏–º–µ—Ä: /addadmin Vasya 01.01.2024 https://vk.com/id123 https://forum.link\n\n"
                                    "–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –î–∞—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –î–î.–ú–ú.–ì–ì–ì–ì",
                            random_id=0
                        )
                        continue

                    nickname = parts[1]
                    date_val = parts[2]
                    vk_link = parts[3]
                    forum_link = parts[4]
                    
                    try:
                        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∞—Ç—É
                        if '.' not in date_val or len(date_val.split('.')) != 3:
                            vk.messages.send(
                                user_id=user_id,
                                message="‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –î–î.–ú–ú.–ì–ì–ì–ì",
                                random_id=0
                            )
                            continue
                        
                        success = add_admin_to_sheet(sheet, headers, header_map, nickname, date_val, vk_link, forum_link)
                        if success:
                            vk.messages.send(
                                user_id=user_id,
                                message=f"‚úÖ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä {nickname} —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Ç–∞–±–ª–∏—Ü—É!\n"
                                        f"–î–∞—Ç–∞: {date_val}\n"
                                        f"VK: {vk_link}\n"
                                        f"–§–æ—Ä—É–º: {forum_link}",
                                random_id=0
                            )
                            print(f"–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä {nickname} –¥–æ–±–∞–≤–ª–µ–Ω")
                        else:
                            vk.messages.send(
                                user_id=user_id,
                                message="‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ —Ç–∞–±–ª–∏—Ü—É.",
                                random_id=0
                            )
                    except Exception as e:
                        vk.messages.send(
                            user_id=user_id,
                            message=f"‚ùå –û—à–∏–±–∫–∞: {str(e)}",
                            random_id=0
                        )

                # –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã
                elif text.startswith('/edit'):
                    if not has_permission(user_id, 'edit_table'):
                        vk.messages.send(
                            user_id=user_id,
                            message="‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã!",
                            random_id=0
                        )
                        continue
                    
                    parts = text.split(maxsplit=3)
                    if len(parts) < 4:
                        vk.messages.send(
                            user_id=user_id,
                            message="‚ùå –§–æ—Ä–º–∞—Ç: /edit [—Å—Ç—Ä–æ–∫–∞] [—Å—Ç–æ–ª–±–µ—Ü] [–Ω–æ–≤–æ–µ_–∑–Ω–∞—á–µ–Ω–∏–µ]\n"
                                    "–ò–ª–∏: /edit [–Ω–∏–∫] [–ø–æ–ª–µ] [–Ω–æ–≤–æ–µ_–∑–Ω–∞—á–µ–Ω–∏–µ] –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ –Ω–∏–∫—É\n"
                                    "–ü—Ä–∏–º–µ—Ä—ã:\n"
                                    "/edit 5 Nick_Name –ù–æ–≤–æ–µ–ò–º—è\n"
                                    "/edit Vasya –î–æ–ª–∂–Ω–æ—Å—Ç—å –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä\n"
                                    "–î–æ—Å—Ç—É–ø–Ω—ã–µ —Å—Ç–æ–ª–±—Ü—ã: Nick_Name, –î–æ–ª–∂–Ω–æ—Å—Ç—å, VK, –°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–æ—Ä—É–º, –î–∞—Ç–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞ 1",
                            random_id=0
                        )
                        continue
                    
                    try:
                        try:
                            row_num = int(parts[1])
                            column_name = parts[2]
                            new_value = parts[3]
                            
                            success, message = edit_cell_in_sheet(sheet, row_num, column_name, new_value, header_map)
                            
                        except ValueError:
                            nickname = parts[1]
                            field_to_edit = parts[2]
                            new_value = parts[3]
                            
                            success, message = edit_admin_in_sheet(sheet, headers, header_map, nickname, field_to_edit, new_value)
                        
                        vk.messages.send(
                            user_id=user_id,
                            message=f"{'‚úÖ' if success else '‚ùå'} {message}",
                            random_id=0
                        )
                        
                    except ValueError:
                        vk.messages.send(
                            user_id=user_id,
                            message="‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç.",
                            random_id=0
                        )
                    except Exception as e:
                        vk.messages.send(
                            user_id=user_id,
                            message=f"‚ùå –û—à–∏–±–∫–∞: {str(e)}",
                            random_id=0
                        )

                # –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
                elif text.startswith('/deleteadmin'):
                    if not has_permission(user_id, 'add_admin'):
                        vk.messages.send(
                            user_id=user_id,
                            message="‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤!",
                            random_id=0
                        )
                        continue
                    
                    parts = text.split()
                    if len(parts) < 2:
                        vk.messages.send(
                            user_id=user_id,
                            message="‚ùå –§–æ—Ä–º–∞—Ç: /deleteadmin [–ù–∏–∫]\n"
                                    "–ü—Ä–∏–º–µ—Ä: /deleteadmin Vasya",
                            random_id=0
                        )
                        continue
                    
                    nickname = parts[1]
                    
                    try:
                        success, message = delete_admin_from_sheet(sheet, headers, header_map, nickname)
                        
                        vk.messages.send(
                            user_id=user_id,
                            message=f"{'‚úÖ' if success else '‚ùå'} {message}",
                            random_id=0
                        )
                        
                    except Exception as e:
                        vk.messages.send(
                            user_id=user_id,
                            message=f"‚ùå –û—à–∏–±–∫–∞: {str(e)}",
                            random_id=0
                        )

                # –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
                elif text.startswith('/search'):
                    if not has_permission(user_id, 'edit_table'):
                        vk.messages.send(
                            user_id=user_id,
                            message="‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –ø–æ–∏—Å–∫–∞!",
                            random_id=0
                        )
                        continue
                    
                    parts = text.split(maxsplit=1)
                    if len(parts) < 2:
                        vk.messages.send(
                            user_id=user_id,
                            message="‚ùå –§–æ—Ä–º–∞—Ç: /search [–∑–∞–ø—Ä–æ—Å]\n"
                                    "–ü—Ä–∏–º–µ—Ä: /search Vasya\n"
                                    "–ò—â–µ—Ç –ø–æ –Ω–∏–∫—É, VK —Å—Å—ã–ª–∫–µ –∏ –¥–æ–ª–∂–Ω–æ—Å—Ç–∏",
                            random_id=0
                        )
                        continue
                    
                    search_term = parts[1]
                    
                    try:
                        success, message = search_admin_in_sheet(sheet, headers, header_map, search_term)
                        
                        vk.messages.send(
                            user_id=user_id,
                            message=message,
                            random_id=0
                        )
                        
                    except Exception as e:
                        vk.messages.send(
                            user_id=user_id,
                            message=f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: {str(e)}",
                            random_id=0
                        )

                # –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
                elif text == '/stats':
                    if not has_permission(user_id, 'edit_table'):
                        vk.messages.send(
                            user_id=user_id,
                            message="‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏!",
                            random_id=0
                        )
                        continue
                    
                    try:
                        success, message = get_admin_stats(sheet, headers, header_map)
                        
                        vk.messages.send(
                            user_id=user_id,
                            message=message,
                            random_id=0
                        )
                        
                    except Exception as e:
                        vk.messages.send(
                            user_id=user_id,
                            message=f"‚ùå –û—à–∏–±–∫–∞: {str(e)}",
                            random_id=0
                        )

                # –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–≤–æ–¥–∫–∏ –ø–æ —Ç–∞–±–ª–∏—Ü–µ
                elif text == '/summary':
                    if not has_permission(user_id, 'edit_table'):
                        vk.messages.send(
                            user_id=user_id,
                            message="‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–≤–æ–¥–∫–∏!",
                            random_id=0
                        )
                        continue
                    
                    try:
                        summary = get_table_summary(sheet)
                        vk.messages.send(
                            user_id=user_id,
                            message=summary,
                            random_id=0
                        )
                        
                    except Exception as e:
                        vk.messages.send(
                            user_id=user_id,
                            message=f"‚ùå –û—à–∏–±–∫–∞: {str(e)}",
                            random_id=0
                        )

                # –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–≤–æ–∏—Ö –ø—Ä–∞–≤
                elif text == '/myrights':
                    role = get_user_role(user_id)
                    is_super = is_super_admin(user_id)
                    
                    if is_super:
                        role_emoji = "üëë –°–£–ü–ï–†–ê–î–ú–ò–ù"
                        permissions_list = "‚Ä¢ –í—Å–µ –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞\n‚Ä¢ –ù–µ–ª—å–∑—è –æ—Ç–æ–∑–≤–∞—Ç—å –ø—Ä–∞–≤–∞\n‚Ä¢ –ú–æ–∂–µ—Ç –æ—Ç–∑—ã–≤–∞—Ç—å –ø—Ä–∞–≤–∞ —É –≤—Å–µ—Ö, –∫—Ä–æ–º–µ —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω–æ–≤"
                    elif role == 'admin':
                        role_emoji = "üëë –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä"
                        permissions_list = "‚Ä¢ –î–æ–±–∞–≤–ª—è—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤\n‚Ä¢ –í—ã–¥–∞–≤–∞—Ç—å –ø—Ä–∞–≤–∞\n‚Ä¢ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É"
                    elif role == 'editor':
                        role_emoji = "‚úèÔ∏è –†–µ–¥–∞–∫—Ç–æ—Ä"
                        permissions_list = "‚Ä¢ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É"
                    else:
                        role_emoji = "üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"
                        permissions_list = "‚Ä¢ –¢–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä –∫–æ–º–∞–Ω–¥"
                    
                    super_status = " (–°–£–ü–ï–†–ê–î–ú–ò–ù)" if is_super else ""
                    
                    vk.messages.send(
                        user_id=user_id,
                        message=f"üìã –í–∞—à–∏ –ø—Ä–∞–≤–∞:\n\n"
                                f"–†–æ–ª—å: {role_emoji}{super_status}\n"
                                f"–í–∞—à ID: {user_id}\n\n"
                                f"–î–æ—Å—Ç—É–ø–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è:\n"
                                f"{permissions_list}",
                        random_id=0
                    )

                # –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –ø—Ä–∞–≤–∞–º–∏
                elif text == '/listusers':
                    if not has_permission(user_id, 'grant_access'):
                        vk.messages.send(
                            user_id=user_id,
                            message="‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π!",
                            random_id=0
                        )
                        continue
                    
                    if not user_rights:
                        message = "üìã –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –ø—Ä–∞–≤–∞–º–∏ –ø—É—Å—Ç."
                    else:
                        message = "üìã –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å –ø—Ä–∞–≤–∞–º–∏:\n\n"
                        for uid, rights in user_rights.items():
                            role = rights.get('role', 'user')
                            added_by = rights.get('added_by', '—Å–∏—Å—Ç–µ–º–∞')
                            added_date = rights.get('added_date', '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')
                            is_super = rights.get('is_super', False)
                            
                            super_mark = "üëë –°–£–ü–ï–†" if is_super else ""
                            admin_mark = "üëë" if role == 'admin' and not is_super else ""
                            editor_mark = "‚úèÔ∏è" if role == 'editor' else ""
                            
                            message += f"{super_mark}{admin_mark}{editor_mark} ID: {uid}\n"
                            message += f"  –†–æ–ª—å: {role}\n"
                            message += f"  –î–æ–±–∞–≤–∏–ª: {added_by}\n"
                            message += f"  –î–∞—Ç–∞: {added_date}\n\n"
                    
                    vk.messages.send(
                        user_id=user_id,
                        message=message,
                        random_id=0
                    )

                # –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω–æ–≤
                elif text == '/superadmins':
                    message = "üëë –°–£–ü–ï–†–ê–î–ú–ò–ù–´ (–Ω–µ–ª—å–∑—è –æ—Ç–æ–∑–≤–∞—Ç—å –ø—Ä–∞–≤–∞):\n\n"
                    for admin_id in SUPER_ADMINS:
                        message += f"‚Ä¢ {admin_id}\n"
                    
                    vk.messages.send(
                        user_id=user_id,
                        message=message,
                        random_id=0
                    )

                elif text.startswith('/'):
                    vk.messages.send(
                        user_id=user_id,
                        message="‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞. –í–≤–µ–¥–∏—Ç–µ /help –¥–ª—è —Å–ø–∏—Å–∫–∞ –∫–æ–º–∞–Ω–¥.",
                        random_id=0
                    )

    except Exception as e:
        print(f"\n‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: {e}")
        import traceback
        traceback.print_exc()
        print("\n–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥...")
        time.sleep(10)

if __name__ == '__main__':
    main()
